<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>iOSé€šè¿‡Containerè¯»å–æ–‡ä»¶é—®é¢˜ç¬”å½•</title>
    <url>/posts/2023/08/13/bb96b1c7/</url>
    <content><![CDATA[<h2 id="ä¸€ã€é—®é¢˜ç°è±¡"><a href="#ä¸€ã€é—®é¢˜ç°è±¡" class="headerlink" title="ä¸€ã€é—®é¢˜ç°è±¡"></a>ä¸€ã€é—®é¢˜ç°è±¡</h2><p>åœ¨ Kotlin Multiplatform é¡¹ç›®ä¸­å®ç° iOS å¹³å°çš„æ–‡ä»¶å­˜å‚¨æ—¶ï¼Œå‡ºç°å¦‚ä¸‹æƒ…å†µï¼š</p>
<ul>
<li><strong>ç°è±¡</strong>ï¼šå¯¼å‡º <code>.xcappdata</code> å¯ä»¥ç¡®è®¤æ–‡ä»¶ç¡®å®åœ¨ Documents ç›®å½•ä¸‹ï¼Œä½†ç”¨ <code>NSData.dataWithContentsOfFile</code> è¯»å–æ—¶å§‹ç»ˆè¿”å›ç©ºã€‚</li>
<li><strong>æŠ¥é”™</strong>ï¼š<code>No such File or Directory</code>ï¼ˆæ‰¾ä¸åˆ°è¯¥æ–‡ä»¶æˆ–ç›®å½•ï¼‰ã€‚</li>
</ul>
<p>å½“æ—¶ä½¿ç”¨çš„è¯»å–ä»£ç å¦‚ä¸‹ï¼ˆä¸ºä¾¿äºæ’æŸ¥ï¼Œå¢åŠ äº† <code>errorPtr</code> è¾“å‡ºé”™è¯¯ä¿¡æ¯ï¼‰ï¼š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">val</span> errorPtr<span class="token operator">:</span> ObjCObjectVar<span class="token operator">&lt;</span>NSError<span class="token operator">?</span><span class="token operator">&gt;</span> <span class="token operator">=</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
NSData<span class="token punctuation">.</span><span class="token function">dataWithContentsOfFile</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> error <span class="token operator">=</span> errorPtr<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> bytes <span class="token operator">-&gt;</span>
    <span class="token keyword">val</span> array <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>length<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    bytes<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">refTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token label symbol">@withContext</span> array
<span class="token punctuation">}</span>
<span class="token function">println</span><span class="token punctuation">(</span>errorPtr<span class="token punctuation">.</span>value<span class="token operator">?</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span><span class="token function">orEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">return</span><span class="token label symbol">@withContext</span> <span class="token keyword">null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<span id="more"></span>

<h2 id="äºŒã€é—®é¢˜å®šä½"><a href="#äºŒã€é—®é¢˜å®šä½" class="headerlink" title="äºŒã€é—®é¢˜å®šä½"></a>äºŒã€é—®é¢˜å®šä½</h2><h3 id="2-1-æ€€ç–‘ç‚¹ï¼šè·¯å¾„å¯èƒ½ä¸å¯¹"><a href="#2-1-æ€€ç–‘ç‚¹ï¼šè·¯å¾„å¯èƒ½ä¸å¯¹" class="headerlink" title="2.1 æ€€ç–‘ç‚¹ï¼šè·¯å¾„å¯èƒ½ä¸å¯¹"></a>2.1 æ€€ç–‘ç‚¹ï¼šè·¯å¾„å¯èƒ½ä¸å¯¹</h3><p>ä»é”™è¯¯æ—¥å¿—çœ‹ï¼Œä¼ å…¥çš„ <code>fullPath</code> å¾ˆå¯èƒ½å¹¶ä¸æ˜¯å½“å‰è¿è¡Œæ—¶çš„çœŸå®è·¯å¾„ï¼Œæ‰€ä»¥å³ä½¿æ–‡ä»¶å®é™…å­˜åœ¨ï¼Œ<code>NSData.dataWithContentsOfFile</code> ä»ç„¶æ‰¾ä¸åˆ°ã€‚</p>
<h3 id="2-2-å¯¹æ¯”éªŒè¯ï¼šApplication-ç›®å½•çš„-UUID-ä¸ä¸€è‡´"><a href="#2-2-å¯¹æ¯”éªŒè¯ï¼šApplication-ç›®å½•çš„-UUID-ä¸ä¸€è‡´" class="headerlink" title="2.2 å¯¹æ¯”éªŒè¯ï¼šApplication ç›®å½•çš„ UUID ä¸ä¸€è‡´"></a>2.2 å¯¹æ¯”éªŒè¯ï¼šApplication ç›®å½•çš„ UUID ä¸ä¸€è‡´</h3><p>ç”¨ Swift åœ¨è¿è¡Œæ—¶è·å– Documents ç›®å½•å¹¶åˆ—å‡ºæ–‡ä»¶ï¼Œä¸ Kotlin é‡Œä½¿ç”¨çš„ <code>fullPath</code> å¯¹æ¯”ï¼š</p>
<ul>
<li><strong>Kotlin ä¸­ä½¿ç”¨çš„ fullPath</strong>ï¼ˆå¯èƒ½æ˜¯ä¹‹å‰ä¿å­˜çš„å®Œæ•´è·¯å¾„ï¼‰ï¼š<pre class="line-numbers language-none"><code class="language-none">/var/mobile/Containers/Data/Application/3FC1CCE9-A788-47AB-902A-FA133FAA3D30/Documents/60F570BE-2A16-4EFB-96B3-9203C0A0ABCE.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><strong>Swift å½“å‰æ‹¿åˆ°çš„æ–‡ä»¶ URL</strong>ï¼š<pre class="line-numbers language-none"><code class="language-none">file:///private/var/mobile/Containers/Data/Application/C5AC5178-6887-40F4-9EE5-8D56CB830CB3/Documents/60F570BE-2A16-4EFB-96B3-9203C0A0ABCE.jpg<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
</ul>
<p>å¯è§ï¼Œ<code>Application</code> åé¢é‚£ä¸€æ®µ UUID ä¸ä¸€è‡´ï¼šä¸€ä¸ªæ˜¯ <code>3FC1CCE9-...</code>ï¼Œä¸€ä¸ªæ˜¯ <code>C5AC5178-...</code>ã€‚</p>
<p>Swift ä¾§è·å– Documents çš„ç¤ºä¾‹ä»£ç ï¼š</p>
<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">let</span> fileManager <span class="token operator">=</span> <span class="token class-name">FileManager</span><span class="token punctuation">.</span><span class="token keyword">default</span>
<span class="token keyword">let</span> documentsURL <span class="token operator">=</span> fileManager<span class="token punctuation">.</span><span class="token function">urls</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>documentDirectory<span class="token punctuation">,</span> <span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>userDomainMask<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> fileURLs <span class="token operator">=</span> <span class="token keyword">try</span> fileManager<span class="token punctuation">.</span><span class="token function">contentsOfDirectory</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> documentsURL<span class="token punctuation">,</span> includingPropertiesForKeys<span class="token punctuation">:</span> <span class="token nil constant">nil</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>fileURLs<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">{</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string-literal"><span class="token string">"Error while enumerating files </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">documentsURL<span class="token punctuation">.</span>path</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">: </span><span class="token interpolation-punctuation punctuation">\(</span><span class="token interpolation">error<span class="token punctuation">.</span>localizedDescription</span><span class="token interpolation-punctuation punctuation">)</span><span class="token string">"</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="2-3-æ ¹å› ç»“è®º"><a href="#2-3-æ ¹å› ç»“è®º" class="headerlink" title="2.3 æ ¹å› ç»“è®º"></a>2.3 æ ¹å› ç»“è®º</h3><p>è‡ª <strong>iOS 8.0</strong> èµ·ï¼Œåº”ç”¨æ²™ç›’é‡Œ <code>Application</code> è¿™ä¸€çº§ç›®å½•çš„ <strong>UUID ä¼šéšå®‰è£…/éƒ¨ç½²æ–¹å¼å˜åŒ–</strong>ï¼ˆä¾‹å¦‚å¸è½½é‡è£…ã€Xcode é‡æ–°å®‰è£…ç­‰ï¼‰ã€‚è‹¥æŠŠã€Œå®Œæ•´è·¯å¾„ã€å­˜ä¸‹æ¥ï¼Œä¸‹æ¬¡å¯åŠ¨æˆ–é‡è£…å UUID å˜äº†ï¼Œæ—§è·¯å¾„å°±å¤±æ•ˆï¼Œå¯¼è‡´ã€Œæ–‡ä»¶åœ¨ï¼Œä½†æŒ‰æ—§è·¯å¾„è¯»ä¸åˆ°ã€ã€‚</p>
<p>å› æ­¤ï¼š<strong>ä¸èƒ½ä¾èµ–å­˜å‚¨çš„å®Œæ•´è·¯å¾„æ¥è¯»æ–‡ä»¶ï¼Œåªèƒ½ä¾èµ–ã€Œç›¸å¯¹ä½ç½® + æ–‡ä»¶åã€å¹¶åœ¨è¿è¡Œæ—¶é‡æ–°è§£æã€‚</strong></p>
<h2 id="ä¸‰ã€è§£å†³æ–¹æ¡ˆ"><a href="#ä¸‰ã€è§£å†³æ–¹æ¡ˆ" class="headerlink" title="ä¸‰ã€è§£å†³æ–¹æ¡ˆ"></a>ä¸‰ã€è§£å†³æ–¹æ¡ˆ</h2><p>æ€è·¯ç»Ÿä¸€ä¸ºï¼š<strong>åªå­˜æ–‡ä»¶åï¼ˆæˆ–ç›¸å¯¹è·¯å¾„ï¼‰ï¼Œè¯»çš„æ—¶å€™å…ˆæ‹¿åˆ°å½“å‰ Documents ç›®å½•ï¼Œå†æ‹¼å‡ºå®Œæ•´è·¯å¾„æˆ– URLã€‚</strong> ä¸‹é¢ä¸¤ç§å†™æ³•éƒ½ç¬¦åˆè¿™ä¸€æ€è·¯ã€‚</p>
<h3 id="æ–¹æ³•ä¸€ï¼šéå†-Documentsï¼ŒæŒ‰æ–‡ä»¶ååŒ¹é…"><a href="#æ–¹æ³•ä¸€ï¼šéå†-Documentsï¼ŒæŒ‰æ–‡ä»¶ååŒ¹é…" class="headerlink" title="æ–¹æ³•ä¸€ï¼šéå† Documentsï¼ŒæŒ‰æ–‡ä»¶ååŒ¹é…"></a>æ–¹æ³•ä¸€ï¼šéå† Documentsï¼ŒæŒ‰æ–‡ä»¶ååŒ¹é…</h3><p>ä¸ä¾èµ–å®Œæ•´è·¯å¾„ï¼Œå…ˆå–åˆ° Documents çš„ URLï¼Œå†åœ¨ç›®å½•ä¸‹æŒ‰æ–‡ä»¶åæ‰¾åˆ°å¯¹åº”æ–‡ä»¶ï¼š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// æ‹¿åˆ° Documents ç›®å½•çš„ url</span>
<span class="token keyword">val</span> url <span class="token operator">=</span> fileManager<span class="token punctuation">.</span><span class="token function">URLForDirectory</span><span class="token punctuation">(</span>
    directory <span class="token operator">=</span> NSDocumentDirectory<span class="token punctuation">,</span>
    inDomain <span class="token operator">=</span> NSUserDomainMask<span class="token punctuation">,</span>
    appropriateForURL <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
    create <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    error <span class="token operator">=</span> <span class="token keyword">null</span>
<span class="token punctuation">)</span><span class="token operator">!!</span>
<span class="token comment">// åˆ—å‡ºç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„ url</span>
<span class="token keyword">val</span> fileUrls <span class="token operator">=</span> fileManager<span class="token punctuation">.</span><span class="token function">contentsOfDirectoryAtURL</span><span class="token punctuation">(</span>url <span class="token operator">=</span> url<span class="token punctuation">,</span> includingPropertiesForKeys <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> error <span class="token operator">=</span> errorPtr<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span>
<span class="token comment">// æŒ‰æ–‡ä»¶ååŒ¹é…å¾—åˆ°ç›®æ ‡æ–‡ä»¶çš„ url</span>
<span class="token keyword">val</span> currentFileUrl <span class="token operator">=</span> fileUrls<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">first</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span> <span class="token punctuation">}</span> <span class="token keyword">as</span><span class="token operator">?</span> NSURL
<span class="token comment">// ç”¨ URL è¯»å–</span>
currentFileUrl<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span>
    NSData<span class="token punctuation">.</span><span class="token function">dataWithContentsOfURL</span><span class="token punctuation">(</span>currentFileUrl<span class="token punctuation">)</span>
        <span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">{</span> bytes <span class="token operator">-&gt;</span>
            <span class="token keyword">val</span> array <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>length<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            bytes<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">refTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
            <span class="token keyword">return</span><span class="token label symbol">@withContext</span> array
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="æ–¹æ³•äºŒï¼ˆæ¨èï¼‰ï¼šç›´æ¥å–-Documents-è·¯å¾„å†æ‹¼æ¥æ–‡ä»¶å"><a href="#æ–¹æ³•äºŒï¼ˆæ¨èï¼‰ï¼šç›´æ¥å–-Documents-è·¯å¾„å†æ‹¼æ¥æ–‡ä»¶å" class="headerlink" title="æ–¹æ³•äºŒï¼ˆæ¨èï¼‰ï¼šç›´æ¥å– Documents è·¯å¾„å†æ‹¼æ¥æ–‡ä»¶å"></a>æ–¹æ³•äºŒï¼ˆæ¨èï¼‰ï¼šç›´æ¥å– Documents è·¯å¾„å†æ‹¼æ¥æ–‡ä»¶å</h3><p>éå†æœ‰é¢å¤–å¼€é”€ï¼Œæ›´ç¨³å¦¥ä¸”é«˜æ•ˆçš„æ–¹å¼æ˜¯ï¼š<strong>æ¯æ¬¡è¯»å–æ—¶ç”¨ç³»ç»Ÿ API å–å½“å‰ Documents ç›®å½•ï¼Œå†æ‹¼æ¥æ–‡ä»¶å</strong>ï¼š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">val</span> documentDirectory <span class="token operator">=</span> <span class="token function">NSSearchPathForDirectoriesInDomains</span><span class="token punctuation">(</span>
    directory <span class="token operator">=</span> NSDocumentDirectory<span class="token punctuation">,</span>
    domainMask <span class="token operator">=</span> NSUserDomainMask<span class="token punctuation">,</span>
    expandTilde <span class="token operator">=</span> <span class="token boolean">true</span>
<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> NSString
<span class="token keyword">val</span> fullPath <span class="token operator">=</span> documentDirectory<span class="token punctuation">.</span><span class="token function">stringByAppendingPathComponent</span><span class="token punctuation">(</span>fileName<span class="token punctuation">)</span>
<span class="token comment">// æ­¤å¤„ fullPath ä¸€å®šæ˜¯å½“å‰åº”ç”¨å®ä¾‹çš„çœŸå®è·¯å¾„</span>
NSData<span class="token punctuation">.</span><span class="token function">dataWithContentsOfFile</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> <span class="token operator">..</span><span class="token punctuation">.</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>è¿™æ ·å¾—åˆ°çš„ <code>fullPath</code> å§‹ç»ˆå¯¹åº”å½“å‰è¿è¡Œæ—¶çš„ Documentsï¼Œä¸å— UUID å˜åŒ–å½±å“ã€‚</p>
<h2 id="å››ã€æ€»ç»“"><a href="#å››ã€æ€»ç»“" class="headerlink" title="å››ã€æ€»ç»“"></a>å››ã€æ€»ç»“</h2><table>
<thead>
<tr>
<th>è¦ç‚¹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>ä¸è¦å­˜å®Œæ•´è·¯å¾„</td>
<td>iOS 8+ ä¸‹ Application ç›®å½• UUID ä¼šå˜ï¼Œå­˜å®Œæ•´è·¯å¾„å®¹æ˜“å¤±æ•ˆã€‚</td>
</tr>
<tr>
<td>æ¨èåªå­˜æ–‡ä»¶å</td>
<td>ä½¿ç”¨æ—¶é€šè¿‡ API è·å–å½“å‰ Documents ç›®å½•ï¼Œå†æ‹¼æ¥æ–‡ä»¶åã€‚</td>
</tr>
<tr>
<td>ä¼˜å…ˆç”¨ç³»ç»Ÿ API å–ç›®å½•</td>
<td>ä½¿ç”¨ <code>NSSearchPathForDirectoriesInDomains</code> è·å– Documentsï¼Œæ¯”éå†ç›®å½•æ›´ç®€å•ã€é«˜æ•ˆã€‚</td>
</tr>
</tbody></table>
<p>æŒ‰ä¸Šè¿°æ–¹å¼æ”¹é€ åï¼Œ<code>NSData.dataWithContentsOfFile</code> æ— æ³•è¯»å–æ–‡ä»¶çš„é—®é¢˜å³å¯è§£å†³ã€‚</p>
<h2 id="é™„å½•ï¼šUUID-ä½•æ—¶ä¼šå˜åŒ–"><a href="#é™„å½•ï¼šUUID-ä½•æ—¶ä¼šå˜åŒ–" class="headerlink" title="é™„å½•ï¼šUUID ä½•æ—¶ä¼šå˜åŒ–"></a>é™„å½•ï¼šUUID ä½•æ—¶ä¼šå˜åŒ–</h2><p>ä¸åŒå®‰è£…/è¿è¡Œæ–¹å¼ä¸‹ï¼Œæ²™ç›’ä¸­ Application ç›®å½•çš„ UUID æ˜¯å¦å˜åŒ–å¯å‚è€ƒä¸‹è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th>å®‰è£…/è¿è¡Œæ–¹å¼</th>
<th>UUID æ˜¯å¦å˜åŒ–</th>
</tr>
</thead>
<tbody><tr>
<td>App å¸è½½åé‡æ–°å®‰è£…</td>
<td>âœ… å˜åŒ–ï¼ˆiOS 8+ çš„å®‰å…¨æœºåˆ¶ï¼‰</td>
</tr>
<tr>
<td>é€šè¿‡ Xcode é‡æ–°å®‰è£…</td>
<td>âœ… å˜åŒ–ï¼ˆç›¸å½“äºå¸è½½å†å®‰è£…ï¼‰</td>
</tr>
<tr>
<td>Xcode ç›´æ¥è¿è¡Œï¼ˆä¸å¸è½½ï¼‰</td>
<td>âŒ ä¸å˜ï¼ˆä»… Build &amp; Run ä¸”æœªåˆ é™¤ Appï¼‰</td>
</tr>
<tr>
<td>æ¨¡æ‹Ÿå™¨ä¸Šè¿è¡Œ</td>
<td>âœ… å¯èƒ½å˜åŒ–ï¼ˆè§†æƒ…å†µè€Œå®šï¼‰</td>
</tr>
<tr>
<td>TestFlight / App Store å®‰è£…</td>
<td>âœ… å˜åŒ–ï¼ˆå®‰è£…æ—¶ç”Ÿæˆæ–° UUIDï¼‰</td>
</tr>
<tr>
<td>iOS OTA æ›´æ–° App</td>
<td>âŒ ä¸å˜ï¼ˆæ›´æ–°ä¸æ”¹å˜ UUIDï¼‰</td>
</tr>
</tbody></table>
]]></content>
      <categories>
        <category>Multiplatform</category>
      </categories>
      <tags>
        <tag>SwiftUI</tag>
        <tag>Kotlin Native</tag>
      </tags>
  </entry>
  <entry>
    <title>remember VS rememberSaveable</title>
    <url>/posts/2023/12/04/f68195/</url>
    <content><![CDATA[<h2 id="å¼•è¨€"><a href="#å¼•è¨€" class="headerlink" title="å¼•è¨€"></a>å¼•è¨€</h2><p>åœ¨ Jetpack Compose ä¸­ï¼Œæˆ‘ä»¬å¸¸éœ€è¦ã€Œè®°ä½ã€æŸä¸ªè®¡ç®—ç»“æœï¼Œé¿å…åœ¨é‡ç»„æ—¶é‡å¤è®¡ç®—ä»¥æå‡æ€§èƒ½ã€‚Compose æä¾›äº†ä¸¤ç§å¸¸ç”¨æ–¹å¼ï¼š<code>remember {}</code> å’Œ <code>rememberSaveable {}</code>ã€‚äºŒè€…éƒ½èƒ½åœ¨é‡ç»„æ—¶å¤ç”¨å€¼ï¼Œä½†<strong>æŒä¹…åŒ–èŒƒå›´ä¸åŒ</strong>ï¼Œé€‰é”™ä¼šå¯¼è‡´çŠ¶æ€åœ¨ç‰¹å®šåœºæ™¯ä¸‹è¢«é‡ç½®ã€‚æœ¬æ–‡ç»“åˆä¸€æ¬¡å®é™…é—®é¢˜å’Œæ–‡æ¡£/å®éªŒï¼Œè¯´æ˜ä¸¤è€…çš„åŒºåˆ«ä¸ä½¿ç”¨åœºæ™¯ã€‚</p>
<h2 id="ä¸€ã€é—®é¢˜ç°è±¡"><a href="#ä¸€ã€é—®é¢˜ç°è±¡" class="headerlink" title="ä¸€ã€é—®é¢˜ç°è±¡"></a>ä¸€ã€é—®é¢˜ç°è±¡</h2><p>é¡µé¢ä¸­æœ‰ä¸¤ä¸ªä¸»è¦éƒ¨åˆ†ï¼š<strong>Dashboard</strong>ï¼ˆæ ¹æ®æ»šåŠ¨åšç¼©æ”¾åŠ¨ç”»ï¼‰å’Œ <strong>Asset List</strong>ï¼ˆå¯æ»šåŠ¨åˆ—è¡¨ï¼‰ã€‚ç”¨ <code>remember {}</code> ä¿å­˜ scale çŠ¶æ€æ—¶ï¼š</p>
<ul>
<li><strong>å¿«é€Ÿåˆ‡æ¢ Tab</strong>ï¼šè¡¨ç°æ­£å¸¸ï¼Œscale ä¿æŒã€‚</li>
<li><strong>åœ¨å…¶ä»– Tab åœç•™ä¸€æ®µæ—¶é—´å†åˆ‡å›</strong>ï¼šscale è¢«é‡ç½®ï¼ŒDashboard çªç„¶æ”¾å¤§ã€‚</li>
</ul>
<p><img src="/img/20231204/remember.gif" alt="Recording" title="remember"></p>
<p>æ”¹ä¸º <code>rememberSaveable {}</code> åï¼Œæ— è®ºå¦‚ä½•åˆ‡æ¢ Tabï¼Œè¿”å›æ—¶ Dashboard éƒ½èƒ½ä¿æŒä¹‹å‰çš„ scaleï¼Œç¬¦åˆé¢„æœŸã€‚</p>
<h3 id="ç›¸å…³ä»£ç ç‰‡æ®µ"><a href="#ç›¸å…³ä»£ç ç‰‡æ®µ" class="headerlink" title="ç›¸å…³ä»£ç ç‰‡æ®µ"></a>ç›¸å…³ä»£ç ç‰‡æ®µ</h3><pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// ä½¿ç”¨ rememberSaveable ä¿æŒ scaleï¼Œé¿å…ç¦»å¼€å±å¹•åå†è¿›å…¥æ—¶è¢«é‡ç½®</span>
<span class="token keyword">var</span> scale <span class="token keyword">by</span> rememberSaveable <span class="token punctuation">{</span>
    <span class="token function">mutableFloatStateOf</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">val</span> nestedScrollConnection <span class="token operator">=</span> remember <span class="token punctuation">{</span> <span class="token operator">..</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
<span class="token function">Box</span><span class="token punctuation">(</span>modifier <span class="token operator">=</span> modifier<span class="token punctuation">.</span><span class="token function">nestedScroll</span><span class="token punctuation">(</span>nestedScrollConnection<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">DashboardView</span><span class="token punctuation">(</span>
        modifier <span class="token operator">=</span> Modifier
            <span class="token punctuation">.</span><span class="token function">fillMaxWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">scale</span><span class="token punctuation">(</span>scale<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">graphicsLayer</span> <span class="token punctuation">{</span> translationY <span class="token operator">=</span> toolbarHeightRange<span class="token punctuation">.</span>last <span class="token operator">*</span> <span class="token punctuation">(</span>scale <span class="token operator">-</span> <span class="token number">1.0f</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
        onEvent <span class="token operator">=</span> onEvent
    <span class="token punctuation">)</span>
    <span class="token function">LazyColumn</span><span class="token punctuation">(</span>
        modifier <span class="token operator">=</span> Modifier
            <span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">graphicsLayer</span> <span class="token punctuation">{</span> translationY <span class="token operator">=</span> toolbarState<span class="token punctuation">.</span>height <span class="token operator">+</span> toolbarState<span class="token punctuation">.</span>offset <span class="token punctuation">}</span>
            <span class="token punctuation">.</span><span class="token function">background</span><span class="token punctuation">(</span>MaterialTheme<span class="token punctuation">.</span>colorScheme<span class="token punctuation">.</span>background<span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">shadow</span><span class="token punctuation">(</span>elevation <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">.</span>dp<span class="token punctuation">,</span> shape <span class="token operator">=</span> <span class="token function">RoundedCornerShape</span><span class="token punctuation">(</span>topEnd <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">.</span>dp<span class="token punctuation">,</span> topStart <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">pointerInput</span><span class="token punctuation">(</span>Unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">detectTapGestures</span><span class="token punctuation">(</span>onPress <span class="token operator">=</span> <span class="token punctuation">{</span> scope<span class="token punctuation">.</span>coroutineContext<span class="token punctuation">.</span><span class="token function">cancelChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        verticalArrangement <span class="token operator">=</span> Arrangement<span class="token punctuation">.</span><span class="token function">spacedBy</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span><span class="token punctuation">,</span>
        state <span class="token operator">=</span> listState
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">items</span><span class="token punctuation">(</span>uiState<span class="token punctuation">.</span>tokens<span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">{</span> it<span class="token punctuation">.</span>token<span class="token punctuation">.</span>id <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">TokenItemView</span><span class="token punctuation">(</span>extraToken <span class="token operator">=</span> it<span class="token punctuation">,</span> onEvent <span class="token operator">=</span> onEvent<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="äºŒã€åŸç†è§£æ"><a href="#äºŒã€åŸç†è§£æ" class="headerlink" title="äºŒã€åŸç†è§£æ"></a>äºŒã€åŸç†è§£æ</h2><h3 id="2-1-å¯ç»„åˆé¡¹çš„ç”Ÿå‘½å‘¨æœŸ"><a href="#2-1-å¯ç»„åˆé¡¹çš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2.1 å¯ç»„åˆé¡¹çš„ç”Ÿå‘½å‘¨æœŸ"></a>2.1 å¯ç»„åˆé¡¹çš„ç”Ÿå‘½å‘¨æœŸ</h3><p>æ ¹æ®å®˜æ–¹æ–‡æ¡£ <a href="https://developer.android.com/jetpack/compose/lifecycle">Lifecycle of composables</a>ï¼Œå¯ç»„åˆé¡¹çš„ç”Ÿå‘½å‘¨æœŸå¯åˆ†ä¸ºä¸‰é˜¶æ®µï¼š</p>
<ul>
<li><strong>è¿›å…¥ç»„åˆï¼ˆEnter Compositionï¼‰</strong></li>
<li><strong>é‡ç»„ï¼ˆRecompositionï¼‰</strong></li>
<li><strong>é€€å‡ºç»„åˆï¼ˆExit Compositionï¼‰</strong></li>
</ul>
<p>ç¦»å¼€å½“å‰é¡µé¢ï¼ˆå¦‚åˆ‡æ¢ Tabï¼‰æ—¶ï¼Œè¯¥é¡µé¢çš„å¯ç»„åˆé¡¹ä¼š<strong>é€€å‡ºç»„åˆ</strong>ï¼›å†æ¬¡è¿›å…¥æ—¶åˆ™ä¼š<strong>é‡æ–°è¿›å…¥ç»„åˆ</strong>ï¼Œç›¸å½“äºæ–°ä¸€è½®ç”Ÿå‘½å‘¨æœŸã€‚</p>
<h3 id="2-2-remember"><a href="#2-2-remember" class="headerlink" title="2.2 remember {}"></a>2.2 remember {}</h3><p>å¯¹ <code>remember {}</code> çš„æ–‡æ¡£è¯´æ˜å¤§è‡´å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>Remember the value produced by calculation. calculation will only be evaluated during the composition. Recomposition will always return the value produced by composition.<br>å³ï¼šå€¼åœ¨<strong>è¿›å…¥ç»„åˆæ—¶</strong>ç”± block è®¡ç®—å¾—åˆ°ï¼Œ<strong>é‡ç»„æ—¶</strong>ç›´æ¥è¿”å›è¯¥å€¼ï¼Œä¸ä¼šé‡æ–°è®¡ç®—ã€‚</p>
</blockquote>
<p>å› æ­¤ï¼š</p>
<ul>
<li><strong>åˆæ¬¡è¿›å…¥ç»„åˆ</strong>ï¼šæ‰§è¡Œ blockï¼Œè®¡ç®—å¹¶ä¿å­˜å€¼ã€‚</li>
<li><strong>é‡ç»„</strong>ï¼šç›´æ¥è¿”å›å·²ä¿å­˜çš„å€¼ï¼Œä¸æ‰§è¡Œ blockã€‚</li>
<li><strong>é€€å‡ºç»„åˆåå†æ¬¡è¿›å…¥</strong>ï¼šè§†ä¸ºæ–°çš„ç»„åˆï¼Œblock <strong>ä¼šå†æ¬¡æ‰§è¡Œ</strong>ï¼ŒçŠ¶æ€ä¼šè¢«é‡æ–°åˆå§‹åŒ–ã€‚</li>
</ul>
<p>è¿™å°±æ˜¯ã€Œåœ¨å…¶ä»– Tab åœç•™ä¸€æ®µæ—¶é—´å†åˆ‡å›ã€æ—¶ scale è¢«é‡ç½®çš„åŸå› ï¼šé¡µé¢å…ˆé€€å‡ºç»„åˆï¼Œå†è¿›å…¥æ—¶ <code>remember { mutableFloatStateOf(1.0f) }</code> é‡æ–°æ‰§è¡Œï¼Œscale åˆå˜å› 1.0ã€‚è‹¥åˆ‡æ¢å¾ˆå¿«ï¼Œç»„åˆå°šæœªè¢«å›æ”¶ï¼Œå°±ä¸ä¼šè§¦å‘é‡æ–°è®¡ç®—ï¼Œçœ‹èµ·æ¥å°±ã€Œæ­£å¸¸ã€ã€‚</p>
<h3 id="2-3-rememberSaveable"><a href="#2-3-rememberSaveable" class="headerlink" title="2.3 rememberSaveable {}"></a>2.3 rememberSaveable {}</h3><p>å®˜æ–¹å¯¹ <a href="https://developer.android.com/reference/kotlin/androidx/compose/runtime/saveable/package-summary#rememberSaveable(kotlin.Array,androidx.compose.runtime.saveable.Saver,kotlin.String,kotlin.Function0)">rememberSaveable</a> çš„è¯´æ˜ï¼š</p>
<blockquote>
<p>ä¸ <code>remember {}</code> ç±»ä¼¼ï¼Œä½†å­˜å‚¨çš„å€¼ä¼šåœ¨ <strong>Activity æˆ–è¿›ç¨‹é‡å»ºå</strong> ä»ç„¶ä¿ç•™ï¼ŒåŸºäº Android çš„ <code>SavedInstanceState</code> æœºåˆ¶ã€‚</p>
</blockquote>
<p>è¦ç‚¹ï¼š</p>
<ul>
<li><p>é»˜è®¤ä½¿ç”¨ <code>autoSaver()</code> å°†å€¼å†™å…¥ Bundleï¼›ä¹Ÿå¯è‡ªå®šä¹‰ <code>Saver</code>ã€‚</p>
</li>
<li><p>ä»…æ”¯æŒå¯æ”¾å…¥ Bundle çš„ç±»å‹ï¼ˆå¦‚ Intã€Stringã€Float ç­‰ï¼‰ã€‚</p>
</li>
<li><p>è‹¥ä¿å­˜çš„æ˜¯è‡ªå®šä¹‰ç±»å‹ï¼ˆå¦‚ data classï¼‰ï¼Œå¿…é¡»æä¾› <code>Saver</code> å®ç°ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">java.lang.IllegalArgumentException: MutableState containing ... cannot be saved using the current SaveableStateRegistry.
The default implementation only supports types which can be stored inside the Bundle.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ul>
<p>å› æ­¤ï¼Œ<strong>ç¦»å¼€å±å¹•å†è¿›å…¥</strong>æ—¶ï¼Œåªè¦æ²¡æœ‰å‘ç”Ÿ Activity/è¿›ç¨‹é‡å»ºï¼Œ<code>rememberSaveable</code> ä»ä¼šä» SaveableStateRegistry é‡Œæ¢å¤ä¹‹å‰ä¿å­˜çš„å€¼ï¼Œscale å¾—ä»¥ä¿ç•™ã€‚</p>
<h2 id="ä¸‰ã€éªŒè¯å®éªŒ"><a href="#ä¸‰ã€éªŒè¯å®éªŒ" class="headerlink" title="ä¸‰ã€éªŒè¯å®éªŒ"></a>ä¸‰ã€éªŒè¯å®éªŒ</h2><p>ç”¨ç®€å•æ—¥å¿—éªŒè¯ã€Œé€€å‡ºç»„åˆåå†è¿›å…¥ä¼šé‡æ–°è®¡ç®—ã€ï¼š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">var</span> scale <span class="token keyword">by</span> remember <span class="token punctuation">{</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"=== re-calculate"</span></span><span class="token punctuation">)</span>
    <span class="token function">mutableFloatStateOf</span><span class="token punctuation">(</span><span class="token number">1.0f</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">DisposableEffect</span><span class="token punctuation">(</span>key1 <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    onDispose <span class="token punctuation">{</span> <span class="token function">println</span><span class="token punctuation">(</span><span class="token string-literal singleline"><span class="token string">"=== onDispose"</span></span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><code>DisposableEffect(key1 = null)</code> ä¿è¯åªæœ‰åœ¨<strong>é€€å‡ºç»„åˆ</strong>æ—¶æ‰ä¼šæ‰§è¡Œ <code>onDispose</code>ã€‚</p>
<ul>
<li>**ä½¿ç”¨ <code>remember {}</code>**ï¼šç¬¬ä¸€æ¬¡è¿›å…¥æ‰“å° <code>re-calculate</code>ï¼›åˆ‡åˆ°å…¶ä»– Tab åœç•™åï¼Œå…ˆæ‰“å° <code>onDispose</code>ï¼Œå†åˆ‡å›æ¥ä¼šå†æ¬¡æ‰“å° <code>re-calculate</code>ï¼Œscale è¢«é‡ç½®ã€‚<br><img src="/img/20231204/remember_log.jpg" alt="Logger" title="remember_log"></li>
<li>**æ”¹ç”¨ <code>rememberSaveable {}</code>**ï¼šåªæœ‰ç¬¬ä¸€æ¬¡è¿›å…¥æ—¶æ‰“å°ä¸€æ¬¡ <code>re-calculate</code>ï¼Œä¹‹ååˆ‡ Tab å†å›æ¥ä¹Ÿä¸ä¼šå†æ‰“å°ï¼Œè¯´æ˜ä¸€ç›´ç”¨çš„æ˜¯å·²ä¿å­˜çš„å€¼ã€‚<br><img src="/img/20231204/remember_log1.jpg" alt="Logger1" title="remember_log1"></li>
</ul>
<h2 id="å››ã€å»¶ä¼¸ï¼šç¦»å¼€å±å¹•-â‰ -é‡å»º"><a href="#å››ã€å»¶ä¼¸ï¼šç¦»å¼€å±å¹•-â‰ -é‡å»º" class="headerlink" title="å››ã€å»¶ä¼¸ï¼šç¦»å¼€å±å¹• â‰  é‡å»º"></a>å››ã€å»¶ä¼¸ï¼šç¦»å¼€å±å¹• â‰  é‡å»º</h2><p><a href="https://jetc.dev/slack/2021-04-13-when-do-we-use-remembersaveable.html">Jetpack Compose ç›¸å…³è®¨è®º</a> é‡Œæœ‰ä¸€å¥ï¼š**â€Composable leaving the screen is not recreationâ€**ï¼ˆå¯ç»„åˆé¡¹ç¦»å¼€å±å¹•å¹¶ä¸ç­‰äºé‡å»ºï¼‰ã€‚</p>
<p>åœ¨ Compose ä¸­ï¼š</p>
<ul>
<li>ç»„ä»¶ç¦»å¼€å±å¹•ä¼šè§¦å‘ <code>onDispose</code>ï¼Œç”Ÿå‘½å‘¨æœŸç»“æŸã€‚</li>
<li>å†æ¬¡è¿›å…¥å±å¹•ä¼šé‡æ–°ç»„åˆï¼Œç›¸å½“äºæ–°çš„ç”Ÿå‘½å‘¨æœŸï¼Œ<code>remember {}</code> ä¼šé‡æ–°è®¡ç®—ã€‚</li>
</ul>
<p>æ‰€ä»¥ã€Œç¦»å¼€å±å¹•ã€å’Œã€ŒConfiguration å˜åŒ–å¯¼è‡´ Activity é‡å»ºã€æ˜¯ä¸¤å›äº‹ï¼šå‰è€…ä¸ä¼šè§¦å‘ SavedInstanceState æµç¨‹ï¼Œåªä¼šè®©å¯ç»„åˆé¡¹é€€å‡ºç»„åˆï¼›åè€…æ‰ä¼šè§¦å‘è¿›ç¨‹/Activity é‡å»ºï¼Œæ­¤æ—¶æ‰ç”¨åˆ° <code>rememberSaveable</code> çš„æŒä¹…åŒ–ã€‚</p>
<p>å¸¸è§ã€Œç¦»å¼€å±å¹•ã€åœºæ™¯åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>Navigation è·³è½¬ / Tab åˆ‡æ¢</strong>ï¼ˆå¦‚æœ¬æ–‡æ¡ˆä¾‹ï¼‰</li>
<li><strong>åˆ—è¡¨æ»‘åŠ¨</strong>ï¼šItem æ»‘å‡ºè§†å£æ—¶ä¼šé€€å‡ºç»„åˆï¼Œ<code>onDispose</code> ä¼šæ‰§è¡Œ</li>
</ol>
<p>ä¾‹å¦‚ LazyColumn çš„ Item é…åˆ <code>DisposableEffect</code> å¯ä»¥è§‚å¯Ÿåˆ°æ»‘å‡ºæ—¶æ‰“å°ï¼›è‹¥éœ€è¦<strong>è·¨é¡µé¢æˆ–é‡æ–°è¿›å…¥é¡µé¢æ—¶æ¢å¤åˆ—è¡¨æ»šåŠ¨ä½ç½®</strong>ï¼Œåº”ä½¿ç”¨åŸºäº <code>rememberSaveable</code> çš„ <code>rememberLazyListState</code> ç­‰ APIã€‚</p>
<h2 id="äº”ã€å¦‚ä½•é€‰æ‹©"><a href="#äº”ã€å¦‚ä½•é€‰æ‹©" class="headerlink" title="äº”ã€å¦‚ä½•é€‰æ‹©"></a>äº”ã€å¦‚ä½•é€‰æ‹©</h2><table>
<thead>
<tr>
<th>éœ€æ±‚</th>
<th>æ¨è</th>
</tr>
</thead>
<tbody><tr>
<td>çŠ¶æ€åªéœ€åœ¨<strong>é‡ç»„</strong>è¿‡ç¨‹ä¸­ä¿æŒ</td>
<td><code>remember {}</code></td>
</tr>
<tr>
<td>çŠ¶æ€éœ€è¦åœ¨ <strong>Activity/è¿›ç¨‹é‡å»º</strong>ï¼ˆå¦‚æ—‹è½¬ã€å†…å­˜å›æ”¶ï¼‰åæ¢å¤</td>
<td><code>rememberSaveable {}</code></td>
</tr>
<tr>
<td>çŠ¶æ€éœ€è¦<strong>è·¨é¡µé¢</strong>æˆ–æ›´å¤æ‚çš„ä½œç”¨åŸŸ</td>
<td>ViewModel ç­‰ï¼›è‹¥ä»…åœ¨å•é¡µå†…ä¸”éœ€åº”å¯¹ã€Œç¦»å¼€å†è¿›å…¥ã€ï¼Œ<code>rememberSaveable {}</code> ä»é€‚ç”¨</td>
</tr>
</tbody></table>
<p>ç†è§£ã€Œè¿›å…¥/é‡ç»„/é€€å‡ºç»„åˆã€ä¸ã€ŒSavedInstanceState é‡å»ºã€çš„å·®å¼‚åï¼Œå°±èƒ½åœ¨å¼€å‘ä¸­æŒ‰åœºæ™¯é€‰ç”¨ <code>remember</code> æˆ– <code>rememberSaveable</code>ï¼Œé¿å…çŠ¶æ€è¢«æ„å¤–é‡ç½®ã€‚</p>
]]></content>
      <categories>
        <category>Technical</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>Jetpack Compose</tag>
      </tags>
  </entry>
  <entry>
    <title>Jetpack Compose Performance Tips Every Developer Should Know</title>
    <url>/posts/2026/02/27/4ae1fc92/</url>
    <content><![CDATA[<h1 id="Jetpack-Compose-Performance-Why-graphicsLayer-is-Your-Secret-Weapon"><a href="#Jetpack-Compose-Performance-Why-graphicsLayer-is-Your-Secret-Weapon" class="headerlink" title="Jetpack Compose Performance: Why .graphicsLayer { } is Your Secret Weapon"></a>Jetpack Compose Performance: Why .graphicsLayer { } is Your Secret Weapon</h1><p>In the world of Jetpack Compose, there are usually multiple ways to achieve the same visual result. Want to fade a button? You could use <code>.alpha(0.5f)</code> or <code>.graphicsLayer { alpha = 0.5f }</code>. </p>
<p>Both look identical on screen, but under the hood, one is a performance gas-guzzler and the other is a streamlined electric racer. Hereâ€™s why <code>graphicsLayer { }</code> is the superior choice for high-performance UI.</p>
<hr>
<h2 id="1-The-Three-Phases-of-Compose"><a href="#1-The-Three-Phases-of-Compose" class="headerlink" title="1. The Three Phases of Compose"></a>1. The Three Phases of Compose</h2><p>To understand the speed difference, you have to understand the â€œCompose Pipeline.â€ When you update a state variable, Compose goes through three steps:</p>
<ol>
<li><strong>Composition:</strong> What to show (Building the UI tree).</li>
<li><strong>Layout:</strong> Where to show it (Measuring and placing elements).</li>
<li><strong>Drawing:</strong> How to show it (Rendering pixels, rotations, and fades).</li>
</ol>
<h3 id="The-Problem-with-Standard-Modifiers"><a href="#The-Problem-with-Standard-Modifiers" class="headerlink" title="The Problem with Standard Modifiers"></a>The Problem with Standard Modifiers</h3><p>When you use <code>.alpha(myState)</code>, you are passing a <strong>value</strong>. When that value changes, Compose says: <em>â€œWait, the parameters changed! I need to re-run the Composition phase.â€</em> This triggers a <strong>Recomposition</strong>, which is the most expensive operation in the pipeline.</p>
<h3 id="The-Magic-of-the-Lambda"><a href="#The-Magic-of-the-Lambda" class="headerlink" title="The Magic of the Lambda"></a>The Magic of the Lambda</h3><p>When you use <code>.graphicsLayer { alpha = myState }</code>, you arenâ€™t passing a value; you are passing a <strong>lambda (a block of code)</strong>. Compose is smart enough to skip Composition and Layout entirely. It waits until the <strong>Drawing phase</strong> to execute that block. </p>
<blockquote>
<p><strong>The Result:</strong> You bypass the heavy lifting and go straight to the finish line.</p>
</blockquote>
<hr>
<h2 id="2-Hardware-Layers-RenderNodes"><a href="#2-Hardware-Layers-RenderNodes" class="headerlink" title="2. Hardware Layers &amp; RenderNodes"></a>2. Hardware Layers &amp; RenderNodes</h2><p><code>graphicsLayer</code> doesnâ€™t just skip phases; it changes how the GPU talks to your screen. </p>
<p>When you wrap content in a <code>graphicsLayer</code>, Compose creates a <strong>RenderNode</strong>. This is a dedicated â€œlayerâ€ in the display list.</p>
<ul>
<li><strong>Isolation:</strong> If you rotate a layer, the GPU just tilts the existing â€œtextureâ€ it already has in memory. It doesnâ€™t need to ask the CPU to redraw the text or shapes inside it.</li>
<li><strong>Efficiency:</strong> Multiple transformations (scale, rotation, alpha) inside one <code>graphicsLayer</code> block are batched together.</li>
</ul>
<hr>
<h2 id="3-Comparison-Table"><a href="#3-Comparison-Table" class="headerlink" title="3. Comparison Table"></a>3. Comparison Table</h2><table>
<thead>
<tr>
<th align="left">Feature</th>
<th align="left"><code>.alpha()</code>, <code>.rotate()</code>, etc.</th>
<th align="left"><code>.graphicsLayer { ... }</code></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>Input Type</strong></td>
<td align="left">Value (Direct)</td>
<td align="left">Lambda (Deferred)</td>
</tr>
<tr>
<td align="left"><strong>Triggers Recomposition?</strong></td>
<td align="left">Yes ğŸ”´</td>
<td align="left">No ğŸŸ¢</td>
</tr>
<tr>
<td align="left"><strong>Phase Target</strong></td>
<td align="left">Composition</td>
<td align="left">Drawing</td>
</tr>
<tr>
<td align="left"><strong>Best For</strong></td>
<td align="left">Static or rare changes</td>
<td align="left">Animations, Scroll-based effects</td>
</tr>
</tbody></table>
<hr>
<h2 id="4-Practical-Example-The-â€œFastâ€-Way"><a href="#4-Practical-Example-The-â€œFastâ€-Way" class="headerlink" title="4. Practical Example: The â€œFastâ€ Way"></a>4. Practical Example: The â€œFastâ€ Way</h2><p>If you are animating a value (like a scroll offset or a pulsing heart icon), <strong>always</strong> use the lambda-based version to keep your frame rate at a buttery-smooth 60 (or 120) FPS.</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">val</span> animatedScale <span class="token keyword">by</span> <span class="token function">animateFloatAsState</span><span class="token punctuation">(</span>targetValue <span class="token operator">=</span> <span class="token number">1.2f</span><span class="token punctuation">)</span>

<span class="token function">Box</span><span class="token punctuation">(</span>
    Modifier
        <span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">background</span><span class="token punctuation">(</span>Color<span class="token punctuation">.</span>Magenta<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">graphicsLayer</span> <span class="token punctuation">{</span>
            <span class="token comment">// State read is DEFERRED to the Draw phase.</span>
            <span class="token comment">// No Recomposition happens when scaleX/Y changes!</span>
            scaleX <span class="token operator">=</span> animatedScale
            scaleY <span class="token operator">=</span> animatedScale
            clip <span class="token operator">=</span> <span class="token boolean">true</span>
            shape <span class="token operator">=</span> <span class="token function">RoundedCornerShape</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h2 id="5-Summary"><a href="#5-Summary" class="headerlink" title="5. Summary"></a>5. Summary</h2><p>By using graphicsLayer { }, you are essentially telling Compose: â€œDonâ€™t rebuild the whole house just because I want to change the color of the curtains.â€ You save CPU cycles, reduce battery drain, and ensure your animations never drop a frame.</p>
]]></content>
      <categories>
        <category>Compose</category>
      </categories>
      <tags>
        <tag>Jetpack Compose</tag>
      </tags>
  </entry>
</search>
