<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>æµ…è°ˆJetpack Compose LaunchedEffect</title>
    <url>/2023/07/04/A-brief-of-Jetpack-Compose-LaunchedEffect/</url>
    <content><![CDATA[<p>åœ¨Jetpack Compose ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸çœ‹åˆ°<code>LaunchedEffect</code>è¿™ä¸ªå¸¸è§çš„ã€‚ä»Šå¤©å°±ç®€å•äº†è§£ä¸‹è¿™ä¸ªæ–¹æ³•å§ã€‚åœ¨è¯´<code>LaunchedEffect</code>å‰ï¼Œè®©æˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹<code>Side Effect</code>.</p>
<h3 id="ä»€ä¹ˆæ˜¯Side-Effect"><a href="#ä»€ä¹ˆæ˜¯Side-Effect" class="headerlink" title="ä»€ä¹ˆæ˜¯Side Effect"></a>ä»€ä¹ˆæ˜¯Side Effect</h3><p>åœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œ<code>Side-Effect</code>æŒ‡çš„æ˜¯è°ƒç”¨å‡½æ•°æ—¶ï¼Œé™¤äº†è¿”å›å¯èƒ½çš„å‡½æ•°å€¼å¤–ï¼Œè¯¥å‡½æ•°è¿˜å¯¹å‡½æ•°èŒƒå›´å¤–çš„å˜é‡ï¼Œå‚æ•°ç­‰è¿›è¡Œäº†ä¿®æ”¹ã€‚<br>ä¸¾ä¸ªğŸŒ°ï¼Œçœ‹ä¸‹é¢çš„å‡½æ•°ï¼Œå®ƒæœ‰2ä¸ªå‚æ•°ï¼Œè¿”å›å®ƒä»¬çš„å’Œï¼Œä½†æ˜¯æ²¡æœ‰å¯¹ä»»ä½•å…¶ä»–å˜é‡æœ‰ä¿®æ”¹ï¼Œæ‰€ä»¥å®ƒæ˜¯æ²¡æœ‰å‰¯ä½œç”¨(No Side-Effect)çš„</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sum</span><span class="params">(number1: <span class="type">Int</span>, number2: <span class="type">Int</span>)</span></span> = number1 + number2</span><br></pre></td></tr></table></figure>
<p>ä½†å¦‚æœæˆ‘ä»¬å°†å‡½æ•°ä¿®æ”¹æˆä¸‹é¢çš„å®ç°ï¼Œæ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°éƒ½ä¼šå¯¹sumé‡æ–°èµ‹å€¼ï¼Œè€Œsumåˆæ˜¯åœ¨å‡½æ•°èŒƒå›´å¤–ï¼Œæ‰€ä»¥è®¤ä¸ºè¿™ä¸ªå‡½æ•°æœ‰ä¸€ä¸ªå‰¯ä½œç”¨</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">var</span> sum = <span class="number">0</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">sum</span><span class="params">(number1: <span class="type">Int</span>, number2: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    sum = number1 + number2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åœ¨Jetpack-Compose-ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect"><a href="#åœ¨Jetpack-Compose-ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect" class="headerlink" title="åœ¨Jetpack Compose ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect"></a>åœ¨Jetpack Compose ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect</h3><p>æ ¹æ®æºç æˆ‘ä»¬çœ‹åˆ°ï¼Œ<code>LaunchedEffect</code>æ˜¯ä¸€ä¸ªå¸¦æœ‰<code>@Composable</code>çš„å‡½æ•°ï¼Œæ³¨é‡Šå¦‚ä¸‹</p>
<span id="more"></span>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">When LaunchedEffect enters the composition it will launch block into the composition<span class="string">&#x27;s CoroutineContext. The coroutine will be cancelled and re-launched when LaunchedEffect is recomposed with a different key1 or key2. The coroutine will be cancelled when the LaunchedEffect leaves the composition.</span></span><br><span class="line"><span class="string">This function should not be used to (re-)launch ongoing tasks in response to callback events by way of storing callback data in MutableState passed to key. Instead, see rememberCoroutineScope to obtain a CoroutineScope that may be used to launch ongoing jobs scoped to the composition in response to event callbacks.</span></span><br></pre></td></tr></table></figure>
<p>ç®€å•æ¥è¯´ï¼Œ<code>LaunchedEffect</code>æ˜¯ä¸€ä¸ªå¯åœ¨å½“å‰å¯ç»„åˆé¡¹çš„ä½œç”¨åŸŸå†…è¿è¡ŒæŒ‚èµ·å‡½æ•°(blockæ˜¯suspendçš„)çš„å¯ç»„åˆå‡½æ•°ã€‚<br>åœ¨<a href="https://developer.android.com/jetpack/compose/mental-model">Thinking in Compose</a>ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ä¸€ä¸ªå¯ç»„åˆé¡¹åº”è¯¥æ˜¯æ²¡æœ‰å‰¯ä½œç”¨çš„ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨å¯ç»„åˆé¡¹ä¸­ä¿®æ”¹åº”ç”¨çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡Effect APIå¯åŠ¨åç¨‹æ“ä½œï¼Œæ‰€ä»¥å¯ä»¥è¯´<code>LaunchedEffect</code>åœ¨Jetpack Composeä¸­æä¾›äº†åœ¨å¯ç»„åˆé¡¹ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°çš„èƒ½åŠ›ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­ç®€å•äº†è§£ä¸‹ï¼Œ è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªTodoTaskä¸‹çš„ä¸€ä¸ªå°åŠŸèƒ½ï¼Œæ ¹æ®é€‰æ‹©çš„ç±»åˆ«å±•ç¤ºå½“å‰ç±»åˆ«çš„æ‰€æœ‰Taskã€‚<br>ç®€å•çš„å‡†å¤‡mock tasksï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">TodoTask</span></span>(</span><br><span class="line">    <span class="keyword">val</span> id: <span class="built_in">Long</span>,</span><br><span class="line">    <span class="keyword">val</span> name: String,</span><br><span class="line">    <span class="keyword">val</span> description: String</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// mock tasks respose</span></span><br><span class="line"><span class="keyword">val</span> mockTasks = (<span class="number">1.</span><span class="number">.10</span>).map &#123;</span><br><span class="line">    TodoTask(</span><br><span class="line">        id = it.toLong(),</span><br><span class="line">        name = <span class="string">&quot;task name <span class="variable">$it</span>&quot;</span>,</span><br><span class="line">        description = <span class="string">&quot;task description <span class="variable">$it</span>&quot;</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// mock get tasks from api, delay 2 seconds</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">getTasks</span><span class="params">()</span></span>: List&lt;TodoTask&gt; &#123;</span><br><span class="line">    delay(<span class="number">2000</span>)</span><br><span class="line">    <span class="keyword">return</span> mockTasks</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨TodoListOfCategoryScreenä¸»è¦æ˜¯ä¸€ä¸ªLazy Columnç”¨æ¥å±•ç¤ºä»»åŠ¡åç§°çš„ï¼Œå…¶ä¸­å‚æ•°æ˜¯Category</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Composable</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">TodoListOfCategoryScreen</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    category: <span class="type">String</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    println(<span class="string">&quot;TASK TAG: out of column scope&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> tasks <span class="keyword">by</span> remember &#123;</span><br><span class="line">        mutableStateOf(emptyList&lt;TodoTask&gt;())</span><br><span class="line">    &#125;</span><br><span class="line">    Column(</span><br><span class="line">        modifier = Modifier.fillMaxSize()</span><br><span class="line">    ) &#123;</span><br><span class="line">        println(<span class="string">&quot;TASK TAG: TodoListScreen: <span class="subst">$&#123;tasks.size&#125;</span>, category: <span class="variable">$category</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        LaunchedEffect(key1 = category) &#123;</span><br><span class="line">            tasks = getTasks()</span><br><span class="line">            println(<span class="string">&quot;TASK TAG: get tasks from api, category: <span class="variable">$category</span>&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        LazyColumn(</span><br><span class="line">            modifier = Modifier.fillMaxSize()</span><br><span class="line">        ) &#123;</span><br><span class="line">            items(tasks, key = &#123;</span><br><span class="line">                it.id</span><br><span class="line">            &#125;) &#123;</span><br><span class="line">                Text(modifier = Modifier.fillMaxWidth(), text = it.name)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬çš„categoryæ˜¯å›ºå®šçš„ï¼Œåœ¨getTasksä¹‹åï¼Œä¿®æ”¹äº†taskså¯¼è‡´Columnå‘ç”Ÿé‡ç»„ï¼Œæ‰€ä»¥scopeç›¸å…³çš„æ—¥å¿—æ‰“å°äº†2æ¬¡ã€‚è€Œæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚çš„<code>LaunchedEffect</code>å†…åªè°ƒç”¨äº†ä¸€æ¬¡ï¼Œæ˜¯å› ä¸º<code>LaunchedEffect</code>çš„è°ƒç”¨æ—¶æœŸåªæœ‰è¿›å…¥é‡ç»„é¡¹æˆ–è€…Keyå˜åŒ–é‡ç»„ï¼Œå¦‚æœæ˜¯æ™®é€šçš„å¯åŠ¨åç¨‹ï¼Œåœ¨é‡ç»„æ—¶ï¼Œä¼šå¯¼è‡´å¤šæ¬¡è°ƒç”¨apiè¯·æ±‚ã€‚<br><img src="/images/codes/launched_effect_1.jpg" alt="Logcat" title="launched_effect"></p>
<blockquote>
<p>PS: è¿™é‡Œä¸ºä»€ä¹ˆout of column scopeä¹Ÿä¼šæ‰“å°2æ¬¡å‘¢ï¼Œå…¶å®æ˜¯å› ä¸ºColumnæ˜¯inlineçš„ï¼Œ å®ƒåªèƒ½å…±äº«è°ƒç”¨æ–¹çš„é‡ç»„èŒƒå›´ã€‚</p>
</blockquote>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li><code>LaunchedEffect</code>æ˜¯åœ¨Jetpack Composeä¸­æä¾›äº†åœ¨å¯ç»„åˆé¡¹ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°çš„èƒ½åŠ›çš„ä¸€ç§æ–¹å¼ã€‚</li>
<li>åœ¨è¿›å…¥ç»„åˆé¡¹æ—¶ï¼Œ<code>LaunchedEffect</code>ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹å¹¶æ‰§è¡ŒæŒ‚èµ·ä»£ç å—(block)ï¼Œåœ¨é€€å‡ºç»„åˆé¡¹æ—¶ï¼Œåç¨‹å°†å–æ¶ˆ</li>
<li>ä½¿ç”¨ä¸åŒçš„key(å‚æ•°key1, key2)é‡ç»„æ—¶ï¼Œä¼šå–æ¶ˆå½“å‰åç¨‹å¹¶å¯åŠ¨æ–°çš„åç¨‹æ‰§è¡ŒæŒ‚èµ·å‡½æ•°</li>
<li>å†™<code>LaunchedEffect</code>å‡½æ•°æ—¶ï¼Œæœ€å°‘è¦ä¸€ä¸ªkey(IDE ä¼šæœ‰æç¤º)</li>
<li><code>LaunchedEffect</code>çš„å‡½æ•°è°ƒåº¦å™¨æ˜¯ä¸»çº¿ç¨‹</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Jetpack Compose</tag>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>DATA BETWEEN AIDL IN ANDROID</title>
    <url>/2023/03/20/DATA-BETWEEN-AIDL-IN-ANDROID/</url>
    <content><![CDATA[<blockquote>
<p>Android å¤¸è¿›ç¨‹é€šè®¯çš„æ–¹å¼ä¸€èˆ¬æœ‰ï¼š</p>
<ol>
<li>Binder</li>
<li>å†…å­˜å…±äº«</li>
<li>Socket</li>
</ol>
</blockquote>
<p>å…¶ä¸­Binderåœ¨Androidä¸­ä½¿ç”¨æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚AMS<br>åœ¨Androidä¸Šï¼Œä¸€ä¸ªè¿›ç¨‹é€šå¸¸æ˜¯ä¸èƒ½è·å–åˆ°å…¶ä»–è¿›ç¨‹çš„å†…å­˜è®¿é—®æƒé™çš„ï¼Œä½†æ˜¯æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´è¿›è¡Œæ•°æ®å¤„ç†ï¼Œå› æ­¤Androidæä¾›äº†Android Interface Definition Languageï¼ˆAIDLï¼‰æ¥åšå¤„ç†<br>å…¶å®AIDLæ˜¯æ–‡ä»¶ä¼šé€šè¿‡ç¼–è¯‘ç”Ÿæˆä¸€ä¸ªSubç±»å¹¶å®ç°IBinderæ¥å£çš„ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¯´æ˜¯åŸºäºBinderå®ç°çš„ã€‚</p>
<h3 id="é…ç½®æ–°é¡¹ç›®"><a href="#é…ç½®æ–°é¡¹ç›®" class="headerlink" title="é…ç½®æ–°é¡¹ç›®"></a>é…ç½®æ–°é¡¹ç›®</h3><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œæœ‰ä¸¤ä¸ªPhone Moduleï¼Œåˆ†åˆ«ä¸ºClientå’ŒServerç«¯ã€‚å¯¹äºæ–°çš„é¡¹ç›®æ‰“å¼€aidl featureæ”¯æŒ</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">buildFeatures &#123;</span><br><span class="line">    compose <span class="literal">true</span></span><br><span class="line">    aidl <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<span id="more"></span>
<h3 id="Serverç«¯ï¼š"><a href="#Serverç«¯ï¼š" class="headerlink" title="Serverç«¯ï¼š"></a>Serverç«¯ï¼š</h3><p>ç„¶ååˆ›å»ºaidlæ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">interface IRemoteAidlInterface &#123;</span><br><span class="line">    /**</span><br><span class="line">    * Demonstrates some basic types that you can use as parameters</span><br><span class="line">    * and return values in AIDL.</span><br><span class="line">    */</span><br><span class="line">    int currPid();</span><br><span class="line">    void basicTypes(int anInt, long aLong, boolean aBoolean, float aFloat,</span><br><span class="line">    double aDouble, String aString);</span><br><span class="line">    void addUser(inout User user);</span><br><span class="line">    User theFirstUser();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä»¥ä¸ŠåŠ äº†Userä¸æ˜¯åŸºæœ¬ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†ï¼Œ<br>é¦–å…ˆæ·»åŠ ä¸€ä¸ªaidlæ–‡ä»¶å£°æ˜ä¸‹è¿™ä¸ªç±»</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">package com.easy.aidlserver;</span><br><span class="line"></span><br><span class="line">// Declare any non-default types here with import statements</span><br><span class="line"></span><br><span class="line">parcelable User;</span><br></pre></td></tr></table></figure>
<p>ç„¶ååˆ›å»ºä¸€ä¸ªdata class, å¹¶æ·»åŠ <code>readFromParcel</code>æ–¹æ³•</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Parcelize</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>(</span><br><span class="line"><span class="keyword">var</span> name: String? = <span class="string">&quot;&quot;</span>,</span><br><span class="line"><span class="keyword">var</span> age: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">): Parcelable &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">readFromParcel</span><span class="params">(reply: <span class="type">Parcel</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.name = reply.readString().toString()</span><br><span class="line">        <span class="keyword">this</span>.age = reply.readInt()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Buildä¸‹é¡¹ç›®ç”Ÿæˆå¯¹åº”çš„javaç±»ï¼Œ<br>å£°æ˜å¹¶æ³¨å†Œä¸€ä¸ªServiceï¼Œæä¾›æ•°æ®å¤„ç†èƒ½åŠ›</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoteService</span> : <span class="type">Service</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBind</span><span class="params">(intent: <span class="type">Intent</span>?)</span></span>: IBinder &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Service Side&quot;</span>, <span class="string">&quot;onBind&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> binder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onUnbind</span><span class="params">(intent: <span class="type">Intent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Service Side&quot;</span>, <span class="string">&quot;onUnBind&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onUnbind(intent)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> users = mutableListOf&lt;User&gt;()</span><br><span class="line"></span><br><span class="line">    .....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¹¶åœ¨manifestç§æ³¨å†Œ</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">&quot;.RemoteService&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:exported</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:ignore</span>=<span class="string">&quot;ExportedService&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;com.aidl.server&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">&quot;android.intent.category.DEFAULT&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">service</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>è¿™é‡ŒServerç«¯ä»£ç å®Œæˆäº†</p>
<h3 id="Clientç«¯"><a href="#Clientç«¯" class="headerlink" title="Clientç«¯"></a>Clientç«¯</h3><p>copy aidlæ–‡ä»¶åˆ°clientç«¯ï¼Œæ³¨æ„è¦ç›¸åŒçš„åŒ…åå’Œå†…å®¹ï¼Œè¿˜æœ‰å¯¹åº”çš„data class <code>User</code><br>å®šä¹‰connectionå¹¶é€šè¿‡Binderæ‹¿åˆ°AIDL Interfaceï¼Œæ‹¿åˆ°interfaceå°±å¯ä»¥é€šè¿‡è°ƒç”¨aidlæä¾›çš„æ–¹æ³•ï¼Œå¹¶é€šè¿‡Proxyå’ŒæœåŠ¡ç«¯çš„serviceè¿›è¡Œæ•°æ®ä¼ è¾“å’Œå¤„ç†</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> sConnection = <span class="keyword">object</span> : ServiceConnection &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onServiceConnected</span><span class="params">(name: <span class="type">ComponentName</span>?, service: <span class="type">IBinder</span>?)</span></span> &#123;</span><br><span class="line">        iRemoteService = IRemoteAidlInterface.Stub.asInterface(service)</span><br><span class="line">        iRemoteService?.let &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> pid = it.currPid()</span><br><span class="line">                <span class="keyword">val</span> myPid = Process.myPid()</span><br><span class="line">                Log.i(<span class="string">&quot;Client&quot;</span>, <span class="string">&quot;Service Pid: <span class="variable">$pid</span>, Client Pid: <span class="variable">$myPid</span>&quot;</span>)</span><br><span class="line">                it.basicTypes(<span class="number">1</span>, <span class="number">2</span>, <span class="literal">true</span>, <span class="number">3.0f</span>, <span class="number">5.0</span>, <span class="string">&quot;Hello AIDL Server&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onServiceDisconnected</span><span class="params">(name: <span class="type">ComponentName</span>?)</span></span> &#123;</span><br><span class="line">        Log.d(<span class="string">&quot;Client&quot;</span>, <span class="string">&quot;onDisconnect&quot;</span>)</span><br><span class="line">        iRemoteService = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é‡åˆ°çš„é—®é¢˜æˆ–ç–‘æƒ‘ï¼š</p>
<ol>
<li><p>é€šè¿‡API30 çš„x86 è™šæ‹Ÿæœºå¯ä»¥æ­£å¸¸å”¤é†’serviceå¹¶æ•°æ®æ­£å¸¸ä¼ è¾“ï¼Œä½†æ˜¯åœ¨API33çš„çœŸæœºä¸Šæ— æ³•bind service<br>é€šè¿‡æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°åœ¨30æˆ–ä»¥ä¸Šçš„API levelåå­˜åœ¨<a href="https://developer.android.google.cn/training/package-visibility?hl=en">Package visibility filtering on Android</a> è¿™ä¹ˆä¸€ä¸ªè¯´æ³•ã€‚<br>å¤§æ¦‚å°±æ˜¯ä¸ºäº†æ›´é«˜çš„å®‰å…¨æ€§è€ŒåŠ å…¥äº†è¿‡æ»¤è¡Œä¸ºï¼Œä»è€Œå¯¼è‡´åº”ç”¨æ— æ³•æ£€æµ‹åˆ°å½“å‰è®¾å¤‡ä¸Šæ‰€æœ‰å®‰è£…çš„åº”ç”¨ç¨‹åºã€‚è§£å†³æ–¹æ³•åŠ å…¥ <code>queries</code></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">queries</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">package</span> <span class="attr">android:name</span>=<span class="string">&quot;com.easy.aidlserver&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">queries</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
<li><p>å·²ç»æ“ä½œäº†unbindServiceï¼Œä½†æ˜¯ä»ç„¶èƒ½è¿›è¡Œæ•°æ®æ“ä½œï¼Œè€Œä¸”æ—¥å¿—èµ°äº†onUnbindå´ä¸èµ°onServiceDisconnected<br>å…¶å®onServiceDisconnectedåœ¨æ­£å¸¸unbindçš„æ—¶å€™æ˜¯ä¸ä¼šè§¦å‘æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨æœåŠ¡ä¸¢å¤±çš„æ—¶å€™æ‰§è¡Œã€‚<br><img src="/images/codes/aidl_1.jpg" alt="When to excute onServiceDisconnected" title="AIDL"></p>
</li>
<li><p>ä¼ è¾“å¤§æ•°æ®çš„æ—¶å€™<br>å› ä¸ºAIDL æ˜¯é€šè¿‡IBinderè¿›è¡Œæ•°æ®ä¼ è¾“çš„ï¼Œè€ŒIBinderå¯¹æ•°æ®çš„æ‹·è´æ˜¯ç»è¿‡mmapï¼ˆå†…å­˜æ˜ å°„ï¼‰ï¼Œåœ¨æˆ‘ä»¬appå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»ç”³è¯·ä¸€ä¸ª 1M - 8Kå¤§å°çš„å†…å­˜ç»™mmapï¼Œæ‰€ä»¥å¦‚æœ<br>ä¼ è¾“1Mæˆ–ä»¥ä¸Šçš„æ•°æ®å°±ä¼šæŠ¥é”™ã€‚<br>å°†Userä¿®æ”¹ä¸€ä¸‹ï¼ŒåŠ ä¸€ä¸ªByteArray</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Parcelize</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>(</span><br><span class="line">    <span class="keyword">var</span> name: String? = <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="keyword">var</span> age: <span class="built_in">Int</span> = <span class="number">0</span>,</span><br><span class="line">    <span class="keyword">var</span> byteArray: ByteArray = ByteArray(<span class="number">1</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨çš„æ—¶å€™</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="comment">// _1M = 1024 * 1024</span></span><br><span class="line">iRemoteService?.addUser(</span><br><span class="line">    User(</span><br><span class="line">        <span class="string">&quot;Dougie <span class="subst">$&#123;Random.nextInt(<span class="number">1</span>, <span class="number">100</span>)&#125;</span>&quot;</span>,</span><br><span class="line">        Random.nextInt(<span class="number">18</span>, <span class="number">24</span>),</span><br><span class="line">        byteArray = ByteArray(_1M)</span><br><span class="line">    )</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>ä½ ä¼šæ”¶åˆ°æŠ¥é”™ä¿¡æ¯ï¼š<br><img src="/images/codes/aidl_error.jpg" alt="android.os.TransactionTooLargeException: data parcel size 1048712 bytes" title="AIDL Error"></p>
</li>
</ol>
<h3 id="ä»£ç åœ°å€-AidlSample"><a href="#ä»£ç åœ°å€-AidlSample" class="headerlink" title="ä»£ç åœ°å€ AidlSample"></a>ä»£ç åœ°å€ <a href="https://github.com/BreakZero/AidlSample">AidlSample</a></h3>]]></content>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Android Kotlin Coroutines + Retrofit + MVVM ç®€å•å®ç°</title>
    <url>/2021/09/11/Android-Kotlin-Coroutines-Retrofit-MVVM-%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul>
<li>è¿™æ˜¯ä¸€ç¯‡éšè®°ï¼Œæƒ³å°è¯•ä¸‹å†™æ–‡ç« ã€‚</li>
<li>è¿™é‡ŒåŸºæœ¬ä¸ä¼šæ·±å…¥è®¨è®ºå„ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¦‚éœ€äº†è§£æ›´å¤šå¯ä»¥å‚è€ƒ <a href="https://www.bennyhuo.com/">Bennyâ€™s Blog</a> å’Œ <a href="https://kotlinlang.org/docs/reference/coroutines/coroutines-guide.html">Kotlinå®˜æ–¹æ–‡æ¡£</a><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹"></a>ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹</h2></li>
<li>åç¨‹æ¯”çº¿ç¨‹å°<blockquote>
<p>æˆ‘ï¼š ä¸ºä»€ä¹ˆå·²ç»æœ‰Rxäº†è¿˜è¦åœ¨è¿™é‡Œç”¨åç¨‹ï¼Ÿ<br><br>æŸåŒäº‹ï¼š å› ä¸ºåç¨‹æ¯”çº¿ç¨‹å°ï¼Œå¯ä»¥å¼€å¾ˆå¤šä¸ªã€‚<br><br>æˆ‘ï¼šâ€¦â€¦ ä¸ºä»€ä¹ˆæ¯”çº¿ç¨‹å°ï¼Ÿ</p>
</blockquote>
</li>
</ul>
<p>&emsp; æˆ‘ç»´åŸºäº†ä¸€ä¸‹ï¼Œç¡®å®æœ‰è¯´æ¯”çº¿ç¨‹æ›´å°ã€‚<br><br>&emsp; ä½†æ˜¯çœ‹äº†ä¸€äº›æºç ï¼Œä¹Ÿæ˜¯çº¿ç¨‹æ±  + çº¿ç¨‹å®ç°çš„ï¼Œè¿™æ—¶å°±å¼€å§‹æœ‰äº†ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆåŒæ ·æ˜¯çº¿ç¨‹ï¼Œæ€ä¹ˆå°±è¯´æ˜¯æ¯”çº¿ç¨‹å°çš„ä¸œè¥¿å‘¢ï¼Ÿ<br><br>&emsp; ç›´åˆ°çœ‹åˆ°äº†Bennyå¤§ä½¬çš„æ–‡ç«  <a href="https://www.bennyhuo.com/2019/10/19/coroutine-why-so-called-lightweight-thread/">åç¨‹ä¸ºä»€ä¹ˆè¢«ç§°ä¸ºã€è½»é‡çº§çº¿ç¨‹ã€</a>è§£é‡Šï¼Œæˆ‘æ¸…æ™°äº†ã€‚é€šè¿‡æµ‹éªŒï¼Œç¡®å®å¯åŠ¨æˆåƒä¸Šä¸‡ä¸ªåç¨‹ä¹Ÿä¸ä¼šå‡ºç°OOMæˆ–è€…å…¶ä»–é—®é¢˜ã€‚</p>
<ul>
<li>å½“ç„¶æœ€ä¸»è¦çš„è¿˜æ˜¯ä»£ç ä¸Šçš„ä½“éªŒ<br>ç°åœ¨Kotlinè¶Šæ¥è¶Šæ™®éï¼Œå„ç§inlineå‡½æ•°ï¼Œæ“ä½œç¬¦ä¹Ÿéƒ½åŸºæœ¬å¯ä»¥æ›¿æ¢Rxçš„å¸¸ç”¨æ“ä½œç¬¦äº†ã€‚æ‰€ä»¥åœ¨å†™ä»£ç ä¸Šä½“éªŒè¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½çš„ã€‚<br><br><font color=#f00 size=3><em>ï¼ˆå¤‡æ³¨ï¼šä¸ªäººè§‰å¾—åç¨‹å°ä¸å°å¯¹äºAndroidå¼€å‘çœŸçš„æ²¡å¤šå¤§åŒºåˆ«ï¼Œæœ€ä¸»è¦è¿˜æ˜¯å†™ä»£ç å’Œä»£ç ç¾è§‚æ€§ï¼‰</em></font><span id="more"></span>
<h2 id="ä¸€ã€æ·»åŠ ä¾èµ–"><a href="#ä¸€ã€æ·»åŠ ä¾èµ–" class="headerlink" title="ä¸€ã€æ·»åŠ ä¾èµ–"></a>ä¸€ã€æ·»åŠ ä¾èµ–</h2><figure class="highlight gradle"><table><tr><td class="code"><pre><span class="line">implementation<span class="string">&quot;com.squareup.retrofit2:retrofit:2.6.2&quot;</span></span><br><span class="line">implementation<span class="string">&quot;com.squareup.retrofit2:converter-gson:2.6.2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Coroutines </span></span><br><span class="line">implementation <span class="string">&#x27;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.3.2&#x27;</span></span><br><span class="line">implementation <span class="string">&#x27;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.3.2&#x27;</span></span><br></pre></td></tr></table></figure>
<font color=#f00 size=3><em>è®°å¾—ä½¿ç”¨retrofit 2.6.0 æˆ–ä»¥ä¸Š</em></font><h2 id="äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£"><a href="#äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£" class="headerlink" title="äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£"></a>äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£</h2></li>
<li>åˆ›å»ºæ¥å£<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">GitApi</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GET(<span class="meta-string">&quot;/users/&#123;username&#125;/&#123;module&#125;&quot;</span>)</span></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">repos</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Path(<span class="meta-string">&quot;username&quot;</span>)</span> username: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Path(<span class="meta-string">&quot;module&quot;</span>)</span> module: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Query(<span class="meta-string">&quot;page&quot;</span>)</span> currPage: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: List&lt;RepoInfo&gt;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GET(<span class="meta-string">&quot;/search/repositories&quot;</span>)</span></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">searchRepos</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Query(<span class="meta-string">&quot;q&quot;</span>)</span> key: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Query(<span class="meta-string">&quot;sort&quot;</span>)</span> sort: <span class="type">String</span>? = <span class="string">&quot;updated&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Query(<span class="meta-string">&quot;order&quot;</span>)</span> order: <span class="type">String</span>? = <span class="string">&quot;desc&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@Query(<span class="meta-string">&quot;page&quot;</span>)</span> currPage: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: SearchResponse</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>åˆ›å»ºRetrofitå®ä¾‹<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">buildRetrofit</span><span class="params">()</span></span>: Retrofit &#123;</span><br><span class="line">     builder.addInterceptor(HttpLoggingInterceptor(<span class="keyword">object</span> : HttpLoggingInterceptor.Logger &#123;</span><br><span class="line">         <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">log</span><span class="params">(message: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">             Timber.d(message)</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;).apply &#123;</span><br><span class="line">         level = HttpLoggingInterceptor.Level.BODY</span><br><span class="line">     &#125;).addInterceptor(<span class="keyword">object</span> : Interceptor &#123;</span><br><span class="line">         <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">intercept</span><span class="params">(chain: <span class="type">Interceptor</span>.<span class="type">Chain</span>)</span></span>: Response &#123;</span><br><span class="line">             <span class="keyword">val</span> userCredentials = <span class="string">&quot;<span class="variable">$username</span>:<span class="variable">$password</span>&quot;</span></span><br><span class="line">             <span class="keyword">val</span> basicAuth =</span><br><span class="line">                 <span class="string">&quot;Basic <span class="subst">$&#123;String(Base64.encode(userCredentials.toByteArray(), Base64.DEFAULT))&#125;</span>&quot;</span></span><br><span class="line">             <span class="keyword">val</span> original = chain.request()</span><br><span class="line">             <span class="keyword">val</span> requestBuilder = original.newBuilder()</span><br><span class="line">                 .header(<span class="string">&quot;Authorization&quot;</span>, basicAuth.trim &#123; it &lt;= <span class="string">&#x27; &#x27;</span> &#125;)</span><br><span class="line">             <span class="keyword">val</span> request = requestBuilder.build()</span><br><span class="line">             <span class="keyword">return</span> chain.proceed(request)</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">     <span class="keyword">return</span> Retrofit.Builder()</span><br><span class="line">         .client(builder.build())</span><br><span class="line">         .baseUrl(BASE_URL)</span><br><span class="line">         .addConverterFactory(GsonConverterFactory.create())</span><br><span class="line">         .build()</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="ä¸‰ã€-åœ¨ViewModelä¸­ä½¿ç”¨"><a href="#ä¸‰ã€-åœ¨ViewModelä¸­ä½¿ç”¨" class="headerlink" title="ä¸‰ã€ åœ¨ViewModelä¸­ä½¿ç”¨"></a>ä¸‰ã€ åœ¨ViewModelä¸­ä½¿ç”¨</h2><code>kotlinx.coroutines.CoroutineScope</code> æ¥å£ä¸­çš„æ³¨é‡Šæœ‰è¿™ä¹ˆä¸€å¥è¯<br><br><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/30/16f561eaea6d630b~tplv-t2oaga2asx-image.image" alt="image.png"><br>æ‰€ä»¥å¯åŠ¨ä¸€ä¸ªåç¨‹ä¸€å®šéœ€è¦ä¸€ä¸ª<code>Scope</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªsuspendå‡½æ•°éƒ½æœ‰ä¸€ä¸ª<code>CoroutineScope</code>ï¼Œå¦‚æœæ²¡æœ‰ä¸€å®šä¼šæŠ¥é”™ã€‚è€ŒAndroidçš„ViewModelä¸­æœ‰æ‰©å±•äº†ä¸€ä¸ª<code>viewModelScope</code>ï¼Œå¹¶ä¸”è·Ÿ<code>lifecycle</code>ç»‘å®šäº†ï¼Œæ‰€ä»¥åœ¨ViewModelçš„onClearedæ–¹æ³•ä¸Šä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬cancelæ‰è¿™ä¸ªviewModelScopeçš„æ‰€æœ‰Jobsã€‚<br><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/30/16f561eae8114f24~tplv-t2oaga2asx-image.image" alt="å›¾1"><br>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå°è£…äº†ä¸€ä¸ªBaseViewModel<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseViewModel</span> : <span class="type">ViewModel</span></span>() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">request</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        onError: (<span class="type">error</span>: <span class="type">Throwable</span>) -&gt; <span class="type">Unit</span> = &#123;&#125;, <span class="comment">// ä¸éœ€è¦å¤„ç†Errorå¯ä»¥ä¸ä¼ </span></span></span></span><br><span class="line"><span class="params"><span class="function">        execute: <span class="type">suspend</span> <span class="type">CoroutineScope</span>.() -&gt; <span class="type">T</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        viewModelScope.launch(errorHandler &#123; onError.invoke(it) &#125;) &#123;</span><br><span class="line">            launch(Dispatchers.IO) &#123;</span><br><span class="line">                execute()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">errorHandler</span><span class="params">(onError: (<span class="type">error</span>: <span class="type">Throwable</span>) -&gt; <span class="type">Unit</span>)</span></span>: CoroutineExceptionHandler &#123;</span><br><span class="line">        <span class="keyword">return</span> CoroutineExceptionHandler &#123; _, throwable -&gt;</span><br><span class="line">            Timber.d(throwable)</span><br><span class="line">            onError.invoke(throwable)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
ä½¿ç”¨ç»§æ‰¿ <code>BaseViewModel</code> è°ƒç”¨ <code>request</code> æ–¹æ³•å³å¯ã€‚<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RepoViewModel</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> userRepo: UserDataSource,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> gitApi: GitApi</span><br><span class="line">) : BaseViewModel() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> _reposResult = BaseLiveData&lt;List&lt;RepoInfo&gt;&gt;()</span><br><span class="line">    <span class="keyword">val</span> repoResult: BaseLiveData&lt;List&lt;RepoInfo&gt;&gt;</span><br><span class="line">        <span class="keyword">get</span>() = _reposResult</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">fetchRepos</span><span class="params">(module: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        request &#123;</span><br><span class="line">            userRepo.currUser()?.let &#123;</span><br><span class="line">                <span class="keyword">val</span> result = gitApi.repos(it.nickname, module, <span class="number">1</span>)</span><br><span class="line">                _reposResult.update(result)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
OR<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">fetchRepos</span><span class="params">(module: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        request(</span><br><span class="line">            onError = &#123;</span><br><span class="line">                <span class="comment">// handle error</span></span><br><span class="line">            &#125;,</span><br><span class="line">            execute = &#123;</span><br><span class="line">                userRepo.currUser()?.let &#123;</span><br><span class="line">                    <span class="keyword">val</span> result = gitApi.repos(it.nickname, module, <span class="number">1</span>)</span><br><span class="line">                    _reposResult.update(result)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
å‰©ä¸‹çš„åŸºæœ¬æ˜¯LiveDataå’ŒFragmentä¹‹é—´çš„è®¢é˜…ä¸Šçš„é€»è¾‘å®ç°äº†ã€‚<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2>æœ€è¿‘åœ¨å­¦ä¹ ï¼Œäº†è§£ä¹Ÿä¸æ˜¯å¾ˆæ·±ï¼Œæ¬¢è¿è¯„è®ºè¡¥å……å’Œæå»ºè®®ã€‚ å­¦ä¹ é¡¹ç›®åœ°å€ <a href="https://github.com/BreakZero/Dithub">Dithub</a>ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>MVVM</tag>
      </tags>
  </entry>
  <entry>
    <title>RPC with Kotlinx Serialization</title>
    <url>/2022/06/08/RPC-with-Kotlinx-Serialization/</url>
    <content><![CDATA[<blockquote>
<p>å› ä¸ºå°†é¡¹ç›®ä»Retrofitåˆ‡æ¢åˆ°Ktorå’Œgsonåˆ‡æ¢åˆ°kotlinx serializeã€‚è€Œkotlinx serializeå’Œgsonçš„å®ç°å·®å¼‚å¯¼è‡´åœ¨rpcæ¥å£ä¸­å¯¹äºrpc è¯·æ±‚å‚æ•°ç±»å‹ä¸ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œåºåˆ—åŒ–å‡ºç°äº†å¼‚å¸¸æŠ¥é”™ï¼Œæ¯”å¦‚ç±»ä¼¼ä¸€ä¸‹çš„è¯·æ±‚Body</p>
</blockquote>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;jsonrpc&quot;</span>: <span class="string">&quot;2.0&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;method&quot;</span>: <span class="string">&quot;eth_call&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;params&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;data&quot;</span>: <span class="string">&quot;0x5ec88c7900000000000000000000000081080a7e991bcdddba8c2302a70f45d6bd369ab5&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;from&quot;</span>: <span class="string">&quot;0x81080a7e991bcDdDBA8C2302A70f45d6Bd369Ab5&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;to&quot;</span>: <span class="string">&quot;0xb3831584acb95ED9cCb0C11f677B5AD01DeaeEc0&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">&quot;latest&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="List-lt-Any-gt-Contextual"><a href="#List-lt-Any-gt-Contextual" class="headerlink" title="List&lt;Any&gt; + @Contextual"></a><code>List&lt;Any&gt;</code> + @Contextual</h3><p>æœ¬æ¥ä»¥ä¸ºåœ¨Kotlinx Serializeä¸Šä¼šåƒGsonä¸€æ ·è½»æ¾è§£å†³ï¼Œä¸€å¼€å§‹ä¾¿å¯¹äºåŸæ¥çš„æ•°æ®ç»“æ„å®šä¹‰æˆ</p>
<span id="more"></span>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Serializable</span></span><br><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">TestBaseRpc</span></span>(</span><br><span class="line">    <span class="keyword">val</span> jsonrpc: String,</span><br><span class="line">    <span class="keyword">val</span> method: String,</span><br><span class="line">    <span class="keyword">val</span> params: List&lt;<span class="meta">@Contextual</span> Any&gt;,</span><br><span class="line">    <span class="keyword">val</span> id: <span class="built_in">Int</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>å¹¶åœ¨Json é…ç½®çš„æ—¶å€™å°† Contextualé…ç½®ä¸Š</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">Json &#123;</span><br><span class="line">    useArrayPolymorphism = <span class="literal">true</span></span><br><span class="line">    prettyPrint = <span class="literal">true</span></span><br><span class="line">    allowStructuredMapKeys = <span class="literal">true</span></span><br><span class="line">    serializersModule = SerializersModule &#123;</span><br><span class="line">        contextual(Any::<span class="class"><span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            TestCaller.serializer()</span><br><span class="line">            String.serializer()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°†å•å…ƒæµ‹è¯•ä»£ç è·‘èµ·æ¥åå‘ç°ï¼Œcontextual åªä½¿ç”¨äº†æœ€åä¸€ä¸ªserializeræ¥è§£æAnyç±»å‹ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹å‘æ— æ³•å®ç°æƒ³è¦çš„ç»“æœ<br>æŠ¥é”™å¦‚ä¸‹ï¼š<p style="color:red">***.TestCaller cannot be cast to class java.lang.String</p></p>
<blockquote>
<p>Note: å¦‚æœå°†ä¸¤ä¸ªserializerè°ƒæ¢é¡ºåºå°±ä¼šå‘ç°æŠ¥é”™ä¹Ÿä¼šä¸¤ä¸ªç±»å‹äº’æ¢</p>
</blockquote>
<h3 id="é€šè¿‡-Interface-Polymorphic"><a href="#é€šè¿‡-Interface-Polymorphic" class="headerlink" title="é€šè¿‡ Interface + Polymorphic"></a>é€šè¿‡ Interface + Polymorphic</h3><p>polymorphicå¤šæ€çš„æ„æ€ï¼Œé¡¾åæ€ä¹‰ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©å¯¹åº”çš„Serializerï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªåŸºç±»(å¯ä»¥interfaceï¼Œsealedâ€¦)</p>
<ol>
<li>é¦–å…ˆå®šä¹‰ä¸€ä¸ªinterface<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="class"><span class="keyword">interface</span> <span class="title">Parameter</span></span></span><br></pre></td></tr></table></figure></li>
<li>å®šä¹‰subclass<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Serializable</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">CallParameter</span></span>(</span><br><span class="line">    <span class="keyword">val</span> <span class="keyword">data</span>: String,</span><br><span class="line">    <span class="keyword">val</span> from: String,</span><br><span class="line">    <span class="keyword">val</span> to: String</span><br><span class="line">) : Parameter</span><br><span class="line"></span><br><span class="line"><span class="meta">@Serializable</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">IntListParameter</span></span>(</span><br><span class="line">    <span class="keyword">val</span> items: List&lt;<span class="built_in">Int</span>&gt;</span><br><span class="line">) : Parameter</span><br><span class="line"></span><br><span class="line"><span class="meta">@Serializable</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">StringParameter</span></span>(</span><br><span class="line">    <span class="keyword">val</span> content: String</span><br><span class="line">) : Parameter</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li>é…ç½®Jsonæ¨¡å—<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">Json &#123;</span><br><span class="line">    useArrayPolymorphism = <span class="literal">true</span></span><br><span class="line">    prettyPrint = <span class="literal">true</span></span><br><span class="line">    ignoreUnknownKeys = <span class="literal">true</span></span><br><span class="line">    allowStructuredMapKeys = <span class="literal">true</span></span><br><span class="line">    serializersModule = SerializersModule &#123;</span><br><span class="line">        polymorphic(List::<span class="class"><span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            ListSerializer(ParameterSerialize)</span><br><span class="line">        &#125;</span><br><span class="line">        polymorphic(Parameter::<span class="class"><span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            subclass(CallParameter::<span class="class"><span class="keyword">class</span>, <span class="type">CallParameter.serializer</span></span>())</span><br><span class="line">            subclass(StringParameter::<span class="class"><span class="keyword">class</span>, <span class="type">StringParameterSerializer)</span></span></span><br><span class="line">            subclass(IntListParameter::<span class="class"><span class="keyword">class</span>, <span class="type">IntListParameterSerializer)</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>é’ˆå¯¹ä¸åŒç»“æ„å®šä¹‰ä¸åŒçš„Serializer<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> IntListParameterSerializer : KSerializer&lt;IntListParameter&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">deserialize</span><span class="params">(decoder: <span class="type">Decoder</span>)</span></span>: IntListParameter &#123;</span><br><span class="line">        <span class="keyword">return</span> decoder.decodeStructure(descriptor) &#123;</span><br><span class="line">            <span class="keyword">val</span> items = decodeSerializableElement(descriptor, <span class="number">0</span>, ListSerializer(<span class="built_in">Int</span>.serializer()))</span><br><span class="line">            IntListParameter(</span><br><span class="line">                items = items</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> descriptor: SerialDescriptor</span><br><span class="line">        <span class="keyword">get</span>() = buildClassSerialDescriptor(<span class="string">&quot;IntListParameter&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.element&lt;List&lt;<span class="built_in">Int</span>&gt;&gt;(<span class="string">&quot;items&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">serialize</span><span class="params">(encoder: <span class="type">Encoder</span>, value: <span class="type">IntListParameter</span>)</span></span> &#123;</span><br><span class="line">        encoder.encodeSerializableValue(ListSerializer(<span class="built_in">Int</span>.serializer()), value.items)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@OptIn(ExperimentalSerializationApi::class)</span></span><br><span class="line"><span class="meta">@Serializer(forClass = BaseRpcRequest::class)</span></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> RpcRequestBodySerializer : KSerializer&lt;BaseRpcRequest&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">deserialize</span><span class="params">(decoder: <span class="type">Decoder</span>)</span></span>: BaseRpcRequest &#123;</span><br><span class="line">        <span class="keyword">return</span> decoder.decodeStructure(descriptor) &#123;</span><br><span class="line">            <span class="keyword">var</span> rpc: String? = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">var</span> method: String? = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">var</span> params: List&lt;Parameter&gt; = emptyList()</span><br><span class="line">            <span class="keyword">var</span> id: <span class="built_in">Int</span>? = <span class="literal">null</span></span><br><span class="line">            <span class="symbol">loop@</span> <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">when</span> (decodeElementIndex(descriptor)) &#123;</span><br><span class="line">                    CompositeDecoder.DECODE_DONE -&gt; <span class="keyword">break</span><span class="symbol">@loop</span></span><br><span class="line"></span><br><span class="line">                    <span class="number">0</span> -&gt; rpc = decodeStringElement(descriptor, <span class="number">0</span>)</span><br><span class="line">                    <span class="number">1</span> -&gt; method = decodeStringElement(descriptor, <span class="number">1</span>)</span><br><span class="line">                    <span class="number">2</span> -&gt; params = decodeSerializableElement(descriptor, <span class="number">2</span>, ListSerializer(ParameterSerialize))</span><br><span class="line">                    <span class="number">3</span> -&gt; id = decodeIntElement(descriptor, <span class="number">3</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            BaseRpcRequest(</span><br><span class="line">                jsonrpc = rpc.orEmpty(),</span><br><span class="line">                method = method.orEmpty(),</span><br><span class="line">                params = params,</span><br><span class="line">                id = id ?: <span class="number">1</span></span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="keyword">val</span> descriptor: SerialDescriptor</span><br><span class="line">        <span class="keyword">get</span>() = buildClassSerialDescriptor(<span class="string">&quot;BaseRpcRequest&quot;</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.element&lt;String&gt;(<span class="string">&quot;jsonrpc&quot;</span>)</span><br><span class="line">            <span class="keyword">this</span>.element&lt;String&gt;(<span class="string">&quot;method&quot;</span>)</span><br><span class="line">            <span class="keyword">this</span>.element&lt;List&lt;Parameter&gt;&gt;(<span class="string">&quot;params&quot;</span>)</span><br><span class="line">            <span class="keyword">this</span>.element&lt;<span class="built_in">Int</span>&gt;(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">serialize</span><span class="params">(encoder: <span class="type">Encoder</span>, value: <span class="type">BaseRpcRequest</span>)</span></span> &#123;</span><br><span class="line">        encoder.encodeStructure(descriptor) &#123;</span><br><span class="line">            encodeStringElement(descriptor, <span class="number">0</span>, value.jsonrpc)</span><br><span class="line">            encodeStringElement(descriptor, <span class="number">1</span>, value.method)</span><br><span class="line">            encodeSerializableElement(descriptor, <span class="number">2</span>, ListSerializer(ParameterSerialize), value.params)</span><br><span class="line">            encodeIntElement(descriptor, <span class="number">3</span>, value.id)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure></li>
<li>å¦‚æœéœ€è¦deserializeï¼Œä¾¿éœ€è¦åŠ ä¸Šå¦‚ä¸‹é€‰æ‹©å™¨<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">internal</span> <span class="keyword">object</span> ParameterSerialize : JsonContentPolymorphicSerializer&lt;Parameter&gt;(Parameter::<span class="class"><span class="keyword">class</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">selectDeserializer</span><span class="params">(element: <span class="type">JsonElement</span>)</span></span>: DeserializationStrategy&lt;<span class="keyword">out</span> Parameter&gt; &#123;</span><br><span class="line">        println(<span class="string">&quot;element: <span class="variable">$element</span>, obj: <span class="subst">$&#123;element.jsonObject&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// override the condition for your point</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> &#123;</span><br><span class="line">            <span class="string">&quot;content&quot;</span> <span class="keyword">in</span> element.jsonObject -&gt; StringParameterSerializer</span><br><span class="line">            <span class="string">&quot;items&quot;</span> <span class="keyword">in</span> element.jsonObject -&gt; IntListParameterSerializer</span><br><span class="line">            <span class="keyword">else</span> -&gt; CallParameter.serializer()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
è¿è¡Œå•å…ƒæµ‹è¯•ï¼ŒéªŒè¯é€šè¿‡ï¼š<br><img src="/images/pic1.png" alt="Unit Test Result!" title="Unit Test Result"></li>
</ol>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åªæ˜¯ä¸ºäº†åœ¨é¡¹ç›®ä¸­å‡å°‘gsonçš„ä½¿ç”¨ï¼Œæ‰€ä»¥èŠ±äº†ç‚¹æ—¶é—´éªŒè¯ä¸‹å…·ä½“æƒ…å†µï¼Œä½†æ˜¯ï¼š<br>è™½ç„¶ç›®å‰çœ‹èµ·æ¥æ˜¯è§£å†³äº†é—®é¢˜ï¼Œä¸è¿‡ç›¸å¯¹æ¥è¯´æ¯”è¾ƒéº»çƒ¦ï¼Œå¹¶ä¸”å¦‚æœç±»å‹è¶Šæ¥è¶Šå¤šä¹Ÿä¼šå¢åŠ ä¸å¿…è¦çš„å·¥ä½œé‡ï¼Œæ‰€ä»¥è¿™é‡Œæ›´å»ºè®®ç›´æ¥ä½¿ç”¨gson</p>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>Kotlin Serialization</tag>
      </tags>
  </entry>
  <entry>
    <title>EasyWallet Gradle Clean Up</title>
    <url>/2021/09/11/EasyWallet-Part-1/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul>
<li>è®°å½•å¹¶æ•´ç†EasyWallet å°é’±åŒ…å¼€å‘è¿‡ç¨‹</li>
<li>åœ¨é¡¹ç›®ä¸­ä½¿ç”¨åˆ°ï¼š</li>
</ul>
<ol>
<li>Composing build + plugin å®ç°ä¾èµ–åº“ç»Ÿä¸€ç®¡ç†</li>
<li>Jetpack Compose</li>
<li>Hilt ä¾èµ–æ³¨å…¥</li>
<li>Kotlin/Kotlin flow/Coroutine</li>
<li>Ktor å®ç°ç½‘ç»œè¯·æ±‚</li>
<li>Room å®ç°æœ¬åœ°å­˜å‚¨</li>
</ol>
<ul>
<li>æœ¬é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/BreakZero/EasyWallet-Mobile-Compose">EasyWallet-Compose</a></li>
</ul>
<h2 id="gradle-è„šæœ¬ç®¡ç†"><a href="#gradle-è„šæœ¬ç®¡ç†" class="headerlink" title="gradle è„šæœ¬ç®¡ç†"></a>gradle è„šæœ¬ç®¡ç†</h2><ul>
<li>åˆ›å»ºæ–°çš„æ¨¡å—ä½œä¸ºComposing buildï¼Œå¹¶åœ¨ <code>build.gradle.kts</code> ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç å®ç°pluginé…ç½®<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">gradlePlugin &#123;</span><br><span class="line">    plugins &#123;</span><br><span class="line">        create(&quot;VersionPlugin&quot;) &#123;</span><br><span class="line">            id = &quot;version-plugin&quot; // change the name you like</span><br><span class="line">            implementationClass = &quot;com.easy.version.DependencyVersionPlugin&quot; // change package to what you done</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>åœ¨ <code>src.main.kotlin</code> ç›®å½•ä¸‹Pluginå®ç°ç±»å®ç°æ¥å£ <code>Plugin&lt;Project&gt;</code>ï¼Œè¿™ä¸ªplugin çš„apply æ–¹æ³•ä¼šåœ¨ä»»ä½•ä½ ä½¿ç”¨è¿™ä¸ªpluginçš„module æ‰§è¡Œ  <span id="more"></span></li>
<li>ç»Ÿä¸€ç®¡ç†Configsã€‚ ï¼ˆè¿™é‡Œæˆ‘ä¸ºäº†åŒºåˆ†featureæ¨¡å—å’Œappæ¨¡å—ï¼Œæ‰€ä»¥åŠ äº†ignore listï¼‰<ol>
<li>é¦–å…ˆæˆ‘ä»¬åœ¨æ¯ä¸ªæ¨¡å—éƒ½éœ€è¦çš„pluginï¼Œå†™ä¸€ä¸ªProjectçš„æ‰©å±•å‡½æ•°<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">private fun Project.applyPlugin() &#123;</span><br><span class="line">    apply(plugin = &quot;com.android.library&quot;)</span><br><span class="line">    apply(plugin = &quot;kotlin-android&quot;)</span><br><span class="line">    apply(plugin = &quot;kotlin-kapt&quot;)</span><br><span class="line">    apply(plugin = &quot;kotlin-parcelize&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
ç„¶ååœ¨applyæ–¹æ³•ä¸­ä½¿ç”¨<br><code>target.beforeEvaluate &#123; applyPlugin() &#125;</code><br>è¿™é‡Œæ³¨æ„è¦åŠ ä¸ŠbeforeEvaluateï¼Œåœ¨æ‰§è¡Œå‰apply plugin</li>
<li>é…ç½® android å—<br>å¢åŠ æ‰©å±•æ–¹æ³• <code>LibraryExtension.moduleConfig(isCore: Boolean)</code> (isCoreè¿™é‡Œç®—æ˜¯æˆ‘é¡¹ç›®çš„ç‰¹æ®Šæ”¯æŒï¼Œä¸ºäº†å®ç°buildConfigFieldçš„)<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">@Suppress(&quot;UnstableApiUsage&quot;)</span><br><span class="line">private fun LibraryExtension.moduleConfig(isCore: Boolean) &#123;</span><br><span class="line">    compileSdk = BuildConfig.compileSdkVersion</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        minSdk = BuildConfig.minSdkVersion</span><br><span class="line">        targetSdk = BuildConfig.targetSdkVersion</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    compileOptions &#123;</span><br><span class="line">        sourceCompatibility = JavaVersion.VERSION_11</span><br><span class="line">        targetCompatibility = JavaVersion.VERSION_11</span><br><span class="line">    &#125;</span><br><span class="line">    buildFeatures.also &#123;</span><br><span class="line">        it.compose = true</span><br><span class="line">    &#125;</span><br><span class="line">    composeOptions &#123;</span><br><span class="line">        kotlinCompilerExtensionVersion = Compose.version</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
</li>
<li>æœ€ååœ¨root projectä¸­å¢åŠ   <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">subprojects &#123;</span><br><span class="line">    apply(plugin = &quot;version-plugin&quot;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
  ç»™æ¯ä¸ªæ¨¡å—éƒ½åº”ç”¨ä¸Špluginï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å•ç‹¬åœ¨moduleä¸Šç›´æ¥åº”ç”¨</li>
<li>ä»¥ä¸Šé…ç½®å®Œæˆåï¼Œä½ ä¼šçœ‹åˆ°æ¨¡å—çš„ gradle è„šæœ¬åŸºæœ¬å°±å¾ˆå°‘äº†ï¼Œ å¦‚ä¸‹  <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import com.easy.version.*</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation(project(&quot;:core&quot;))</span><br><span class="line">    implementation(project(&quot;:core-ui&quot;))</span><br><span class="line"></span><br><span class="line">    implementation(com.easy.version.dependencies.Other.sqlcipher)</span><br><span class="line"></span><br><span class="line">    roomDependencies()</span><br><span class="line">    composeUI()</span><br><span class="line">    hiltDependencies()</span><br><span class="line">    unitTestDependencies()</span><br><span class="line">    androidTestDependencies()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>å¦‚æ­¤é…ç½®ä¹‹åï¼Œ æ¯æ–°å¢ä¸€ä¸ªå­æ¨¡å—ï¼Œéƒ½èƒ½ç»Ÿä¸€å¿«é€Ÿçš„é…ç½®gradle</li>
</ul>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æ¨¡å—åˆ†ç¦»ã€Navigationç®¡ç†â€¦</p>
]]></content>
      <categories>
        <category>Gradle</category>
      </categories>
      <tags>
        <tag>Gradle</tag>
      </tags>
  </entry>
  <entry>
    <title>Composeçš„é‡ç»„ä½œç”¨åŸŸ</title>
    <url>/2023/07/06/Scoped-recomposition-in-Jetpack-Compose/</url>
    <content><![CDATA[<p>åœ¨äº†è§£Composeçš„é‡ç»„ä½œç”¨åŸŸä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹é‡ç»„æ˜¯ä»€ä¹ˆ</p>
<h3 id="ä»€ä¹ˆæ˜¯é‡ç»„"><a href="#ä»€ä¹ˆæ˜¯é‡ç»„" class="headerlink" title="ä»€ä¹ˆæ˜¯é‡ç»„"></a>ä»€ä¹ˆæ˜¯é‡ç»„</h3><p>å¯¹äºJetpack Composeï¼Œå³ä½¿æ˜¯åˆå­¦è€…ä¹Ÿéƒ½çŸ¥é“å®ƒè¢«ç§°ä¸ºå£°æ˜å¼UIå¼€å‘ï¼Œç›¸å¯¹äºä¹‹å‰é€šè¿‡xmlæ–¹å¼çš„å‘½ä»¤å¼UIã€‚è€Œåœ¨å‘½ä»¤å¼UIæ¨¡å¼ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦æ›´æ–°ä¸€ä¸ªwidgetï¼Œæˆ‘ä»¬éœ€è¦æ‹¿åˆ°è¿™ä¸ªwidgeté€šè¿‡è°ƒç”¨å…¶setterå‡½æ•°æ¥æ”¹å˜å…¶å†…éƒ¨çŠ¶æ€ã€‚ä½†æ˜¯Jetpack Composeä¸­çš„widgetç›¸å¯¹æ— çŠ¶æ€å¹¶ä¸æä¾›setter/getterå‡½æ•°ï¼Œè€Œæ˜¯é‡æ–°è°ƒç”¨å¯ç»„åˆå‡½æ•°æ¥å®ç°æ›´æ–°ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«é‡ç»„ã€‚ç›®å‰Jetpack Composeé‡ç»„æ˜¯åœ¨UIçº¿ç¨‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥é‡ç»„è¿‡ç¨‹æ˜¯æœ‰æ€§èƒ½æ¶ˆè€—çš„ã€‚ä¸ºæ­¤ï¼ŒComposeç¼–è¯‘å™¨å†…éƒ¨åšäº†å¤§é‡å·¥ä½œä¿è¯é‡ç»„çš„èŒƒå›´å°½å¯èƒ½å°æ¥æå‡é‡ç»„æ•ˆç‡ã€‚</p>
<h3 id="é‡ç»„èŒƒå›´"><a href="#é‡ç»„èŒƒå›´" class="headerlink" title="é‡ç»„èŒƒå›´"></a>é‡ç»„èŒƒå›´</h3><p>é‡ç»„èŒƒå›´åœ¨Composeä¸­æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç»„æˆéƒ¨ä»½ï¼Œé€šè¿‡å°½é‡ç¼©å°é‡ç»„èŒƒå›´æ¥å‡å°‘Composeåœ¨å‡†å¤‡æ¯ä¸€å¸§æ—¶çš„å·¥ä½œé‡ã€‚</p>
<ul>
<li>å®ƒä»¬æ˜¯é€šè¿‡é‡ç»„æ›´æ–°ComposeèŠ‚ç‚¹çš„æœ€å°å•ä½</li>
<li>å®ƒä»¬é€šè¿‡è·Ÿè¸ªè§‚å¯ŸåŸºäºå¿«ç…§çš„çŠ¶æ€å¯¹è±¡ï¼Œå¹¶åœ¨è¿™äº›çŠ¶æ€å˜åŒ–æ—¶ä¼šæ— æ•ˆ<span id="more"></span>
å¯¹äºæ¯ä¸ª<code>non-inline</code>å¹¶ä¸”è¿”å›<code>Unit</code>çš„å¯ç»„åˆå‡½æ•°ï¼Œ Composeç¼–è¯‘å™¨ä¼šç”Ÿæˆä»£ç å°†è¿™ä¸ªå‡½æ•°åŒ…è£…åˆ°ä¸€ä¸ªå¯é‡ç»„å—ä¸­ï¼Œå½“è¿™ä¸ªä»£ç å—è¢«æ ‡è®°ä¸ºInvalidatedæ—¶ï¼ŒCompose Runtimeå°†ç¡®ä¿åœ¨æ¸²æŸ“ä¸‹ä¸€å¸§ä¹‹å‰è¯¥ä»£ç å—è¢«é‡æ–°æ‰§è¡Œï¼ˆé‡ç»„ï¼‰ã€‚<br>PS: <p style="color:red">æ˜¯æ€æ ·è¢«æ ‡è®°ä¸ºInvalidatedï¼Œè¿™å—å…³ç³»åˆ°State/Snapshotæš‚æ—¶ä¸å±•å¼€ï¼Œåæ­£å…ˆè®°ä½ï¼Œä¸ä¾èµ–Stateçš„ä»£ç æ˜¯ä¸å‚ä¸é‡ç»„çš„ã€‚</p></li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—"><a href="#ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—" class="headerlink" title="ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—"></a>ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—</h3><p>inlineå‡½æ•°ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šç›´æ¥å°†å‡½æ•°ä½“æ‹·è´åˆ°è°ƒç”¨å¤„ï¼Œæ‰€ä»¥å®ƒåªèƒ½å…±äº«è°ƒç”¨è€…çš„é‡ç»„èŒƒå›´<br>å¯¹äºæœ‰è¿”å›å€¼çš„å‡½æ•°ï¼Œç”±äºè¿”å›å€¼çš„å˜åŒ–ä¼šå½±å“è°ƒç”¨è€…ï¼Œå› æ­¤æ— æ³•å•ç‹¬é‡ç»„ï¼Œè€Œå¿…é¡»è¿åŒè°ƒç”¨æ–¹ä¸€åŒå‚ä¸é‡ç»„ï¼Œå› æ­¤å®ƒä¸èƒ½ä½œä¸ºå…¥å£è¢«æ ‡è®°ä¸ºinvalid</p>
<h3 id="è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨"><a href="#è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨" class="headerlink" title="è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨"></a>è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨</h3><p>åœ¨æ·±å…¥äº†è§£æœ€å°é‡ç»„èŒƒå›´å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸ªå…³äºå¸¸è§„æ—§å‡½æ•°è°ƒç”¨å¦‚ä½•å·¥ä½œçš„åŸºæœ¬æ¦‚å¿µã€‚åœ¨Java/Kotlinä¸­ï¼Œå½“ä½ å°†è¡¨è¾¾å¼ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œè¯¥è¡¨è¾¾å¼ä¼šåœ¨è°ƒç”¨å‡½æ•°ä¸­è®¡ç®—ã€‚</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line">println(<span class="string">&quot;hello&quot;</span> + <span class="string">&quot;world&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>å®ƒç­‰ä»·äº</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="keyword">val</span> arg = <span class="string">&quot;hello&quot;</span> + <span class="string">&quot;world&quot;</span></span><br><span class="line">println(arg)</span><br></pre></td></tr></table></figure>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå…ˆæ‰§è¡Œè¡¨è¾¾å¼å¾—åˆ°ç»“æœï¼Œåœ¨æ‰§è¡Œå‡½æ•°è°ƒç”¨</p>
<h3 id="ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ"><a href="#ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ" class="headerlink" title="ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ"></a>ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ</h3><p>å¤§è‡´äº†è§£äº†è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨åï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­è¿‡ä¸€ä¸‹ï¼Œå…ˆçœ‹ä¸‹é¢çš„ä»£ç å—</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Composable</span> <span class="function"><span class="keyword">fun</span> <span class="title">Foo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> text <span class="keyword">by</span> remember &#123; mutableStateOf(<span class="string">&quot;&quot;</span>) &#125;</span><br><span class="line">    println(<span class="string">&quot;TAG: Foo Scope&quot;</span>)</span><br><span class="line">    Button(onClick = &#123; text = <span class="string">&quot;<span class="variable">$text</span>\n<span class="variable">$text</span>&quot;</span> &#125;) &#123;</span><br><span class="line">        println(<span class="string">&quot;TAG: Button lambda Scope&quot;</span>)</span><br><span class="line">        Text(text).also &#123;</span><br><span class="line">            println(<span class="string">&quot;TAG: Text Scope&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1-ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„"><a href="#1-ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„" class="headerlink" title="1. ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„"></a>1. ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„</h4><p>ç‚¹å‡»Buttonæ—¶ï¼ŒState <code>text</code> è¢«é‡æ–°å¤åˆ¶è€Œæ”¹å˜ï¼Œè€ŒState <code>text</code>åªæœ‰Textè®¿é—®åˆ°ï¼Œä¸ºä»€ä¹ˆé‡ç»„èŒƒå›´ä¸æ˜¯åªæœ‰Textï¼Ÿ<br>ä»ä¸Šé¢ä»£ç å—çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“textå…¶å®æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè€ŒTextåˆ™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥textè®¡ç®—ç»“æœæ˜¯åœ¨è°ƒç”¨Textä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯Buttonçš„lambda</p>
<h4 id="2-ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„"><a href="#2-ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„" class="headerlink" title="2. ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„"></a>2. ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„</h4><p>æˆ‘ä»¬çŸ¥é“å½“Stateå‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šå‘ç”Ÿé‡ç»„ï¼Œè€ŒFooä¸­æ²¡æœ‰è®¿é—®ä»»ä½•Stateå¯¹è±¡ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå‘ç”Ÿé‡ç»„ã€‚è®©æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç çœ‹çœ‹ï¼Œå°†<code>by</code>æ”¹æˆ<code>=</code>ï¼Œé€»è¾‘å°±æ¸…æ™°äº†</p>
<figure class="highlight kotlin"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Composable</span> <span class="function"><span class="keyword">fun</span> <span class="title">Foo</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> text: MutableState&lt;String&gt; = remember &#123; mutableStateOf(<span class="string">&quot;&quot;</span>) &#125;</span><br><span class="line">    println(<span class="string">&quot;TAG: Foo Scope&quot;</span>)</span><br><span class="line">    Button(onClick = &#123; text.value = <span class="string">&quot;<span class="subst">$&#123;text.value&#125;</span>\n<span class="subst">$&#123;text.value&#125;</span>&quot;</span> &#125;) &#123;</span><br><span class="line">        println(<span class="string">&quot;TAG: Button lambada Scope&quot;</span>)</span><br><span class="line">        Text(text.value).also &#123;</span><br><span class="line">            println(<span class="string">&quot;TAG: Text Scope&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ˜¾è€Œæ˜“è§ï¼Œtextä¸€ç›´éƒ½æ˜¯åŒä¸€ä¸ªMutableStateå¯¹è±¡ï¼Œä¿®æ”¹çš„åªä¸è¿‡æ˜¯å®ƒå†…éƒ¨æŒæœ‰çš„valueï¼Œè€Œvalueåœ¨Textä¸­è®¿é—®</p>
<h4 id="3-ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„"><a href="#3-ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„" class="headerlink" title="3. ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„"></a>3. ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„</h4><p>å› ä¸º<code>Foo</code>æ²¡å‘ç”Ÿé‡ç»„ï¼Œæ‰€ä»¥é‡ç»„æ—¶å¹¶ä¸ä¼šè°ƒç”¨Buttonå‡½æ•°</p>
<h4 id="4-onClick-lambadaè¡¨è¾¾å¼å‘¢"><a href="#4-onClick-lambadaè¡¨è¾¾å¼å‘¢" class="headerlink" title="4. onClick lambadaè¡¨è¾¾å¼å‘¢"></a>4. onClick lambadaè¡¨è¾¾å¼å‘¢</h4><p>é‡ç»„èŒƒå›´åªèƒ½æ˜¯åœ¨å¯é‡ç»„å‡½æ•°ä¸­ï¼Œå³ä½¿handlersï¼Œ<code>Button</code>çš„<code>onClick</code>éƒ½ä¸æ˜¯å¯é‡ç»„å‡½æ•°ã€‚æ‰€ä»¥è¿™ç§å‡½æ•°ä¸åœ¨é‡ç»„èŒƒå›´å†…ã€‚</p>
<h3 id="é‡ç»„ä¸­-Inline-çš„å‘"><a href="#é‡ç»„ä¸­-Inline-çš„å‘" class="headerlink" title="é‡ç»„ä¸­ Inline çš„å‘"></a>é‡ç»„ä¸­ Inline çš„å‘</h3><p>å‰é¢ä¹Ÿæåˆ°äº†ï¼Œinlineå‡½æ•°æ˜¯å°†ä»£ç æ‹·è´ï¼Œæ‰€ä»¥å…±äº«è°ƒç”¨è€…çš„é‡ç»„èŒƒå›´ã€‚åœ¨Composeä¸­å¾ˆå¤šå¸¸è§çš„widgetè¢«ä¿®é¥°æˆinlineå‡½æ•°çš„ï¼Œæ¯”å¦‚<code>Column</code>,<code>Row</code>,<code>Box</code>ç­‰ã€‚</p>
<p>åŸæ–‡åœ°å€ï¼š<a href="https://dev.to/zachklipp/scoped-recomposition-jetpack-compose-what-happens-when-state-changes-l78">Scoped recomposition in Jetpack Compose â€” what happens when state changes?</a></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Jetpack Compose</tag>
        <tag>Android</tag>
      </tags>
  </entry>
</search>
