<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>æµ…è°ˆJetpack Compose LaunchedEffect</title>
    <url>/2023/07/04/A-brief-of-Jetpack-Compose-LaunchedEffect/</url>
    <content><![CDATA[<p>åœ¨Jetpack Compose ä»£ç ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸çœ‹åˆ°<code>LaunchedEffect</code>è¿™ä¸ªå¸¸è§çš„ã€‚ä»Šå¤©å°±ç®€å•äº†è§£ä¸‹è¿™ä¸ªæ–¹æ³•å§ã€‚åœ¨è¯´<code>LaunchedEffect</code>å‰ï¼Œè®©æˆ‘ä»¬å…ˆè¯´ä¸€ä¸‹<code>Side Effect</code>.</p>
<h3 id="ä»€ä¹ˆæ˜¯Side-Effect"><a href="#ä»€ä¹ˆæ˜¯Side-Effect" class="headerlink" title="ä»€ä¹ˆæ˜¯Side Effect"></a>ä»€ä¹ˆæ˜¯Side Effect</h3><p>åœ¨ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œ<code>Side-Effect</code>æŒ‡çš„æ˜¯è°ƒç”¨å‡½æ•°æ—¶ï¼Œé™¤äº†è¿”å›å¯èƒ½çš„å‡½æ•°å€¼å¤–ï¼Œè¯¥å‡½æ•°è¿˜å¯¹å‡½æ•°èŒƒå›´å¤–çš„å˜é‡ï¼Œå‚æ•°ç­‰è¿›è¡Œäº†ä¿®æ”¹ã€‚<br>ä¸¾ä¸ªğŸŒ°ï¼Œçœ‹ä¸‹é¢çš„å‡½æ•°ï¼Œå®ƒæœ‰2ä¸ªå‚æ•°ï¼Œè¿”å›å®ƒä»¬çš„å’Œï¼Œä½†æ˜¯æ²¡æœ‰å¯¹ä»»ä½•å…¶ä»–å˜é‡æœ‰ä¿®æ”¹ï¼Œæ‰€ä»¥å®ƒæ˜¯æ²¡æœ‰å‰¯ä½œç”¨(No Side-Effect)çš„</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">sum</span><span class="token punctuation">(</span>number1<span class="token operator">:</span> Int<span class="token punctuation">,</span> number2<span class="token operator">:</span> Int<span class="token punctuation">)</span> <span class="token operator">=</span> number1 <span class="token operator">+</span> number2<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>ä½†å¦‚æœæˆ‘ä»¬å°†å‡½æ•°ä¿®æ”¹æˆä¸‹é¢çš„å®ç°ï¼Œæ¯æ¬¡è°ƒç”¨è¯¥å‡½æ•°éƒ½ä¼šå¯¹sumé‡æ–°èµ‹å€¼ï¼Œè€Œsumåˆæ˜¯åœ¨å‡½æ•°èŒƒå›´å¤–ï¼Œæ‰€ä»¥è®¤ä¸ºè¿™ä¸ªå‡½æ•°æœ‰ä¸€ä¸ªå‰¯ä½œç”¨</p>
<pre class="line-numbers language-Kotlin" data-language="Kotlin"><code class="language-Kotlin">var sum &#x3D; 0
fun sum(number1: Int, number2: Int) &#123;
    sum &#x3D; number1 + number2
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="åœ¨Jetpack-Compose-ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect"><a href="#åœ¨Jetpack-Compose-ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect" class="headerlink" title="åœ¨Jetpack Compose ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect"></a>åœ¨Jetpack Compose ä¸­ï¼Œä»€ä¹ˆæ˜¯LaunchedEffect</h3><p>æ ¹æ®æºç æˆ‘ä»¬çœ‹åˆ°ï¼Œ<code>LaunchedEffect</code>æ˜¯ä¸€ä¸ªå¸¦æœ‰<code>@Composable</code>çš„å‡½æ•°ï¼Œæ³¨é‡Šå¦‚ä¸‹</p>
<span id="more"></span>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">When LaunchedEffect enters the composition it will launch block into the composition's CoroutineContext<span class="token punctuation">.</span> The coroutine will be cancelled <span class="token operator">and</span> re<span class="token operator">-</span>launched <span class="token keyword">when</span> LaunchedEffect <span class="token keyword">is</span> recomposed with a different key1 <span class="token operator">or</span> key2<span class="token punctuation">.</span> The coroutine will be cancelled <span class="token keyword">when</span> the LaunchedEffect leaves the composition<span class="token punctuation">.</span>
This function should not be used <span class="token keyword">to</span> <span class="token punctuation">(</span>re<span class="token operator">-</span><span class="token punctuation">)</span>launch ongoing tasks <span class="token keyword">in</span> response <span class="token keyword">to</span> callback events <span class="token keyword">by</span> way of storing callback <span class="token keyword">data</span> <span class="token keyword">in</span> MutableState passed <span class="token keyword">to</span> key<span class="token punctuation">.</span> Instead<span class="token punctuation">,</span> see rememberCoroutineScope <span class="token keyword">to</span> obtain a CoroutineScope that may be used <span class="token keyword">to</span> launch ongoing jobs scoped <span class="token keyword">to</span> the composition <span class="token keyword">in</span> response <span class="token keyword">to</span> event callbacks<span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç®€å•æ¥è¯´ï¼Œ<code>LaunchedEffect</code>æ˜¯ä¸€ä¸ªå¯åœ¨å½“å‰å¯ç»„åˆé¡¹çš„ä½œç”¨åŸŸå†…è¿è¡ŒæŒ‚èµ·å‡½æ•°(blockæ˜¯suspendçš„)çš„å¯ç»„åˆå‡½æ•°ã€‚<br>åœ¨<a href="https://developer.android.com/jetpack/compose/mental-model">Thinking in Compose</a>ä¸­ï¼Œæˆ‘ä»¬äº†è§£åˆ°ä¸€ä¸ªå¯ç»„åˆé¡¹åº”è¯¥æ˜¯æ²¡æœ‰å‰¯ä½œç”¨çš„ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨å¯ç»„åˆé¡¹ä¸­ä¿®æ”¹åº”ç”¨çŠ¶æ€ï¼Œéœ€è¦é€šè¿‡Effect APIå¯åŠ¨åç¨‹æ“ä½œï¼Œæ‰€ä»¥å¯ä»¥è¯´<code>LaunchedEffect</code>åœ¨Jetpack Composeä¸­æä¾›äº†åœ¨å¯ç»„åˆé¡¹ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°çš„èƒ½åŠ›ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬é€šè¿‡ä¸€ä¸ªä¾‹å­ç®€å•äº†è§£ä¸‹ï¼Œ è¿™ä¸ªä¾‹å­æ˜¯ä¸€ä¸ªTodoTaskä¸‹çš„ä¸€ä¸ªå°åŠŸèƒ½ï¼Œæ ¹æ®é€‰æ‹©çš„ç±»åˆ«å±•ç¤ºå½“å‰ç±»åˆ«çš„æ‰€æœ‰Taskã€‚<br>ç®€å•çš„å‡†å¤‡mock tasksï¼Œä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">TodoTask</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> id<span class="token operator">:</span> Long<span class="token punctuation">,</span>
    <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> description<span class="token operator">:</span> String
<span class="token punctuation">)</span>

<span class="token comment">// mock tasks respose</span>
<span class="token keyword">val</span> mockTasks <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">..</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span> <span class="token punctuation">&#123;</span>
    <span class="token function">TodoTask</span><span class="token punctuation">(</span>
        id <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">toLong</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        name <span class="token operator">=</span> <span class="token string">"task name <span class="token interpolation variable">$it</span>"</span><span class="token punctuation">,</span>
        description <span class="token operator">=</span> <span class="token string">"task description <span class="token interpolation variable">$it</span>"</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">// mock get tasks from api, delay 2 seconds</span>
<span class="token keyword">private</span> <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">getTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>TodoTask<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token function">delay</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> mockTasks
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>åœ¨TodoListOfCategoryScreenä¸»è¦æ˜¯ä¸€ä¸ªLazy Columnç”¨æ¥å±•ç¤ºä»»åŠ¡åç§°çš„ï¼Œå…¶ä¸­å‚æ•°æ˜¯Category</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Composable</span>
<span class="token keyword">fun</span> <span class="token function">TodoListOfCategoryScreen</span><span class="token punctuation">(</span>
    category<span class="token operator">:</span> String
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TASK TAG: out of column scope"</span><span class="token punctuation">)</span>
    <span class="token keyword">var</span> tasks <span class="token keyword">by</span> remember <span class="token punctuation">&#123;</span>
        <span class="token function">mutableStateOf</span><span class="token punctuation">(</span>emptyList<span class="token operator">&lt;</span>TodoTask<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
    <span class="token function">Column</span><span class="token punctuation">(</span>
        modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TASK TAG: TodoListScreen: <span class="token interpolation"><span class="token delimiter variable">$&#123;</span>tasks<span class="token punctuation">.</span>size<span class="token delimiter variable">&#125;</span></span>, category: <span class="token interpolation variable">$category</span>"</span><span class="token punctuation">)</span>

        <span class="token function">LaunchedEffect</span><span class="token punctuation">(</span>key1 <span class="token operator">=</span> category<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            tasks <span class="token operator">=</span> <span class="token function">getTasks</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TASK TAG: get tasks from api, category: <span class="token interpolation variable">$category</span>"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">LazyColumn</span><span class="token punctuation">(</span>
            modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">items</span><span class="token punctuation">(</span>tasks<span class="token punctuation">,</span> key <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                it<span class="token punctuation">.</span>id
            <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">Text</span><span class="token punctuation">(</span>modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> text <span class="token operator">=</span> it<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é¦–å…ˆæˆ‘ä»¬çš„categoryæ˜¯å›ºå®šçš„ï¼Œåœ¨getTasksä¹‹åï¼Œä¿®æ”¹äº†taskså¯¼è‡´Columnå‘ç”Ÿé‡ç»„ï¼Œæ‰€ä»¥scopeç›¸å…³çš„æ—¥å¿—æ‰“å°äº†2æ¬¡ã€‚è€Œæ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚çš„<code>LaunchedEffect</code>å†…åªè°ƒç”¨äº†ä¸€æ¬¡ï¼Œæ˜¯å› ä¸º<code>LaunchedEffect</code>çš„è°ƒç”¨æ—¶æœŸåªæœ‰è¿›å…¥é‡ç»„é¡¹æˆ–è€…Keyå˜åŒ–é‡ç»„ï¼Œå¦‚æœæ˜¯æ™®é€šçš„å¯åŠ¨åç¨‹ï¼Œåœ¨é‡ç»„æ—¶ï¼Œä¼šå¯¼è‡´å¤šæ¬¡è°ƒç”¨apiè¯·æ±‚ã€‚<br><img src="/images/codes/launched_effect_1.jpg" alt="Logcat" title="launched_effect"></p>
<blockquote>
<p>PS: è¿™é‡Œä¸ºä»€ä¹ˆout of column scopeä¹Ÿä¼šæ‰“å°2æ¬¡å‘¢ï¼Œå…¶å®æ˜¯å› ä¸ºColumnæ˜¯inlineçš„ï¼Œ å®ƒåªèƒ½å…±äº«è°ƒç”¨æ–¹çš„é‡ç»„èŒƒå›´ã€‚</p>
</blockquote>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul>
<li><code>LaunchedEffect</code>æ˜¯åœ¨Jetpack Composeä¸­æä¾›äº†åœ¨å¯ç»„åˆé¡¹ä¸­è°ƒç”¨æŒ‚èµ·å‡½æ•°çš„èƒ½åŠ›çš„ä¸€ç§æ–¹å¼ã€‚</li>
<li>åœ¨è¿›å…¥ç»„åˆé¡¹æ—¶ï¼Œ<code>LaunchedEffect</code>ä¼šå¯åŠ¨ä¸€ä¸ªåç¨‹å¹¶æ‰§è¡ŒæŒ‚èµ·ä»£ç å—(block)ï¼Œåœ¨é€€å‡ºç»„åˆé¡¹æ—¶ï¼Œåç¨‹å°†å–æ¶ˆ</li>
<li>ä½¿ç”¨ä¸åŒçš„key(å‚æ•°key1, key2)é‡ç»„æ—¶ï¼Œä¼šå–æ¶ˆå½“å‰åç¨‹å¹¶å¯åŠ¨æ–°çš„åç¨‹æ‰§è¡ŒæŒ‚èµ·å‡½æ•°</li>
<li>å†™<code>LaunchedEffect</code>å‡½æ•°æ—¶ï¼Œæœ€å°‘è¦ä¸€ä¸ªkey(IDE ä¼šæœ‰æç¤º)</li>
<li><code>LaunchedEffect</code>çš„å‡½æ•°è°ƒåº¦å™¨æ˜¯ä¸»çº¿ç¨‹</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Jetpack Compose</tag>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>Android Kotlin Coroutines + Retrofit + MVVM ç®€å•å®ç°</title>
    <url>/2021/09/11/Android-Kotlin-Coroutines-Retrofit-MVVM-%E7%AE%80%E5%8D%95%E5%AE%9E%E7%8E%B0/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul>
<li>è¿™æ˜¯ä¸€ç¯‡éšè®°ï¼Œæƒ³å°è¯•ä¸‹å†™æ–‡ç« ã€‚</li>
<li>è¿™é‡ŒåŸºæœ¬ä¸ä¼šæ·±å…¥è®¨è®ºå„ä¸ªçŸ¥è¯†ç‚¹ï¼Œå¦‚éœ€äº†è§£æ›´å¤šå¯ä»¥å‚è€ƒ <a href="https://www.bennyhuo.com/">Bennyâ€™s Blog</a> å’Œ <a href="https://kotlinlang.org/docs/reference/coroutines/coroutines-guide.html">Kotlinå®˜æ–¹æ–‡æ¡£</a><h2 id="ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹"><a href="#ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹" class="headerlink" title="ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹"></a>ä¸ºä»€ä¹ˆä½¿ç”¨åç¨‹</h2></li>
<li>åç¨‹æ¯”çº¿ç¨‹å°<blockquote>
<p>æˆ‘ï¼š ä¸ºä»€ä¹ˆå·²ç»æœ‰Rxäº†è¿˜è¦åœ¨è¿™é‡Œç”¨åç¨‹ï¼Ÿ<br><br>æŸåŒäº‹ï¼š å› ä¸ºåç¨‹æ¯”çº¿ç¨‹å°ï¼Œå¯ä»¥å¼€å¾ˆå¤šä¸ªã€‚<br><br>æˆ‘ï¼šâ€¦â€¦ ä¸ºä»€ä¹ˆæ¯”çº¿ç¨‹å°ï¼Ÿ</p>
</blockquote>
</li>
</ul>
<p>&emsp; æˆ‘ç»´åŸºäº†ä¸€ä¸‹ï¼Œç¡®å®æœ‰è¯´æ¯”çº¿ç¨‹æ›´å°ã€‚<br><br>&emsp; ä½†æ˜¯çœ‹äº†ä¸€äº›æºç ï¼Œä¹Ÿæ˜¯çº¿ç¨‹æ±  + çº¿ç¨‹å®ç°çš„ï¼Œè¿™æ—¶å°±å¼€å§‹æœ‰äº†ç–‘æƒ‘ï¼Œä¸ºä»€ä¹ˆåŒæ ·æ˜¯çº¿ç¨‹ï¼Œæ€ä¹ˆå°±è¯´æ˜¯æ¯”çº¿ç¨‹å°çš„ä¸œè¥¿å‘¢ï¼Ÿ<br><br>&emsp; ç›´åˆ°çœ‹åˆ°äº†Bennyå¤§ä½¬çš„æ–‡ç«  <a href="https://www.bennyhuo.com/2019/10/19/coroutine-why-so-called-lightweight-thread/">åç¨‹ä¸ºä»€ä¹ˆè¢«ç§°ä¸ºã€è½»é‡çº§çº¿ç¨‹ã€</a>è§£é‡Šï¼Œæˆ‘æ¸…æ™°äº†ã€‚é€šè¿‡æµ‹éªŒï¼Œç¡®å®å¯åŠ¨æˆåƒä¸Šä¸‡ä¸ªåç¨‹ä¹Ÿä¸ä¼šå‡ºç°OOMæˆ–è€…å…¶ä»–é—®é¢˜ã€‚</p>
<ul>
<li>å½“ç„¶æœ€ä¸»è¦çš„è¿˜æ˜¯ä»£ç ä¸Šçš„ä½“éªŒ<br>ç°åœ¨Kotlinè¶Šæ¥è¶Šæ™®éï¼Œå„ç§inlineå‡½æ•°ï¼Œæ“ä½œç¬¦ä¹Ÿéƒ½åŸºæœ¬å¯ä»¥æ›¿æ¢Rxçš„å¸¸ç”¨æ“ä½œç¬¦äº†ã€‚æ‰€ä»¥åœ¨å†™ä»£ç ä¸Šä½“éªŒè¿˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¥½çš„ã€‚<br><br><font color=#f00 size=3><em>ï¼ˆå¤‡æ³¨ï¼šä¸ªäººè§‰å¾—åç¨‹å°ä¸å°å¯¹äºAndroidå¼€å‘çœŸçš„æ²¡å¤šå¤§åŒºåˆ«ï¼Œæœ€ä¸»è¦è¿˜æ˜¯å†™ä»£ç å’Œä»£ç ç¾è§‚æ€§ï¼‰</em></font><span id="more"></span>
<h2 id="ä¸€ã€æ·»åŠ ä¾èµ–"><a href="#ä¸€ã€æ·»åŠ ä¾èµ–" class="headerlink" title="ä¸€ã€æ·»åŠ ä¾èµ–"></a>ä¸€ã€æ·»åŠ ä¾èµ–</h2><pre class="line-numbers language-Gradle" data-language="Gradle"><code class="language-Gradle">implementation&quot;com.squareup.retrofit2:retrofit:2.6.2&quot;
implementation&quot;com.squareup.retrofit2:converter-gson:2.6.2&quot;

&#x2F;&#x2F; Coroutines 
implementation &#39;org.jetbrains.kotlinx:kotlinx-coroutines-core:1.3.2&#39;
implementation &#39;org.jetbrains.kotlinx:kotlinx-coroutines-android:1.3.2&#39;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<font color=#f00 size=3><em>è®°å¾—ä½¿ç”¨retrofit 2.6.0 æˆ–ä»¥ä¸Š</em></font><h2 id="äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£"><a href="#äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£" class="headerlink" title="äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£"></a>äºŒã€å‡†å¤‡ç½‘ç»œè¯·æ±‚æ¥å£</h2></li>
<li>åˆ›å»ºæ¥å£<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">interface</span> GitApi <span class="token punctuation">&#123;</span>
    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">"/users/&#123;username&#125;/&#123;module&#125;"</span><span class="token punctuation">)</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">repos</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string">"username"</span><span class="token punctuation">)</span> username<span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Path</span><span class="token punctuation">(</span><span class="token string">"module"</span><span class="token punctuation">)</span> module<span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">)</span> currPage<span class="token operator">:</span> Int
    <span class="token punctuation">)</span><span class="token operator">:</span> List<span class="token operator">&lt;</span>RepoInfo<span class="token operator">></span>

    <span class="token annotation builtin">@GET</span><span class="token punctuation">(</span><span class="token string">"/search/repositories"</span><span class="token punctuation">)</span>
    <span class="token keyword">suspend</span> <span class="token keyword">fun</span> <span class="token function">searchRepos</span><span class="token punctuation">(</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">"q"</span><span class="token punctuation">)</span> key<span class="token operator">:</span> String<span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">"sort"</span><span class="token punctuation">)</span> sort<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token string">"updated"</span><span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">"order"</span><span class="token punctuation">)</span> order<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token string">"desc"</span><span class="token punctuation">,</span>
        <span class="token annotation builtin">@Query</span><span class="token punctuation">(</span><span class="token string">"page"</span><span class="token punctuation">)</span> currPage<span class="token operator">:</span> Int
    <span class="token punctuation">)</span><span class="token operator">:</span> SearchResponse
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>åˆ›å»ºRetrofitå®ä¾‹<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">buildRetrofit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> Retrofit <span class="token punctuation">&#123;</span>
     builder<span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token function">HttpLoggingInterceptor</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> HttpLoggingInterceptor<span class="token punctuation">.</span><span class="token function">Logger</span> <span class="token punctuation">&#123;</span>
         <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">log</span><span class="token punctuation">(</span>message<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
             Timber<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
         <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span> <span class="token punctuation">&#123;</span>
         level <span class="token operator">=</span> HttpLoggingInterceptor<span class="token punctuation">.</span>Level<span class="token punctuation">.</span>BODY
     <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addInterceptor</span><span class="token punctuation">(</span><span class="token keyword">object</span> <span class="token operator">:</span> Interceptor <span class="token punctuation">&#123;</span>
         <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">intercept</span><span class="token punctuation">(</span>chain<span class="token operator">:</span> Interceptor<span class="token punctuation">.</span>Chain<span class="token punctuation">)</span><span class="token operator">:</span> Response <span class="token punctuation">&#123;</span>
             <span class="token keyword">val</span> userCredentials <span class="token operator">=</span> <span class="token string">"<span class="token interpolation variable">$username</span>:<span class="token interpolation variable">$password</span>"</span>
             <span class="token keyword">val</span> basicAuth <span class="token operator">=</span>
                 <span class="token string">"Basic <span class="token interpolation"><span class="token delimiter variable">$&#123;</span><span class="token function">String</span><span class="token punctuation">(</span>Base64<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>userCredentials<span class="token punctuation">.</span><span class="token function">toByteArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> Base64<span class="token punctuation">.</span>DEFAULT<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token delimiter variable">&#125;</span></span>"</span>
             <span class="token keyword">val</span> original <span class="token operator">=</span> chain<span class="token punctuation">.</span><span class="token function">request</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token keyword">val</span> requestBuilder <span class="token operator">=</span> original<span class="token punctuation">.</span><span class="token function">newBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                 <span class="token punctuation">.</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token string">"Authorization"</span><span class="token punctuation">,</span> basicAuth<span class="token punctuation">.</span><span class="token function">trim</span> <span class="token punctuation">&#123;</span> it <span class="token operator">&lt;=</span> <span class="token string">' '</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
             <span class="token keyword">val</span> request <span class="token operator">=</span> requestBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
             <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span>
         <span class="token punctuation">&#125;</span>
     <span class="token punctuation">&#125;</span><span class="token punctuation">)</span>
     <span class="token keyword">return</span> Retrofit<span class="token punctuation">.</span><span class="token function">Builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">client</span><span class="token punctuation">(</span>builder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">baseUrl</span><span class="token punctuation">(</span>BASE_URL<span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">addConverterFactory</span><span class="token punctuation">(</span>GsonConverterFactory<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="ä¸‰ã€-åœ¨ViewModelä¸­ä½¿ç”¨"><a href="#ä¸‰ã€-åœ¨ViewModelä¸­ä½¿ç”¨" class="headerlink" title="ä¸‰ã€ åœ¨ViewModelä¸­ä½¿ç”¨"></a>ä¸‰ã€ åœ¨ViewModelä¸­ä½¿ç”¨</h2><code>kotlinx.coroutines.CoroutineScope</code> æ¥å£ä¸­çš„æ³¨é‡Šæœ‰è¿™ä¹ˆä¸€å¥è¯<br><br><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/30/16f561eaea6d630b~tplv-t2oaga2asx-image.image" alt="image.png"><br>æ‰€ä»¥å¯åŠ¨ä¸€ä¸ªåç¨‹ä¸€å®šéœ€è¦ä¸€ä¸ª<code>Scope</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªsuspendå‡½æ•°éƒ½æœ‰ä¸€ä¸ª<code>CoroutineScope</code>ï¼Œå¦‚æœæ²¡æœ‰ä¸€å®šä¼šæŠ¥é”™ã€‚è€ŒAndroidçš„ViewModelä¸­æœ‰æ‰©å±•äº†ä¸€ä¸ª<code>viewModelScope</code>ï¼Œå¹¶ä¸”è·Ÿ<code>lifecycle</code>ç»‘å®šäº†ï¼Œæ‰€ä»¥åœ¨ViewModelçš„onClearedæ–¹æ³•ä¸Šä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬cancelæ‰è¿™ä¸ªviewModelScopeçš„æ‰€æœ‰Jobsã€‚<br><img src="https://p1-jj.byteimg.com/tos-cn-i-t2oaga2asx/gold-user-assets/2019/12/30/16f561eae8114f24~tplv-t2oaga2asx-image.image" alt="å›¾1"><br>ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨ï¼Œå°è£…äº†ä¸€ä¸ªBaseViewModel<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">open</span> <span class="token keyword">class</span> BaseViewModel <span class="token operator">:</span> <span class="token function">ViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">fun</span> <span class="token operator">&lt;</span>T<span class="token operator">></span> <span class="token function">request</span><span class="token punctuation">(</span>
        onError<span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token operator">-></span> Unit <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token punctuation">&#125;</span><span class="token punctuation">,</span> <span class="token comment">// ä¸éœ€è¦å¤„ç†Errorå¯ä»¥ä¸ä¼ </span>
        execute<span class="token operator">:</span> <span class="token keyword">suspend</span> CoroutineScope<span class="token punctuation">.</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-></span> T
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        viewModelScope<span class="token punctuation">.</span><span class="token function">launch</span><span class="token punctuation">(</span>errorHandler <span class="token punctuation">&#123;</span> onError<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">launch</span><span class="token punctuation">(</span>Dispatchers<span class="token punctuation">.</span>IO<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">fun</span> <span class="token function">errorHandler</span><span class="token punctuation">(</span>onError<span class="token operator">:</span> <span class="token punctuation">(</span>error<span class="token operator">:</span> Throwable<span class="token punctuation">)</span> <span class="token operator">-></span> Unit<span class="token punctuation">)</span><span class="token operator">:</span> CoroutineExceptionHandler <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> CoroutineExceptionHandler <span class="token punctuation">&#123;</span> _<span class="token punctuation">,</span> throwable <span class="token operator">-></span>
            Timber<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>throwable<span class="token punctuation">)</span>
            onError<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span>throwable<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
ä½¿ç”¨ç»§æ‰¿ <code>BaseViewModel</code> è°ƒç”¨ <code>request</code> æ–¹æ³•å³å¯ã€‚<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> <span class="token function">RepoViewModel</span><span class="token punctuation">(</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> userRepo<span class="token operator">:</span> UserDataSource<span class="token punctuation">,</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> gitApi<span class="token operator">:</span> GitApi
<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">BaseViewModel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">private</span> <span class="token keyword">val</span> _reposResult <span class="token operator">=</span> BaseLiveData<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>RepoInfo<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">val</span> repoResult<span class="token operator">:</span> BaseLiveData<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>RepoInfo<span class="token operator">></span><span class="token operator">></span>
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> _reposResult

    <span class="token keyword">fun</span> <span class="token function">fetchRepos</span><span class="token punctuation">(</span>module<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        request <span class="token punctuation">&#123;</span>
            userRepo<span class="token punctuation">.</span><span class="token function">currUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">val</span> result <span class="token operator">=</span> gitApi<span class="token punctuation">.</span><span class="token function">repos</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>nickname<span class="token punctuation">,</span> module<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                _reposResult<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
OR<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">fun</span> <span class="token function">fetchRepos</span><span class="token punctuation">(</span>module<span class="token operator">:</span> String<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">request</span><span class="token punctuation">(</span>
            onError <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                <span class="token comment">// handle error</span>
            <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
            execute <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
                userRepo<span class="token punctuation">.</span><span class="token function">currUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">&#123;</span>
                    <span class="token keyword">val</span> result <span class="token operator">=</span> gitApi<span class="token punctuation">.</span><span class="token function">repos</span><span class="token punctuation">(</span>it<span class="token punctuation">.</span>nickname<span class="token punctuation">,</span> module<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    _reposResult<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
å‰©ä¸‹çš„åŸºæœ¬æ˜¯LiveDataå’ŒFragmentä¹‹é—´çš„è®¢é˜…ä¸Šçš„é€»è¾‘å®ç°äº†ã€‚<h2 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h2>æœ€è¿‘åœ¨å­¦ä¹ ï¼Œäº†è§£ä¹Ÿä¸æ˜¯å¾ˆæ·±ï¼Œæ¬¢è¿è¯„è®ºè¡¥å……å’Œæå»ºè®®ã€‚ å­¦ä¹ é¡¹ç›®åœ°å€ <a href="https://github.com/BreakZero/Dithub">Dithub</a>ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Android</tag>
        <tag>MVVM</tag>
      </tags>
  </entry>
  <entry>
    <title>DATA BETWEEN AIDL IN ANDROID</title>
    <url>/2023/03/20/DATA-BETWEEN-AIDL-IN-ANDROID/</url>
    <content><![CDATA[<blockquote>
<p>Android å¤¸è¿›ç¨‹é€šè®¯çš„æ–¹å¼ä¸€èˆ¬æœ‰ï¼š</p>
<ol>
<li>Binder</li>
<li>å†…å­˜å…±äº«</li>
<li>Socket</li>
</ol>
</blockquote>
<p>å…¶ä¸­Binderåœ¨Androidä¸­ä½¿ç”¨æ¯”è¾ƒå¤šï¼Œæ¯”å¦‚AMS<br>åœ¨Androidä¸Šï¼Œä¸€ä¸ªè¿›ç¨‹é€šå¸¸æ˜¯ä¸èƒ½è·å–åˆ°å…¶ä»–è¿›ç¨‹çš„å†…å­˜è®¿é—®æƒé™çš„ï¼Œä½†æ˜¯æœ‰æ—¶æˆ‘ä»¬éœ€è¦åœ¨å¤šä¸ªè¿›ç¨‹ä¹‹é—´è¿›è¡Œæ•°æ®å¤„ç†ï¼Œå› æ­¤Androidæä¾›äº†Android Interface Definition Languageï¼ˆAIDLï¼‰æ¥åšå¤„ç†<br>å…¶å®AIDLæ˜¯æ–‡ä»¶ä¼šé€šè¿‡ç¼–è¯‘ç”Ÿæˆä¸€ä¸ªSubç±»å¹¶å®ç°IBinderæ¥å£çš„ï¼Œè¿™ç§æ–¹å¼å¯ä»¥è¯´æ˜¯åŸºäºBinderå®ç°çš„ã€‚</p>
<h3 id="é…ç½®æ–°é¡¹ç›®"><a href="#é…ç½®æ–°é¡¹ç›®" class="headerlink" title="é…ç½®æ–°é¡¹ç›®"></a>é…ç½®æ–°é¡¹ç›®</h3><p>é¦–å…ˆåˆ›å»ºä¸€ä¸ªé¡¹ç›®ï¼Œæœ‰ä¸¤ä¸ªPhone Moduleï¼Œåˆ†åˆ«ä¸ºClientå’ŒServerç«¯ã€‚å¯¹äºæ–°çš„é¡¹ç›®æ‰“å¼€aidl featureæ”¯æŒ</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">buildFeatures <span class="token punctuation">&#123;</span>
    compose <span class="token boolean">true</span>
    aidl <span class="token boolean">true</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<span id="more"></span>
<h3 id="Serverç«¯ï¼š"><a href="#Serverç«¯ï¼š" class="headerlink" title="Serverç«¯ï¼š"></a>Serverç«¯ï¼š</h3><p>ç„¶ååˆ›å»ºaidlæ–‡ä»¶</p>
<pre class="line-numbers language-aidl" data-language="aidl"><code class="language-aidl">interface IRemoteAidlInterface &#123;
    &#x2F;**
    * Demonstrates some basic types that you can use as parameters
    * and return values in AIDL.
    *&#x2F;
    int currPid();
    void basicTypes(int anInt, long aLong, boolean aBoolean, float aFloat,
    double aDouble, String aString);
    void addUser(inout User user);
    User theFirstUser();
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»¥ä¸ŠåŠ äº†Userä¸æ˜¯åŸºæœ¬ç±»å‹ï¼Œæ‰€ä»¥éœ€è¦åšä¸€äº›ç‰¹æ®Šå¤„ç†ï¼Œ<br>é¦–å…ˆæ·»åŠ ä¸€ä¸ªaidlæ–‡ä»¶å£°æ˜ä¸‹è¿™ä¸ªç±»</p>
<pre class="line-numbers language-aidl" data-language="aidl"><code class="language-aidl">package com.easy.aidlserver;

&#x2F;&#x2F; Declare any non-default types here with import statements

parcelable User;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ç„¶ååˆ›å»ºä¸€ä¸ªdata class, å¹¶æ·»åŠ <code>readFromParcel</code>æ–¹æ³•</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Parcelize</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">User</span><span class="token punctuation">(</span>
<span class="token keyword">var</span> name<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>
<span class="token keyword">var</span> age<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span>
<span class="token punctuation">)</span><span class="token operator">:</span> Parcelable <span class="token punctuation">&#123;</span>
    <span class="token keyword">fun</span> <span class="token function">readFromParcel</span><span class="token punctuation">(</span>reply<span class="token operator">:</span> Parcel<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>name <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>age <span class="token operator">=</span> reply<span class="token punctuation">.</span><span class="token function">readInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>Buildä¸‹é¡¹ç›®ç”Ÿæˆå¯¹åº”çš„javaç±»ï¼Œ<br>å£°æ˜å¹¶æ³¨å†Œä¸€ä¸ªServiceï¼Œæä¾›æ•°æ®å¤„ç†èƒ½åŠ›</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">class</span> RemoteService <span class="token operator">:</span> <span class="token function">Service</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onBind</span><span class="token punctuation">(</span>intent<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> IBinder <span class="token punctuation">&#123;</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"Service Side"</span><span class="token punctuation">,</span> <span class="token string">"onBind"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> binder<span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onUnbind</span><span class="token punctuation">(</span>intent<span class="token operator">:</span> Intent<span class="token operator">?</span><span class="token punctuation">)</span><span class="token operator">:</span> Boolean <span class="token punctuation">&#123;</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"Service Side"</span><span class="token punctuation">,</span> <span class="token string">"onUnBind"</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> <span class="token keyword">super</span><span class="token punctuation">.</span><span class="token function">onUnbind</span><span class="token punctuation">(</span>intent<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">private</span> <span class="token keyword">val</span> users <span class="token operator">=</span> mutableListOf<span class="token operator">&lt;</span>User<span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span>

    <span class="token operator">..</span><span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¹¶åœ¨manifestç§æ³¨å†Œ</p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>service</span>
    <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>.RemoteService<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">android:</span>exported</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>true<span class="token punctuation">"</span></span>
    <span class="token attr-name"><span class="token namespace">tools:</span>ignore</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>ExportedService<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>intent-filter</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>action</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.aidl.server<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>category</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>android.intent.category.DEFAULT<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>intent-filter</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>service</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>è¿™é‡ŒServerç«¯ä»£ç å®Œæˆäº†</p>
<h3 id="Clientç«¯"><a href="#Clientç«¯" class="headerlink" title="Clientç«¯"></a>Clientç«¯</h3><p>copy aidlæ–‡ä»¶åˆ°clientç«¯ï¼Œæ³¨æ„è¦ç›¸åŒçš„åŒ…åå’Œå†…å®¹ï¼Œè¿˜æœ‰å¯¹åº”çš„data class <code>User</code><br>å®šä¹‰connectionå¹¶é€šè¿‡Binderæ‹¿åˆ°AIDL Interfaceï¼Œæ‹¿åˆ°interfaceå°±å¯ä»¥é€šè¿‡è°ƒç”¨aidlæä¾›çš„æ–¹æ³•ï¼Œå¹¶é€šè¿‡Proxyå’ŒæœåŠ¡ç«¯çš„serviceè¿›è¡Œæ•°æ®ä¼ è¾“å’Œå¤„ç†</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">private</span> <span class="token keyword">val</span> sConnection <span class="token operator">=</span> <span class="token keyword">object</span> <span class="token operator">:</span> ServiceConnection <span class="token punctuation">&#123;</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceConnected</span><span class="token punctuation">(</span>name<span class="token operator">:</span> ComponentName<span class="token operator">?</span><span class="token punctuation">,</span> service<span class="token operator">:</span> IBinder<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        iRemoteService <span class="token operator">=</span> IRemoteAidlInterface<span class="token punctuation">.</span>Stub<span class="token punctuation">.</span><span class="token function">asInterface</span><span class="token punctuation">(</span>service<span class="token punctuation">)</span>
        iRemoteService<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">try</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">val</span> pid <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">currPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token keyword">val</span> myPid <span class="token operator">=</span> Process<span class="token punctuation">.</span><span class="token function">myPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                Log<span class="token punctuation">.</span><span class="token function">i</span><span class="token punctuation">(</span><span class="token string">"Client"</span><span class="token punctuation">,</span> <span class="token string">"Service Pid: <span class="token interpolation variable">$pid</span>, Client Pid: <span class="token interpolation variable">$myPid</span>"</span><span class="token punctuation">)</span>
                it<span class="token punctuation">.</span><span class="token function">basicTypes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token number">3.0f</span><span class="token punctuation">,</span> <span class="token number">5.0</span><span class="token punctuation">,</span> <span class="token string">"Hello AIDL Server"</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token operator">:</span> Exception<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">onServiceDisconnected</span><span class="token punctuation">(</span>name<span class="token operator">:</span> ComponentName<span class="token operator">?</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        Log<span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span><span class="token string">"Client"</span><span class="token punctuation">,</span> <span class="token string">"onDisconnect"</span><span class="token punctuation">)</span>
        iRemoteService <span class="token operator">=</span> <span class="token keyword">null</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>é‡åˆ°çš„é—®é¢˜æˆ–ç–‘æƒ‘ï¼š</p>
<ol>
<li><p>é€šè¿‡API30 çš„x86 è™šæ‹Ÿæœºå¯ä»¥æ­£å¸¸å”¤é†’serviceå¹¶æ•°æ®æ­£å¸¸ä¼ è¾“ï¼Œä½†æ˜¯åœ¨API33çš„çœŸæœºä¸Šæ— æ³•bind service<br>é€šè¿‡æŸ¥é˜…èµ„æ–™ï¼Œå‘ç°åœ¨30æˆ–ä»¥ä¸Šçš„API levelåå­˜åœ¨<a href="https://developer.android.google.cn/training/package-visibility?hl=en">Package visibility filtering on Android</a> è¿™ä¹ˆä¸€ä¸ªè¯´æ³•ã€‚<br>å¤§æ¦‚å°±æ˜¯ä¸ºäº†æ›´é«˜çš„å®‰å…¨æ€§è€ŒåŠ å…¥äº†è¿‡æ»¤è¡Œä¸ºï¼Œä»è€Œå¯¼è‡´åº”ç”¨æ— æ³•æ£€æµ‹åˆ°å½“å‰è®¾å¤‡ä¸Šæ‰€æœ‰å®‰è£…çš„åº”ç”¨ç¨‹åºã€‚è§£å†³æ–¹æ³•åŠ å…¥ <code>queries</code></p>
<pre class="line-numbers language-xml" data-language="xml"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>queries</span><span class="token punctuation">></span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>package</span> <span class="token attr-name"><span class="token namespace">android:</span>name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>com.easy.aidlserver<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>queries</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li><p>å·²ç»æ“ä½œäº†unbindServiceï¼Œä½†æ˜¯ä»ç„¶èƒ½è¿›è¡Œæ•°æ®æ“ä½œï¼Œè€Œä¸”æ—¥å¿—èµ°äº†onUnbindå´ä¸èµ°onServiceDisconnected<br>å…¶å®onServiceDisconnectedåœ¨æ­£å¸¸unbindçš„æ—¶å€™æ˜¯ä¸ä¼šè§¦å‘æ‰§è¡Œçš„ï¼Œè€Œæ˜¯åœ¨æœåŠ¡ä¸¢å¤±çš„æ—¶å€™æ‰§è¡Œã€‚<br><img src="/images/codes/aidl_1.jpg" alt="When to excute onServiceDisconnected" title="AIDL"></p>
</li>
<li><p>ä¼ è¾“å¤§æ•°æ®çš„æ—¶å€™<br>å› ä¸ºAIDL æ˜¯é€šè¿‡IBinderè¿›è¡Œæ•°æ®ä¼ è¾“çš„ï¼Œè€ŒIBinderå¯¹æ•°æ®çš„æ‹·è´æ˜¯ç»è¿‡mmapï¼ˆå†…å­˜æ˜ å°„ï¼‰ï¼Œåœ¨æˆ‘ä»¬appå¯åŠ¨çš„æ—¶å€™ï¼Œä¼šå»ç”³è¯·ä¸€ä¸ª 1M - 8Kå¤§å°çš„å†…å­˜ç»™mmapï¼Œæ‰€ä»¥å¦‚æœ<br>ä¼ è¾“1Mæˆ–ä»¥ä¸Šçš„æ•°æ®å°±ä¼šæŠ¥é”™ã€‚<br>å°†Userä¿®æ”¹ä¸€ä¸‹ï¼ŒåŠ ä¸€ä¸ªByteArray</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Parcelize</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">User</span><span class="token punctuation">(</span>
    <span class="token keyword">var</span> name<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token string">""</span><span class="token punctuation">,</span>
    <span class="token keyword">var</span> age<span class="token operator">:</span> Int <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token keyword">var</span> byteArray<span class="token operator">:</span> ByteArray <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½¿ç”¨çš„æ—¶å€™</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// _1M = 1024 * 1024</span>
iRemoteService<span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">addUser</span><span class="token punctuation">(</span>
    <span class="token function">User</span><span class="token punctuation">(</span>
        <span class="token string">"Dougie <span class="token interpolation"><span class="token delimiter variable">$&#123;</span>Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token delimiter variable">&#125;</span></span>"</span><span class="token punctuation">,</span>
        Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">,</span> <span class="token number">24</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        byteArray <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>_1M<span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä½ ä¼šæ”¶åˆ°æŠ¥é”™ä¿¡æ¯ï¼š<br><img src="/images/codes/aidl_error.jpg" alt="android.os.TransactionTooLargeException: data parcel size 1048712 bytes" title="AIDL Error"></p>
</li>
</ol>
<h3 id="ä»£ç åœ°å€-AidlSample"><a href="#ä»£ç åœ°å€-AidlSample" class="headerlink" title="ä»£ç åœ°å€ AidlSample"></a>ä»£ç åœ°å€ <a href="https://github.com/BreakZero/AidlSample">AidlSample</a></h3>]]></content>
      <tags>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>æ˜¯å¦åº”è¯¥å°†Composeä¸­çš„çŠ¶æ€åˆ‡åˆ†</title>
    <url>/2023/07/10/Do-we-need-to-split-state-of-Compose/</url>
    <content><![CDATA[<p>ä¸ºä»€ä¹ˆä¼šæœ‰è¿™ç§ç–‘é—®å‘¢ï¼Ÿ<br>æˆ‘ä»¬çŸ¥é“Composeæ˜¯é€šè¿‡é‡ç»„æ¥åˆ·æ–°UIçš„ï¼Œå½“ä¸€ä¸ªStateå‘ç”Ÿæ”¹å˜æ—¶ï¼Œå…¶å¯¹åº”çš„å¯é‡ç»„å‡½æ•°çš„Lambdaä¼šé‡æ–°æ‰§è¡Œï¼Œè€Œæˆ‘ä»¬é€šå¸¸åœ¨è®¾è®¡Stateæ—¶éƒ½æ˜¯å°†å½“å‰ç•Œé¢ç›¸å…³å±<br>combineæˆä¸€ä¸ªæ•´ä½“çš„Stateï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨ä¿®æ”¹Stateæ—¶ï¼Œå…¶å®å°±æ˜¯è®©æ•´ä¸ªStateéƒ½å‘ç”Ÿäº†å˜åŒ–ï¼ŒåŸºæœ¬ä¼šè®©æ•´ä¸ªç•Œé¢éƒ½å‘ç”Ÿé‡ç»„ä¸ä¼šè·³è¿‡ã€‚ä¸‹é¢é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// ä¸€ä¸ªæ•´åˆçš„State</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">XModelState</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> name<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> age<span class="token operator">:</span> Int<span class="token punctuation">,</span>
    <span class="token keyword">val</span> intro<span class="token operator">:</span> String
    <span class="token operator">..</span><span class="token punctuation">.</span>
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<span id="more"></span>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token function">Column</span><span class="token punctuation">(</span>
    modifier <span class="token operator">=</span> Modifier
    <span class="token punctuation">.</span><span class="token function">fillMaxSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">padding</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">.</span>dp<span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Column"</span><span class="token punctuation">)</span>

    Wrapper <span class="token punctuation">&#123;</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">"Name is <span class="token interpolation"><span class="token delimiter variable">$&#123;</span>modelState<span class="token punctuation">.</span>name<span class="token delimiter variable">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Name changed"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    Wrapper <span class="token punctuation">&#123;</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">"Age is <span class="token interpolation"><span class="token delimiter variable">$&#123;</span>modelState<span class="token punctuation">.</span>age<span class="token delimiter variable">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Age changed"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    Wrapper <span class="token punctuation">&#123;</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">"Intro is <span class="token interpolation"><span class="token delimiter variable">$&#123;</span>modelState<span class="token punctuation">.</span>intro<span class="token delimiter variable">&#125;</span></span>"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Intro changed"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token function">Button</span><span class="token punctuation">(</span>
        modifier <span class="token operator">=</span> Modifier<span class="token punctuation">.</span><span class="token function">fillMaxWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        onClick <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
            modelState <span class="token operator">=</span> modelState<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>
                name <span class="token operator">=</span> <span class="token string">"Dougie <span class="token interpolation"><span class="token delimiter variable">$&#123;</span>Random<span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token delimiter variable">&#125;</span></span>"</span><span class="token punctuation">,</span>
                age <span class="token operator">=</span> age <span class="token operator">+</span> <span class="token number">1</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>text <span class="token operator">=</span> <span class="token string">"Update Model"</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>ä»¥ä¸Šä»£ç ä¸­ï¼Œå½“ç‚¹å‡»Update ModelæŒ‰é’®æ¥ä¿®æ”¹modelStateæ—¶ï¼Œ3ä¸ªWrapperå…¨éƒ¨éƒ½å‘ç”Ÿé‡ç»„ï¼Œå‡è®¾è¿™ä¸ªStateå…¶å®è¿˜å¯èƒ½æ›´å¤§ï¼Œæœ‰20å¤šä¸ªå±æ€§ï¼Œè€Œå½“æˆ‘ä»¬åªä¿®æ”¹<br>ä¸€éƒ¨åˆ†ç›¸å…³çš„ï¼Œå¾ˆå¤šç›¸å…³çš„Composableåº”è¯¥skip re-composeã€‚</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">*</span>       ----------------     -----------------      ---------------------
<span class="token list punctuation">*</span>       | Click Button |  -> | State changed |  ->  | trigger recompose |
<span class="token list punctuation">*</span>       ----------------     -----------------      ---------------------<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>ä¸ºäº†é¿å…è¿™ä¸ªæƒ…å†µï¼Œç›®å‰Composeä¹Ÿæ²¡æä¾›ç›¸å…³çš„apiï¼Œå¥½åƒä¹Ÿåªèƒ½é€šè¿‡åˆ†å‰²çŠ¶æ€äº†ï¼Œå¯¹åº”æ–‡ç« çš„æ ‡é¢˜ã€‚</p>
<h3 id="1-ViewModelå±‚ä¿ç•™å¤šä¸ªå…¬å¼€çš„State"><a href="#1-ViewModelå±‚ä¿ç•™å¤šä¸ªå…¬å¼€çš„State" class="headerlink" title="1. ViewModelå±‚ä¿ç•™å¤šä¸ªå…¬å¼€çš„State"></a>1. ViewModelå±‚ä¿ç•™å¤šä¸ªå…¬å¼€çš„State</h3><p>åœ¨ViewModel combineçš„æ—¶å€™å°±å°†Stateåˆ†å‰²å¹¶æä¾›å¤šä¸ªStateå«ä¸ªUIå±‚ä½¿ç”¨ï¼Œè€Œåœ¨æ“ä½œçš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿåªä¼šæ”¹å˜å…¶å¯¹åº”çš„å°Stateï¼Œå…¶ä»–Stateä¸ä¼šå˜åŒ–ï¼Œ<br>æ‰€ä»¥Composeä¸Šä¹Ÿåªä¼šé‡ç»„å…¶å¯¹åº”çš„å¯é‡ç»„Lambdaï¼Œè€Œå…¶ä»–çš„åˆ™ä¼šè·³è¿‡é‡ç»„ã€‚</p>
<h3 id="2-ä½¿ç”¨-derivedStateOf"><a href="#2-ä½¿ç”¨-derivedStateOf" class="headerlink" title="2. ä½¿ç”¨ derivedStateOf"></a>2. ä½¿ç”¨ derivedStateOf</h3><p>åœ¨Viewå±‚ï¼Œä¾ç„¶æ˜¯æ‹¿åˆ°æ•´ä¸ªå¤§çš„Stateï¼Œæˆ‘ä»¬é€šè¿‡å¢åŠ å†…éƒ¨å±æ€§å¹¶ä½¿derivedStateOfè¿™ä¸ªæ–¹æ³•å°†Stateåˆ†å‰²ã€‚</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">val</span> age <span class="token keyword">by</span> remember <span class="token punctuation">&#123;</span>
    derivedStateOf <span class="token punctuation">&#123;</span>
        modelState<span class="token punctuation">.</span>age
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">val</span> intro <span class="token keyword">by</span> remember <span class="token punctuation">&#123;</span>
    derivedStateOf <span class="token punctuation">&#123;</span>
        modelState<span class="token punctuation">.</span>intro
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¦‚ä¸Šï¼Œå°†ageå’Œintroåˆ†å‰²å‡ºæ¥ï¼Œåœ¨ç‚¹å‡»æŒ‰é’®æ˜¯ï¼Œage+1ï¼Œè€Œintroä¸å˜ï¼Œé€šè¿‡æ—¥å¿—ï¼Œå‘ç°åªæœ‰Age Changedï¼Œæ‰€ä»¥introçš„è¢«è·³è¿‡é‡ç»„äº†ã€‚</p>
<blockquote>
<p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œéœ€æ±‚featureä¼šè¶Šæ¥è¶Šå¤šï¼ŒStateä¹Ÿä¼šéšä¹‹è€Œå¢åŠ ï¼Œä»¥ä¸Šä¸¤ç§æ–¹å¼è™½ç„¶ä¸€å®šç¨‹åº¦ä¸Šèƒ½å‡å°‘é‡ç»„ï¼Œä½†æ˜¯ä¹Ÿå¾ˆå¤§ç¨‹åº¦ä¸Šå¢åŠ äº†ç»´æŠ¤å·¥ä½œ<br>å’Œå¸¦æ¥æ–°çš„é—®é¢˜ã€‚</p>
</blockquote>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨Composeä¸Šï¼ŒUIçš„æ›´æ–°å¿…ç„¶è„±ç¦»ä¸äº†é‡ç»„ï¼Œæ‰€ä»¥é‡ç»„æœ¬èº«å¹¶ä¸æ˜¯å¤§é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„çš„æ˜¯å°½é‡åœ¨å¯é‡ç»„é¡¹ä¸­å°½é‡å°‘æ“ä½œå¤šä½™çš„å·¥ä½œã€‚æ‰€ä»¥é€šå¸¸æˆ‘ä»¬ä¸å¿…åœ¨æ„è¿™äº›ï¼Œ<br>å› ä¸ºComposeå¸®æˆ‘åšäº†å¾ˆå¤šä¼˜åŒ–çš„å·¥ä½œäº†ã€‚<br>å½“ç„¶å¦‚æœåœ¨æŸä¸ªUIä¸Šï¼Œæœ‰å…¶ä¸­ä¸€éƒ¨ä»½UIå˜åŒ–ç›¸å¯¹æ¯”è¾ƒé¢‘ç¹ï¼Œè€Œå…¶ä»–åˆ™å¾ˆå°‘ï¼Œæ­¤æ—¶æˆ‘å»ºè®®åˆ†å‰²å‡ºæ¥</p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Jetpack Compose</tag>
      </tags>
  </entry>
  <entry>
    <title>EasyWallet Gradle Clean Up</title>
    <url>/2021/09/11/EasyWallet-Part-1/</url>
    <content><![CDATA[<h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><ul>
<li>è®°å½•å¹¶æ•´ç†EasyWallet å°é’±åŒ…å¼€å‘è¿‡ç¨‹</li>
<li>åœ¨é¡¹ç›®ä¸­ä½¿ç”¨åˆ°ï¼š</li>
</ul>
<ol>
<li>Composing build + plugin å®ç°ä¾èµ–åº“ç»Ÿä¸€ç®¡ç†</li>
<li>Jetpack Compose</li>
<li>Hilt ä¾èµ–æ³¨å…¥</li>
<li>Kotlin/Kotlin flow/Coroutine</li>
<li>Ktor å®ç°ç½‘ç»œè¯·æ±‚</li>
<li>Room å®ç°æœ¬åœ°å­˜å‚¨</li>
</ol>
<ul>
<li>æœ¬é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/BreakZero/EasyWallet-Mobile-Compose">EasyWallet-Compose</a></li>
</ul>
<h2 id="gradle-è„šæœ¬ç®¡ç†"><a href="#gradle-è„šæœ¬ç®¡ç†" class="headerlink" title="gradle è„šæœ¬ç®¡ç†"></a>gradle è„šæœ¬ç®¡ç†</h2><ul>
<li>åˆ›å»ºæ–°çš„æ¨¡å—ä½œä¸ºComposing buildï¼Œå¹¶åœ¨ <code>build.gradle.kts</code> ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç å®ç°pluginé…ç½®<pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">gradlePlugin &#123;
    plugins &#123;
        create(&quot;VersionPlugin&quot;) &#123;
            id &#x3D; &quot;version-plugin&quot; &#x2F;&#x2F; change the name you like
            implementationClass &#x3D; &quot;com.easy.version.DependencyVersionPlugin&quot; &#x2F;&#x2F; change package to what you done
        &#125;
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>åœ¨ <code>src.main.kotlin</code> ç›®å½•ä¸‹Pluginå®ç°ç±»å®ç°æ¥å£ <code>Plugin&lt;Project&gt;</code>ï¼Œè¿™ä¸ªplugin çš„apply æ–¹æ³•ä¼šåœ¨ä»»ä½•ä½ ä½¿ç”¨è¿™ä¸ªpluginçš„module æ‰§è¡Œ  <span id="more"></span></li>
<li>ç»Ÿä¸€ç®¡ç†Configsã€‚ ï¼ˆè¿™é‡Œæˆ‘ä¸ºäº†åŒºåˆ†featureæ¨¡å—å’Œappæ¨¡å—ï¼Œæ‰€ä»¥åŠ äº†ignore listï¼‰<ol>
<li>é¦–å…ˆæˆ‘ä»¬åœ¨æ¯ä¸ªæ¨¡å—éƒ½éœ€è¦çš„pluginï¼Œå†™ä¸€ä¸ªProjectçš„æ‰©å±•å‡½æ•°<pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">private fun Project.applyPlugin() &#123;
    apply(plugin &#x3D; &quot;com.android.library&quot;)
    apply(plugin &#x3D; &quot;kotlin-android&quot;)
    apply(plugin &#x3D; &quot;kotlin-kapt&quot;)
    apply(plugin &#x3D; &quot;kotlin-parcelize&quot;)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
ç„¶ååœ¨applyæ–¹æ³•ä¸­ä½¿ç”¨<br><code>target.beforeEvaluate &#123; applyPlugin() &#125;</code><br>è¿™é‡Œæ³¨æ„è¦åŠ ä¸ŠbeforeEvaluateï¼Œåœ¨æ‰§è¡Œå‰apply plugin</li>
<li>é…ç½® android å—<br>å¢åŠ æ‰©å±•æ–¹æ³• <code>LibraryExtension.moduleConfig(isCore: Boolean)</code> (isCoreè¿™é‡Œç®—æ˜¯æˆ‘é¡¹ç›®çš„ç‰¹æ®Šæ”¯æŒï¼Œä¸ºäº†å®ç°buildConfigFieldçš„)<pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">@Suppress(&quot;UnstableApiUsage&quot;)
private fun LibraryExtension.moduleConfig(isCore: Boolean) &#123;
    compileSdk &#x3D; BuildConfig.compileSdkVersion
    defaultConfig &#123;
        minSdk &#x3D; BuildConfig.minSdkVersion
        targetSdk &#x3D; BuildConfig.targetSdkVersion
    &#125;
    buildTypes &#123;
        ...
    &#125;

    compileOptions &#123;
        sourceCompatibility &#x3D; JavaVersion.VERSION_11
        targetCompatibility &#x3D; JavaVersion.VERSION_11
    &#125;
    buildFeatures.also &#123;
        it.compose &#x3D; true
    &#125;
    composeOptions &#123;
        kotlinCompilerExtensionVersion &#x3D; Compose.version
    &#125;
    ...
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
</li>
<li>æœ€ååœ¨root projectä¸­å¢åŠ   <pre class="line-numbers language-none"><code class="language-none">subprojects &#123;
    apply(plugin &#x3D; &quot;version-plugin&quot;)
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
  ç»™æ¯ä¸ªæ¨¡å—éƒ½åº”ç”¨ä¸Špluginï¼Œå½“ç„¶ä¹Ÿå¯ä»¥å•ç‹¬åœ¨moduleä¸Šç›´æ¥åº”ç”¨</li>
<li>ä»¥ä¸Šé…ç½®å®Œæˆåï¼Œä½ ä¼šçœ‹åˆ°æ¨¡å—çš„ gradle è„šæœ¬åŸºæœ¬å°±å¾ˆå°‘äº†ï¼Œ å¦‚ä¸‹  <pre class="line-numbers language-gradle" data-language="gradle"><code class="language-gradle">import com.easy.version.*

dependencies &#123;
    implementation(project(&quot;:core&quot;))
    implementation(project(&quot;:core-ui&quot;))

    implementation(com.easy.version.dependencies.Other.sqlcipher)

    roomDependencies()
    composeUI()
    hiltDependencies()
    unitTestDependencies()
    androidTestDependencies()
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>å¦‚æ­¤é…ç½®ä¹‹åï¼Œ æ¯æ–°å¢ä¸€ä¸ªå­æ¨¡å—ï¼Œéƒ½èƒ½ç»Ÿä¸€å¿«é€Ÿçš„é…ç½®gradle</li>
</ul>
<h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>æ¨¡å—åˆ†ç¦»ã€Navigationç®¡ç†â€¦</p>
]]></content>
      <categories>
        <category>Gradle</category>
      </categories>
      <tags>
        <tag>Gradle</tag>
      </tags>
  </entry>
  <entry>
    <title>æˆ‘çš„ä¸€åŠ2023</title>
    <url>/2023/07/08/Half-year-summary-of-2023/</url>
    <content><![CDATA[<p>å¦‚ä»Šå·²æ˜¯2023å¹´7æœˆï¼Œå›é¡¾è¿™åŠå¹´ï¼Œæ˜¯å¤±ä¸šçš„åŠå¹´(å·²æœ‰5ä¸ªå¤šæœˆ)ã€‚ä¸€è·¯è¿‡æ¥ï¼Œå¤§è‡´æ˜¯å‰2ä¸ªæœˆè·Ÿå‡ ä¸ªæœ‹å‹å»äº†å‡ ä¸ªåœ°æ–¹æ¸¸ç©ï¼Œåå‡ ä¸ªæœˆåˆ™æ˜¯åœ¨æŠ•é€’ç®€å†å¹¶å‡†å¤‡é¢è¯•ï¼Œ<br>ç„¶è€Œå¥‡æ€ªçš„æ˜¯æŠ•äº†å¤§å¤§å‡ åä»½ç®€å†ï¼Œä¹Ÿå°±å¯¥å¯¥æ— å‡ çš„é¢è¯•æœºä¼šï¼Œç®€å†éƒ½æ”¹äº†å¥½å‡ éäº†ã€‚åæ­£åé¢è¿™äº›æ—¶é—´æ˜¯åŠå­¦åŠç©åŠ å¶å°”é¢“åºŸå§ã€‚<br>åƒéš¾ä¸‡éš¾ï¼Œç”Ÿæ´»è¿˜è¦ç»§ç»­ã€‚</p>
<h3 id="å­¦ä¹ æ–¹é¢"><a href="#å­¦ä¹ æ–¹é¢" class="headerlink" title="å­¦ä¹ æ–¹é¢"></a>å­¦ä¹ æ–¹é¢</h3><ul>
<li>é’ˆå¯¹é¢è¯•çŸ¥è¯†é¢å‡†å¤‡è€Œå¤ä¹ äº†äº›ç›¸å…³çŸ¥è¯†ï¼Œæ¯”å¦‚JVMï¼ŒKotlin Coroutineç­‰</li>
<li>å¯¹äºAndroidæ–¹é¢ä¸Šï¼Œçœ‹äº†äº›ç›¸å…³çš„æºç å­¦ä¹ å…¶åŸç†ï¼Œæ¯”å¦‚ViewModelï¼ŒLiveDataï¼ŒRetrofit</li>
<li>å¯¹äºWeb3åˆ™æ˜¯å­¦ä¹ äº†solidityç›¸å…³çš„è¯­æ³•å¹¶ç¼–å†™äº†ä¸€ä¸ªå¯†ç ç®¡ç†çš„ç®€å•åˆçº¦</li>
</ul>
<h3 id="æƒ³æ³•"><a href="#æƒ³æ³•" class="headerlink" title="æƒ³æ³•"></a>æƒ³æ³•</h3><p>é€šè¿‡å›é¡¾åŠå¹´æ¥çš„è¿‡ç¨‹ï¼Œæˆ‘æœ‰ä»¥ä¸‹ä¸¤ä¸ªæ€»ç»“</p>
<span id="more"></span>
<h4 id="1-åº”è¯¥å¦‚ä½•å­¦ä¹ "><a href="#1-åº”è¯¥å¦‚ä½•å­¦ä¹ " class="headerlink" title="1. åº”è¯¥å¦‚ä½•å­¦ä¹ "></a>1. åº”è¯¥å¦‚ä½•å­¦ä¹ </h4><p>ä»¥å¾€å§ï¼Œä¸ºäº†é¢è¯•å‡†å¤‡ï¼Œä¸œå­¦å­¦è¥¿å­¦å­¦ï¼Œä¸€å¤©ä¸‹æ¥ï¼Œå­¦ä¹ å¥½å‡ ä¸ªæ¯«ä¸ç›¸å…³çš„å‡ ä¸ªæ–¹é¢çš„çŸ¥è¯†ï¼Œä½†åˆ°äº†é¢è¯•æ—¶å€™ï¼Œè¢«é—®åˆ°ä¹Ÿåªèƒ½è¯´å‡ºä¸ªå¤§æ¦‚ï¼Œä¹Ÿå°±æ˜¯è¯´å­¦ä¹ è¿‡åçš„<br>çŸ¥è¯†å¾ˆå¤šè¢«å¿˜äº†ï¼Œå†è¿‡ä¸ªå‡ å¤©åŸºæœ¬å°±è¦é‡æ–°å¤ä¹ ä¸€è¾¹æ‰èƒ½æƒ³èµ·ã€‚<br>å‰æ®µæ—¶é—´ï¼Œéƒ½åœ¨å­¦ä¹ JVMç›¸å…³çš„çŸ¥è¯†ï¼ŒæœŸé—´æŸäº›çŸ¥è¯†ç‚¹ä¼šå½¼æ­¤äº§ç”Ÿå…³è”åŠ æ·±è®°å¿†å’Œç†è§£</p>
<h4 id="2-å¦‚ä½•æŠ•å…¥è®¤çœŸåšäº‹"><a href="#2-å¦‚ä½•æŠ•å…¥è®¤çœŸåšäº‹" class="headerlink" title="2. å¦‚ä½•æŠ•å…¥è®¤çœŸåšäº‹"></a>2. å¦‚ä½•æŠ•å…¥è®¤çœŸåšäº‹</h4><p>æ€»ç»“å‡ ä¸ªæœˆæ—¶é—´åœ¨å®¶åœ¨å’–å•¡å…å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œå“ªäº›æ—¶å€™è®¤çœŸäº†å¹¶å¾—åˆ°äº†æƒ…ç»ªä¸Šçš„æ»¡è¶³æ„Ÿï¼Œåˆæœ‰å“ªäº›æ—¶å€™éƒ½åœ¨æƒ³çŒç¡å’Œæµªè´¹æ—¶é—´<br>åœ¨æ²¡æœ‰ç›®æ ‡ï¼Œæ²¡æœ‰æ˜ç¡®çš„éœ€æ±‚ç»“æœçš„æƒ…å†µä¸‹ï¼Œä½ å­¦ä¹ çš„æŠ•å…¥æ—¶é—´å¤§æ¦‚æœ€å¤šä¹Ÿå°±20åˆ†é’Ÿå§ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ æƒ³çš„åªæ˜¯æˆ‘æƒ³å¤šå­¦ç‚¹ï¼Œèƒ½å¤šå­¦ç‚¹å°±è¡Œï¼Œè€Œè¿™ä¸ªè¿‡ç¨‹<br>æ²¡æœ‰ä»»ä½•æ—¶åˆ»æœ‰æˆå°±æ„Ÿæ¥æä¾›ä½ ç»§ç»­å­¦ä¹ ä¸‹å»çš„åŠ¨åŠ›ï¼Œå®Œå…¨æ— æ³•æŠ•å…¥å­¦ä¹ äº«å—è¿™ä¸ªè¿‡ç¨‹ã€‚<br>è€Œæœ‰æ˜ç¡®ç›®æ ‡å’Œéœ€æ±‚çš„æƒ…å†µä¸‹ï¼Œå°±æ¯”å¦‚å·¥ä½œï¼Œäº§å“ç»™ä½ ä¸€ä¸ªéœ€æ±‚ï¼Œä½ åœ¨åšè¿™ä¸ªéœ€æ±‚çš„æ—¶å€™ï¼Œæˆ‘éœ€è¦è§£å†³ä»€ä¹ˆé—®é¢˜ï¼Œç„¶åé€šè¿‡ä¸€é€šæŸ¥é˜…èµ„æ–™äº†è§£ï¼Œç„¶åå¶å°”å‘ç°è¦è¾¾åˆ°<br>è¿™ä¸ªç›®çš„éœ€è¦äº†è§£å¦å¤–ä¸€äº›ï¼Œåˆæ˜¯ä¸€é¡¿æ“ä½œåï¼Œå¤§è‡´æ¥è¿‘å®Œæˆéœ€æ±‚ã€‚è€Œè¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä½ æ¯ä¸ªå°è¿‡ç¨‹éƒ½æœ‰ä¸€å®šçš„è¾“å‡ºè®©ä½ è§‰å¾—æœ‰æ‰€æˆå°±ï¼Œæœ€ç»ˆå®Œæˆéœ€æ±‚ã€‚å¦‚æœæ˜¯è¿™æ ·çš„ä¸€ä¸ª<br>æµç¨‹ï¼Œç›¸ä¿¡ä½ å·¥ä½œçš„æ—¶å€™ä¼šéå¸¸è®¤çœŸå’ŒæŠ•å…¥ï¼Œé«˜æ•ˆç‡ã€‚</p>
<h3 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h3><p>ä¸ªäººä¸€äº›ç»å†ï¼Œæ„Ÿè§‰æœ‰äº›è¡¨è¾¾ä¸æ˜¯å¾ˆæ¸…æ¥šï¼Œè¿˜åœ¨åŠªåŠ›æå‡è¡¨è¾¾å’Œå†™ä½œèƒ½åŠ›ä¸­ã€‚<br>æˆ‘ä»¬è¦æœ‰ç›®çš„å’Œç³»ç»Ÿæ€§çš„å­¦ä¹ ï¼Œæ‰èƒ½å¿«é€Ÿæˆé•¿ï¼Œåœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­ï¼Œå°½é‡è®©æˆ‘ä»¬æœ‰è¾“å‡ºï¼Œå› ä¸ºåªæœ‰è¾“å‡ºæ‰ä¼šæœ‰æˆå°±æ„Ÿæ‰ä¼šæœ‰åŠ¨åŠ›ç»§ç»­ã€‚</p>
<p>åŠ æ²¹ï¼Œ2023ä¸‹åŠå¹´</p>
]]></content>
      <categories>
        <category>éšè®°</category>
      </categories>
      <tags>
        <tag>2023</tag>
      </tags>
  </entry>
  <entry>
    <title>Composeçš„é‡ç»„ä½œç”¨åŸŸ</title>
    <url>/2023/07/06/Scoped-recomposition-in-Jetpack-Compose/</url>
    <content><![CDATA[<p>åœ¨äº†è§£Composeçš„é‡ç»„ä½œç”¨åŸŸä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£ä¸‹é‡ç»„æ˜¯ä»€ä¹ˆ</p>
<h3 id="ä»€ä¹ˆæ˜¯é‡ç»„"><a href="#ä»€ä¹ˆæ˜¯é‡ç»„" class="headerlink" title="ä»€ä¹ˆæ˜¯é‡ç»„"></a>ä»€ä¹ˆæ˜¯é‡ç»„</h3><p>å¯¹äºJetpack Composeï¼Œå³ä½¿æ˜¯åˆå­¦è€…ä¹Ÿéƒ½çŸ¥é“å®ƒè¢«ç§°ä¸ºå£°æ˜å¼UIå¼€å‘ï¼Œç›¸å¯¹äºä¹‹å‰é€šè¿‡xmlæ–¹å¼çš„å‘½ä»¤å¼UIã€‚è€Œåœ¨å‘½ä»¤å¼UIæ¨¡å¼ä¸‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦æ›´æ–°ä¸€ä¸ªwidgetï¼Œæˆ‘ä»¬éœ€è¦æ‹¿åˆ°è¿™ä¸ªwidgeté€šè¿‡è°ƒç”¨å…¶setterå‡½æ•°æ¥æ”¹å˜å…¶å†…éƒ¨çŠ¶æ€ã€‚ä½†æ˜¯Jetpack Composeä¸­çš„widgetç›¸å¯¹æ— çŠ¶æ€å¹¶ä¸æä¾›setter/getterå‡½æ•°ï¼Œè€Œæ˜¯é‡æ–°è°ƒç”¨å¯ç»„åˆå‡½æ•°æ¥å®ç°æ›´æ–°ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±å«é‡ç»„ã€‚ç›®å‰Jetpack Composeé‡ç»„æ˜¯åœ¨UIçº¿ç¨‹æ‰§è¡Œçš„ï¼Œæ‰€ä»¥é‡ç»„è¿‡ç¨‹æ˜¯æœ‰æ€§èƒ½æ¶ˆè€—çš„ã€‚ä¸ºæ­¤ï¼ŒComposeç¼–è¯‘å™¨å†…éƒ¨åšäº†å¤§é‡å·¥ä½œä¿è¯é‡ç»„çš„èŒƒå›´å°½å¯èƒ½å°æ¥æå‡é‡ç»„æ•ˆç‡ã€‚</p>
<h3 id="é‡ç»„èŒƒå›´"><a href="#é‡ç»„èŒƒå›´" class="headerlink" title="é‡ç»„èŒƒå›´"></a>é‡ç»„èŒƒå›´</h3><p>é‡ç»„èŒƒå›´åœ¨Composeä¸­æ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç»„æˆéƒ¨ä»½ï¼Œé€šè¿‡å°½é‡ç¼©å°é‡ç»„èŒƒå›´æ¥å‡å°‘Composeåœ¨å‡†å¤‡æ¯ä¸€å¸§æ—¶çš„å·¥ä½œé‡ã€‚</p>
<ul>
<li>å®ƒä»¬æ˜¯é€šè¿‡é‡ç»„æ›´æ–°ComposeèŠ‚ç‚¹çš„æœ€å°å•ä½</li>
<li>å®ƒä»¬é€šè¿‡è·Ÿè¸ªè§‚å¯ŸåŸºäºå¿«ç…§çš„çŠ¶æ€å¯¹è±¡ï¼Œå¹¶åœ¨è¿™äº›çŠ¶æ€å˜åŒ–æ—¶ä¼šæ— æ•ˆ<span id="more"></span>
å¯¹äºæ¯ä¸ª<code>non-inline</code>å¹¶ä¸”è¿”å›<code>Unit</code>çš„å¯ç»„åˆå‡½æ•°ï¼Œ Composeç¼–è¯‘å™¨ä¼šç”Ÿæˆä»£ç å°†è¿™ä¸ªå‡½æ•°åŒ…è£…åˆ°ä¸€ä¸ªå¯é‡ç»„å—ä¸­ï¼Œå½“è¿™ä¸ªä»£ç å—è¢«æ ‡è®°ä¸ºInvalidatedæ—¶ï¼ŒCompose Runtimeå°†ç¡®ä¿åœ¨æ¸²æŸ“ä¸‹ä¸€å¸§ä¹‹å‰è¯¥ä»£ç å—è¢«é‡æ–°æ‰§è¡Œï¼ˆé‡ç»„ï¼‰ã€‚<br>PS: <p style="color:red">æ˜¯æ€æ ·è¢«æ ‡è®°ä¸ºInvalidatedï¼Œè¿™å—å…³ç³»åˆ°State/Snapshotæš‚æ—¶ä¸å±•å¼€ï¼Œåæ­£å…ˆè®°ä½ï¼Œä¸ä¾èµ–Stateçš„ä»£ç æ˜¯ä¸å‚ä¸é‡ç»„çš„ã€‚</p></li>
</ul>
<h3 id="ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—"><a href="#ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—" class="headerlink" title="ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—"></a>ä¸ºä»€ä¹ˆè¦non-inlineä¸”æ²¡æœ‰è¿”å›å€¼çš„å‡½æ•°æ‰å¯ä½œä¸ºå¯é‡ç»„å—</h3><p>inlineå‡½æ•°ï¼Œåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ä¼šç›´æ¥å°†å‡½æ•°ä½“æ‹·è´åˆ°è°ƒç”¨å¤„ï¼Œæ‰€ä»¥å®ƒåªèƒ½å…±äº«è°ƒç”¨è€…çš„é‡ç»„èŒƒå›´<br>å¯¹äºæœ‰è¿”å›å€¼çš„å‡½æ•°ï¼Œç”±äºè¿”å›å€¼çš„å˜åŒ–ä¼šå½±å“è°ƒç”¨è€…ï¼Œå› æ­¤æ— æ³•å•ç‹¬é‡ç»„ï¼Œè€Œå¿…é¡»è¿åŒè°ƒç”¨æ–¹ä¸€åŒå‚ä¸é‡ç»„ï¼Œå› æ­¤å®ƒä¸èƒ½ä½œä¸ºå…¥å£è¢«æ ‡è®°ä¸ºinvalid</p>
<h3 id="è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨"><a href="#è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨" class="headerlink" title="è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨"></a>è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨</h3><p>åœ¨æ·±å…¥äº†è§£æœ€å°é‡ç»„èŒƒå›´å‰ï¼Œæˆ‘ä»¬å…ˆäº†è§£ä¸€ä¸ªå…³äºå¸¸è§„æ—§å‡½æ•°è°ƒç”¨å¦‚ä½•å·¥ä½œçš„åŸºæœ¬æ¦‚å¿µã€‚åœ¨Java/Kotlinä¸­ï¼Œå½“ä½ å°†è¡¨è¾¾å¼ä¼ é€’ç»™å‡½æ•°æ—¶ï¼Œè¯¥è¡¨è¾¾å¼ä¼šåœ¨è°ƒç”¨å‡½æ•°ä¸­è®¡ç®—ã€‚</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"hello"</span> <span class="token operator">+</span> <span class="token string">"world"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>å®ƒç­‰ä»·äº</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">val</span> arg <span class="token operator">=</span> <span class="token string">"hello"</span> <span class="token operator">+</span> <span class="token string">"world"</span>
<span class="token function">println</span><span class="token punctuation">(</span>arg<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>ç®€è€Œè¨€ä¹‹ï¼Œå…ˆæ‰§è¡Œè¡¨è¾¾å¼å¾—åˆ°ç»“æœï¼Œåœ¨æ‰§è¡Œå‡½æ•°è°ƒç”¨</p>
<h3 id="ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ"><a href="#ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ" class="headerlink" title="ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ"></a>ç¡®è®¤é‡ç»„ä½œç”¨åŸŸ</h3><p>å¤§è‡´äº†è§£äº†è¡¨è¾¾å¼å’Œå‡½æ•°è°ƒç”¨åï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­è¿‡ä¸€ä¸‹ï¼Œå…ˆçœ‹ä¸‹é¢çš„ä»£ç å—</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Composable</span> <span class="token keyword">fun</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">var</span> text <span class="token keyword">by</span> remember <span class="token punctuation">&#123;</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TAG: Foo Scope"</span><span class="token punctuation">)</span>
    <span class="token function">Button</span><span class="token punctuation">(</span>onClick <span class="token operator">=</span> <span class="token punctuation">&#123;</span> text <span class="token operator">=</span> <span class="token string">"<span class="token interpolation variable">$text</span>\n<span class="token interpolation variable">$text</span>"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TAG: Button lambda Scope"</span><span class="token punctuation">)</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>text<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TAG: Text Scope"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="1-ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„"><a href="#1-ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„" class="headerlink" title="1. ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„"></a>1. ä¸ºä»€ä¹ˆtextæ”¹å˜åï¼Œä¸æ˜¯åªæœ‰Textå‘ç”Ÿé‡ç»„</h4><p>ç‚¹å‡»Buttonæ—¶ï¼ŒState <code>text</code> è¢«é‡æ–°å¤åˆ¶è€Œæ”¹å˜ï¼Œè€ŒState <code>text</code>åªæœ‰Textè®¿é—®åˆ°ï¼Œä¸ºä»€ä¹ˆé‡ç»„èŒƒå›´ä¸æ˜¯åªæœ‰Textï¼Ÿ<br>ä»ä¸Šé¢ä»£ç å—çœ‹ï¼Œæˆ‘ä»¬çŸ¥é“textå…¶å®æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè€ŒTextåˆ™æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œæ‰€ä»¥textè®¡ç®—ç»“æœæ˜¯åœ¨è°ƒç”¨Textä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯Buttonçš„lambda</p>
<h4 id="2-ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„"><a href="#2-ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„" class="headerlink" title="2. ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„"></a>2. ä¸ºä»€ä¹ˆä¸æ˜¯æ•´ä¸ªFooå‘ç”Ÿé‡ç»„</h4><p>æˆ‘ä»¬çŸ¥é“å½“Stateå‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šå‘ç”Ÿé‡ç»„ï¼Œè€ŒFooä¸­æ²¡æœ‰è®¿é—®ä»»ä½•Stateå¯¹è±¡ï¼Œæ‰€ä»¥å®ƒä¸ä¼šå‘ç”Ÿé‡ç»„ã€‚è®©æˆ‘ä»¬ä¿®æ”¹ä¸‹ä»£ç çœ‹çœ‹ï¼Œå°†<code>by</code>æ”¹æˆ<code>=</code>ï¼Œé€»è¾‘å°±æ¸…æ™°äº†</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Composable</span> <span class="token keyword">fun</span> <span class="token function">Foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">val</span> text<span class="token operator">:</span> MutableState<span class="token operator">&lt;</span>String<span class="token operator">></span> <span class="token operator">=</span> remember <span class="token punctuation">&#123;</span> <span class="token function">mutableStateOf</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
    <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TAG: Foo Scope"</span><span class="token punctuation">)</span>
    <span class="token function">Button</span><span class="token punctuation">(</span>onClick <span class="token operator">=</span> <span class="token punctuation">&#123;</span> text<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token string">"<span class="token interpolation"><span class="token delimiter variable">$&#123;</span>text<span class="token punctuation">.</span>value<span class="token delimiter variable">&#125;</span></span>\n<span class="token interpolation"><span class="token delimiter variable">$&#123;</span>text<span class="token punctuation">.</span>value<span class="token delimiter variable">&#125;</span></span>"</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TAG: Button lambada Scope"</span><span class="token punctuation">)</span>
        <span class="token function">Text</span><span class="token punctuation">(</span>text<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">also</span> <span class="token punctuation">&#123;</span>
            <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"TAG: Text Scope"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>æ˜¾è€Œæ˜“è§ï¼Œtextä¸€ç›´éƒ½æ˜¯åŒä¸€ä¸ªMutableStateå¯¹è±¡ï¼Œä¿®æ”¹çš„åªä¸è¿‡æ˜¯å®ƒå†…éƒ¨æŒæœ‰çš„valueï¼Œè€Œvalueåœ¨Textä¸­è®¿é—®</p>
<h4 id="3-ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„"><a href="#3-ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„" class="headerlink" title="3. ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„"></a>3. ä¸ºä»€ä¹ˆä¸æ˜¯Buttonå‘ç”Ÿé‡ç»„</h4><p>å› ä¸º<code>Foo</code>æ²¡å‘ç”Ÿé‡ç»„ï¼Œæ‰€ä»¥é‡ç»„æ—¶å¹¶ä¸ä¼šè°ƒç”¨Buttonå‡½æ•°</p>
<h4 id="4-onClick-lambadaè¡¨è¾¾å¼å‘¢"><a href="#4-onClick-lambadaè¡¨è¾¾å¼å‘¢" class="headerlink" title="4. onClick lambadaè¡¨è¾¾å¼å‘¢"></a>4. onClick lambadaè¡¨è¾¾å¼å‘¢</h4><p>é‡ç»„èŒƒå›´åªèƒ½æ˜¯åœ¨å¯é‡ç»„å‡½æ•°ä¸­ï¼Œå³ä½¿handlersï¼Œ<code>Button</code>çš„<code>onClick</code>éƒ½ä¸æ˜¯å¯é‡ç»„å‡½æ•°ã€‚æ‰€ä»¥è¿™ç§å‡½æ•°ä¸åœ¨é‡ç»„èŒƒå›´å†…ã€‚</p>
<h3 id="é‡ç»„ä¸­-Inline-çš„å‘"><a href="#é‡ç»„ä¸­-Inline-çš„å‘" class="headerlink" title="é‡ç»„ä¸­ Inline çš„å‘"></a>é‡ç»„ä¸­ Inline çš„å‘</h3><p>å‰é¢ä¹Ÿæåˆ°äº†ï¼Œinlineå‡½æ•°æ˜¯å°†ä»£ç æ‹·è´ï¼Œæ‰€ä»¥å…±äº«è°ƒç”¨è€…çš„é‡ç»„èŒƒå›´ã€‚åœ¨Composeä¸­å¾ˆå¤šå¸¸è§çš„widgetè¢«ä¿®é¥°æˆinlineå‡½æ•°çš„ï¼Œæ¯”å¦‚<code>Column</code>,<code>Row</code>,<code>Box</code>ç­‰ã€‚</p>
<p>åŸæ–‡åœ°å€ï¼š<a href="https://dev.to/zachklipp/scoped-recomposition-jetpack-compose-what-happens-when-state-changes-l78">Scoped recomposition in Jetpack Compose â€” what happens when state changes?</a></p>
]]></content>
      <categories>
        <category>Android</category>
      </categories>
      <tags>
        <tag>Jetpack Compose</tag>
        <tag>Android</tag>
      </tags>
  </entry>
  <entry>
    <title>TCPåè®®çš„3æ¬¡æ¡æ‰‹</title>
    <url>/2023/08/28/TCP-3ways-handshake/</url>
    <content><![CDATA[<h3 id="TCP"><a href="#TCP" class="headerlink" title="TCP"></a>TCP</h3><p>TCPï¼ˆå…¨ç§°ï¼šTransmission Control Protocolï¼‰æ˜¯è®¡ç®—æœºç½‘ç»œä¸­ç”¨äºè®¾å¤‡é—´é€šä¿¡çš„ä¼ è¾“å±‚åè®®çš„ä¸€ç§ï¼Œå®ƒæ˜¯é¢å‘è¿æ¥çš„ä¼ è¾“åè®®ï¼Œ<br>è¿˜æä¾›äº†å„ç§æœºåˆ¶ä¿è¯ä¼ è¾“è¿‡ç¨‹çš„å¯é æ€§ï¼ŒåŒ…æ‹¬é”™è¯¯æ£€æŸ¥ï¼Œæµé‡æ§åˆ¶ç­‰æœºåˆ¶ã€‚</p>
<h3 id="3æ¬¡æ¡æ‰‹"><a href="#3æ¬¡æ¡æ‰‹" class="headerlink" title="3æ¬¡æ¡æ‰‹"></a>3æ¬¡æ¡æ‰‹</h3><p>è¦æ¸…æ™°ç†è§£3æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹ï¼Œå…ˆæ¥æƒ³2ä¸ªé—®é¢˜ï¼š</p>
<ol>
<li>3æ¬¡æ¡æ‰‹çš„ç›®çš„æ˜¯ä»€ä¹ˆï¼Ÿ</li>
<li>é€šè¿‡ä»€ä¹ˆä¿è¯æ¡æ‰‹è¿‡ç¨‹å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’ç†è§£ï¼Ÿ</li>
</ol>
<h4 id="ç›®çš„"><a href="#ç›®çš„" class="headerlink" title="ç›®çš„"></a>ç›®çš„</h4><p>ç›®çš„ï¼ŸTCPæ˜¯é¢å‘è¿æ¥çš„ï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾ï¼Œ3æ¬¡æ¡æ‰‹çš„ç›®çš„æ˜¯å»ºç«‹è¿æ¥ã€‚</p>
<h4 id="é€šè¿‡ä»€ä¹ˆæ•°æ®-æˆ–ä¿¡æ¯-ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’ç†è§£å¹¶æˆåŠŸå»ºç«‹è¿æ¥ï¼Ÿ"><a href="#é€šè¿‡ä»€ä¹ˆæ•°æ®-æˆ–ä¿¡æ¯-ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’ç†è§£å¹¶æˆåŠŸå»ºç«‹è¿æ¥ï¼Ÿ" class="headerlink" title="é€šè¿‡ä»€ä¹ˆæ•°æ®(æˆ–ä¿¡æ¯)ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’ç†è§£å¹¶æˆåŠŸå»ºç«‹è¿æ¥ï¼Ÿ"></a>é€šè¿‡ä»€ä¹ˆæ•°æ®(æˆ–ä¿¡æ¯)ä½¿å¾—å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç›¸äº’ç†è§£å¹¶æˆåŠŸå»ºç«‹è¿æ¥ï¼Ÿ</h4><p>æ—¢ç„¶æ˜¯å»ºç«‹è¿æ¥ï¼Œé‚£è‡ªç„¶éœ€è¦æ²Ÿé€šï¼Œ3æ¬¡æ¡æ‰‹å°±æ˜¯3æ¬¡æ²Ÿé€šçš„è¿‡ç¨‹ï¼Œåœ¨è¿™ä¸ªæ²Ÿé€šçš„è¿‡ç¨‹ä¸­å»ºç«‹èµ·è¿æ¥ã€‚æ—¢ç„¶æœ‰æ²Ÿé€šå°±éœ€è¦æ¶ˆæ¯æ‰¿è½½æ²Ÿé€šä¿¡æ¯ã€‚</p>
<span id="more"></span>
<p>é¦–å…ˆäº†è§£ä¸‹TCPæŠ¥æ–‡é¦–éƒ¨å­—æ®µ (<a href="%22https://developer.aliyun.com/article/975295%22">æ‹·è´æ¥æº</a>)</p>
<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">-</span> 16ä½ç«¯å£å·ï¼šæºç«¯å£å·ï¼Œä¸»æœºè¯¥æŠ¥æ–‡æ®µæ˜¯æ¥è‡ªå“ªé‡Œï¼›ç›®æ ‡ç«¯å£å·ï¼Œè¦ä¼ ç»™å“ªä¸ªä¸Šå±‚åè®®æˆ–åº”ç”¨ç¨‹åº
<span class="token list punctuation">-</span> 32ä½åºå·ï¼šä¸€æ¬¡TCPé€šä¿¡ï¼ˆä»TCPè¿æ¥å»ºç«‹åˆ°æ–­å¼€ï¼‰è¿‡ç¨‹ä¸­æŸä¸€ä¸ªä¼ è¾“æ–¹å‘ä¸Šçš„å­—èŠ‚æµçš„æ¯ä¸ªå­—èŠ‚çš„ç¼–å·ã€‚
<span class="token list punctuation">-</span> 32ä½ç¡®è®¤å·ï¼šç”¨ä½œå¯¹å¦ä¸€æ–¹å‘é€çš„tcpæŠ¥æ–‡æ®µçš„å“åº”ã€‚å…¶å€¼æ˜¯æ”¶åˆ°çš„TCPæŠ¥æ–‡æ®µçš„åºå·å€¼åŠ 1ã€‚
<span class="token list punctuation">-</span> 4ä½å¤´éƒ¨é•¿åº¦ï¼šè¡¨ç¤ºtcpå¤´éƒ¨æœ‰å¤šå°‘ä¸ª32bitå­—ï¼ˆ4å­—èŠ‚ï¼‰ã€‚å› ä¸º4ä½æœ€å¤§èƒ½æ ‡è¯†15ï¼Œæ‰€ä»¥TCPå¤´éƒ¨æœ€é•¿æ˜¯60å­—èŠ‚ã€‚
<span class="token list punctuation">-</span> 6ä½æ ‡å¿—ä½ï¼šURG(ç´§æ€¥æŒ‡é’ˆæ˜¯å¦æœ‰æ•ˆ)ï¼ŒACKï¼ˆè¡¨ç¤ºç¡®è®¤å·æ˜¯å¦æœ‰æ•ˆï¼‰ï¼ŒPSHï¼ˆç¼“å†²åŒºå°šæœªå¡«æ»¡ï¼‰ï¼ŒRSTï¼ˆè¡¨ç¤ºè¦æ±‚å¯¹æ–¹é‡æ–°å»ºç«‹è¿æ¥ï¼‰ï¼ŒSYNï¼ˆå»ºç«‹è¿æ¥æ¶ˆæ¯æ ‡å¿—æ¥ï¼‰ï¼ŒFINï¼ˆè¡¨ç¤ºå‘ŠçŸ¥å¯¹æ–¹æœ¬ç«¯è¦å…³é—­è¿æ¥äº†ï¼‰
<span class="token list punctuation">-</span> 16ä½çª—å£å¤§å°ï¼šæ˜¯TCPæµé‡æ§åˆ¶çš„ä¸€ä¸ªæ‰‹æ®µã€‚è¿™é‡Œè¯´çš„çª—å£ï¼ŒæŒ‡çš„æ˜¯æ¥æ”¶é€šå‘Šçª—å£ã€‚å®ƒå‘Šè¯‰å¯¹æ–¹æœ¬ç«¯çš„TCPæ¥æ”¶ç¼“å†²åŒºè¿˜èƒ½å®¹çº³å¤šå°‘å­—èŠ‚çš„æ•°æ®ï¼Œè¿™æ ·å¯¹æ–¹å°±å¯ä»¥æ§åˆ¶å‘é€æ•°æ®çš„é€Ÿåº¦ã€‚
<span class="token list punctuation">-</span> 16ä½æ ¡éªŒå’Œï¼šç”±å‘é€ç«¯å¡«å……ï¼Œæ¥æ”¶ç«¯å¯¹TCPæŠ¥æ–‡æ®µæ‰§è¡ŒCRCç®—æ³•ä»¥æ£€éªŒTCPæŠ¥æ–‡æ®µåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­æ˜¯å¦æŸåã€‚æ³¨æ„ï¼Œè¿™ä¸ªæ ¡éªŒä¸ä»…åŒ…æ‹¬TCPå¤´éƒ¨ï¼Œä¹ŸåŒ…æ‹¬æ•°æ®éƒ¨åˆ†ã€‚è¿™ä¹Ÿæ˜¯TCPå¯é ä¼ è¾“çš„ä¸€ä¸ªé‡è¦ä¿éšœã€‚
<span class="token list punctuation">-</span> 16ä½ç´§æ€¥æŒ‡é’ˆï¼šä¸€ä¸ªæ­£çš„åç§»é‡ã€‚å®ƒå’Œåºå·å­—æ®µçš„å€¼ç›¸åŠ è¡¨ç¤ºæœ€åä¸€ä¸ªç´§æ€¥æ•°æ®çš„ä¸‹ä¸€å­—èŠ‚çš„åºå·ã€‚å› æ­¤ï¼Œç¡®åˆ‡åœ°è¯´ï¼Œè¿™ä¸ªå­—æ®µæ˜¯ç´§æ€¥æŒ‡é’ˆç›¸å¯¹å½“å‰åºå·çš„åç§»ï¼Œä¸å¦¨ç§°ä¹‹ä¸ºç´§æ€¥åç§»ã€‚TCPçš„ç´§æ€¥æŒ‡é’ˆæ˜¯å‘é€ç«¯å‘æ¥æ”¶ç«¯å‘é€ç´§æ€¥æ•°æ®çš„æ–¹æ³•ã€‚<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<p>çœ‹åˆ°æ ‡å¿—ä½äº†æ²¡ï¼Ÿå¯¹äº3æ¬¡æ¡æ‰‹å’Œ4æ¬¡æŒ¥æ‰‹ï¼Œæˆ‘ä»¬åªå…³æ³¨ä»¥ä¸‹3ä¸ªï¼š</p>
<ul>
<li>SYN -&gt; Synchronizeçš„ç¼©å†™ï¼Œè¡¨ç¤ºè¯·æ±‚åˆå§‹åŒ–æˆ–å»ºç«‹è¿æ¥</li>
<li>ACK -&gt; Acknowledgementçš„ç¼©å†™ï¼Œè¡¨ç¤ºç¡®è®¤æ”¶åˆ°è¯·æ±‚æ¶ˆæ¯æ•°æ®</li>
<li>FIN -&gt; Finalçš„ç¼©å†™ï¼Œè¯·æ±‚ç»ˆæ­¢ä¸€ä¸ªè¿æ¥</li>
</ul>
<p>æ•°æ®åŒ…å¤´éƒ¨å­—æ®µï¼š</p>
<ul>
<li>seq -&gt; Sequence number, åºåˆ—å·ï¼Œç”¨äºæ²Ÿé€šå¹¶ç¡®ä¿æ¶ˆæ¯é¡ºåºçš„</li>
<li>ack -&gt; Acknowledge numberï¼Œæ˜¯å¯¹ä¸Šä¸€ä¸ªåŒ…çš„åºå·è¿›è¡Œç¡®è®¤çš„å·ï¼Œack = seq + 1</li>
</ul>
<p>è¿‡ç¨‹ç¤ºæ„å›¾ï¼š<br><img src="/images/tcp_3ways_handshake.png" alt="3Ways Handshake" title="3Ways Handshake"><br>ç»è¿‡3æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥ï¼š</p>
<ul>
<li><h5 id="ç¬¬ä¸€æ¬¡æ¡æ‰‹"><a href="#ç¬¬ä¸€æ¬¡æ¡æ‰‹" class="headerlink" title="ç¬¬ä¸€æ¬¡æ¡æ‰‹"></a>ç¬¬ä¸€æ¬¡æ¡æ‰‹</h5>Clientå°†SYNè®¾ç½®ä¸º1ï¼Œå¹¶éšæ„ç”Ÿæˆä¸€ä¸ªåºåˆ—å·å€¼ä¸ºx(seq = x)ï¼ŒåŒ…è£…å¥½æ•°æ®åŒ…å‘é€è‡³Serverï¼Œè¿›å…¥ç­‰å¾…Serverç¡®è®¤çŠ¶æ€ã€‚</li>
<li><h5 id="ç¬¬äºŒæ¬¡æ¡æ‰‹"><a href="#ç¬¬äºŒæ¬¡æ¡æ‰‹" class="headerlink" title="ç¬¬äºŒæ¬¡æ¡æ‰‹"></a>ç¬¬äºŒæ¬¡æ¡æ‰‹</h5>Serveræ”¶åˆ°SYNæ¶ˆæ¯ï¼ŒçŸ¥é“Clientæƒ³å»ºç«‹è¿æ¥ï¼Œå¹¶ä½œå‡ºå›åº”ã€‚SYNå’ŒACKè®¾ç½®ä¸º1ï¼Œack number = x + 1ï¼Œéšæœºäº§ç”Ÿä¸€ä¸ªåºåˆ—å·y<br>ç»™seqï¼ŒåŒ…è£…æ•°æ®åŒ…å‘é€ç»™Clientï¼ŒServerè¿›å…¥å·²æ¥å—å¹¶å›åº”çŠ¶æ€ã€‚</li>
<li><h5 id="ç¬¬ä¸‰æ¬¡æ¡æ‰‹"><a href="#ç¬¬ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ç¬¬ä¸‰æ¬¡æ¡æ‰‹"></a>ç¬¬ä¸‰æ¬¡æ¡æ‰‹</h5>Clientæ”¶åˆ°Serverçš„ç¡®è®¤å›åº”åï¼Œæ‹¿åˆ°ç¡®è®¤å›åº”çš„æ•°æ®ï¼Œæ£€æŸ¥å¯¹åº”çš„æ•°æ®æ˜¯å¦æ­£ç¡®ï¼š<pre class="line-numbers language-markdown" data-language="markdown"><code class="language-markdown"><span class="token list punctuation">1.</span> ack æ˜¯å¦ä¸º x+1
<span class="token list punctuation">2.</span> ACK æ˜¯å¦å’ŒClientè¯·æ±‚æ—¶ä¸€è‡´<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
ç»è¿‡ä¸Šé¢æ•°æ®æ£€æŸ¥é€šè¿‡åï¼ŒåŒæ ·éœ€è¦ç»™Serverå‘é€ç¡®è®¤å›åº”æ¶ˆæ¯ï¼ŒServerå†æ”¶åˆ°å›åº”æ¶ˆæ¯åŒæ ·åšä»¥ä¸Š2æ­¥æ£€æŸ¥ã€‚<br>å¦‚æœæ£€æŸ¥é€šè¿‡ï¼Œåˆ™è¿æ¥å»ºç«‹æˆåŠŸã€‚Clientå’ŒServerè¿›å…¥<code>ESTABLISHED</code>çŠ¶æ€ã€‚å®Œæˆ3æ¬¡æ¡æ‰‹ã€‚æ¥ä¸‹æ¥å¯ä»¥ç›¸äº’å¼€å§‹ä¼ è¾“æ•°æ®äº†ã€‚</li>
</ul>
<h3 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h3><p><a href="https://www.geeksforgeeks.org/tcp-3-way-handshake-process/">TCP 3-Way Handshake Process</a><br><a href="https://packetlife.net/blog/2010/jun/7/understanding-tcp-sequence-acknowledgment-numbers/">Understanding TCP Sequence and Acknowledgment Numbers</a></p>
<!-- ### TCPå’ŒUDPä¸¤åè®®çš„åŒºåˆ«ï¼Ÿ -->
<!-- ä½œä¸ºä¸€ä¸ªAndroidå¼€å‘ï¼Œåœ¨é¢è¯•çš„æ—¶å€™ä¹Ÿç»å¸¸ä¼šè¢«é—®åˆ°è¿™ä¸ªé—®é¢˜ã€‚ç¬”è€…ä¸€ç›´å¥½å¥‡é—®è¿™ä¸ªçš„æ„ä¹‰çš„ç‚¹åœ¨å“ªï¼Ÿ -->
<!-- æ¯•ç«Ÿè²Œä¼¼åœ¨ç§»åŠ¨ç«¯å¼€å‘çš„æ—¶å€™å‡ ä¹è¯´å¾ˆå°‘ç”šè‡³æ²¡æœ‰éœ€è¦è€ƒè™‘è¿™æ–¹é¢çš„æƒ…å†µï¼ˆä¹Ÿè®¸ç»éªŒå’Œé¡¹ç›®ä¸Šçš„åŸå› å§ï¼‰ã€‚å“ˆå“ˆå“ˆï¼Œè¿™äº›éƒ½æ˜¯é¢˜å¤–è¯å•¦ï¼ -->
<!-- å›å½’æ­£é¢˜ã€‚ -->

<!-- ### åŒºåˆ« -->
<!-- TCPï¼ˆTransmission Control Protocolï¼‰å’ŒUDPï¼ˆUser Datagram Protocolï¼‰éƒ½æ˜¯ç½‘ç»œä¸­ç”¨äºè®¾å¤‡é—´é€šä¿¡çš„ä¼ è¾“å±‚åè®®ã€‚ -->
<!-- å®ƒä»¬æœ€ä¸»è¦çš„åŒºåˆ«æ˜¯TCPæ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œè€ŒUDPæ˜¯æ— è¿æ¥çš„åè®®ã€‚ -->

<!-- #### 1. å¯é æ€§ -->
<!-- - TCP æ˜¯ä¸€ç§é¢å‘è¿æ¥çš„åè®®ï¼Œè¿™æ„å‘³ç€å®ƒåœ¨å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´å»ºç«‹äº†å¯é æœ‰åºçš„è¿æ¥ã€‚å®ƒä¿è¯æ•°æ®åŒ…ä¼šä»¥æ­£ç¡®çš„é¡ºåºã€æ²¡æœ‰é”™è¯¯åœ°ä¼ é€’ã€‚ -->
<!-- - UDP æ˜¯ä¸€ç§æ— è¿æ¥åè®®ï¼Œä¸åƒ TCP é‚£æ ·æä¾›åŒæ ·çº§åˆ«çš„å¯é æ€§ã€‚å®ƒä¸èƒ½ä¿è¯æ‰€æœ‰æ•°æ®åŒ…éƒ½ä¼šè¢«ä¼ é€’ï¼Œæ•°æ®åŒ…å¯èƒ½æ— åºåœ°åˆ°è¾¾æˆ–ä¸¢å¤±ï¼Œè€Œä¸”æ²¡æœ‰é€šçŸ¥ã€‚ -->

<!-- #### 2. ä¼ é€’é¡ºåº -->
<!-- - é€šè¿‡ TCP å‘é€çš„æ•°æ®æŒ‰ç…§å‘é€é¡ºåºè¿›è¡Œä¼ é€’ã€‚è¿™å¯¹äºéœ€è¦é¡ºåºä¼ é€’æ•°æ®çš„åº”ç”¨ç¨‹åºï¼ˆå¦‚ç½‘é¡µæˆ–æ–‡ä»¶ä¼ è¾“ï¼‰éå¸¸é‡è¦ã€‚ -->
<!-- - UDP ä¸ä¿è¯ä¼ é€’é¡ºåºã€‚å®ƒé€‚ç”¨äºå®æ—¶é€šä¿¡æ¯”ä¸¥æ ¼é¡ºåºæ›´é‡è¦çš„æƒ…å†µï¼Œæ¯”å¦‚æµåª’ä½“æˆ–åœ¨çº¿æ¸¸æˆç­‰ã€‚ -->

<!-- #### 3. é”™è¯¯æ£€æŸ¥ -->
<!-- - TCP æä¾›é”™è¯¯æ£€æŸ¥æœºåˆ¶ä»¥ç¡®ä¿æ•°æ®å®Œæ•´æ€§ã€‚å¦‚æœæ•°æ®åŒ…ä¸¢å¤±æˆ–æŸåï¼ŒTCP å°†è¯·æ±‚é‡æ–°ä¼ è¾“ç¼ºå¤±æˆ–æŸåçš„æ•°æ®ã€‚ -->
<!-- - UDP ä¸æ‰§è¡Œé”™è¯¯æ£€æŸ¥æˆ–çº æ­£ã€‚å¦‚æœéœ€è¦ï¼Œåº”ç”¨ç¨‹åºéœ€è¦å¤„ç†ä»»ä½•é”™è¯¯ã€‚ -->

<!-- #### 4. æµé‡æ§åˆ¶ -->
<!-- - TCP ä½¿ç”¨æµé‡æ§åˆ¶æœºåˆ¶æ¥ç®¡ç†å‘é€è€…å’Œæ¥æ”¶è€…ä¹‹é—´çš„æ•°æ®ä¼ è¾“é€Ÿç‡ã€‚è¿™æœ‰åŠ©äºé˜²æ­¢æ‹¥å¡ï¼Œå¹¶ç¡®ä¿æ¥æ”¶è€…èƒ½å¤Ÿå¤„ç†ä¼ å…¥çš„æ•°æ®ã€‚ -->
<!-- - UDP ä¸åŒ…æ‹¬å†…ç½®çš„æµé‡æ§åˆ¶æœºåˆ¶ã€‚å¦‚æœæ•°æ®å‘é€è¿‡å¿«ï¼Œå®ƒå¯èƒ½ä¼šè¶…è´Ÿè·åœ°å½±å“æ¥æ”¶è€…ã€‚ -->

<!-- #### 5. èµ„æºå¼€é”€ -->
<!-- - TCP çš„å¼€é”€è¾ƒé«˜ï¼Œå› ä¸ºéœ€è¦é¢å¤–çš„è¿æ¥å»ºç«‹ã€é”™è¯¯æ£€æŸ¥å’Œæµé‡æ§åˆ¶æœºåˆ¶ã€‚ -->
<!-- - UDP çš„å¼€é”€è¾ƒä½ã€‚ -->]]></content>
      <tags>
        <tag>Interview</tag>
      </tags>
  </entry>
  <entry>
    <title>RPC with Kotlinx Serialization</title>
    <url>/2022/06/08/RPC-with-Kotlinx-Serialization/</url>
    <content><![CDATA[<blockquote>
<p>å› ä¸ºå°†é¡¹ç›®ä»Retrofitåˆ‡æ¢åˆ°Ktorå’Œgsonåˆ‡æ¢åˆ°kotlinx serializeã€‚è€Œkotlinx serializeå’Œgsonçš„å®ç°å·®å¼‚å¯¼è‡´åœ¨rpcæ¥å£ä¸­å¯¹äºrpc è¯·æ±‚å‚æ•°ç±»å‹ä¸ä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œåºåˆ—åŒ–å‡ºç°äº†å¼‚å¸¸æŠ¥é”™ï¼Œæ¯”å¦‚ç±»ä¼¼ä¸€ä¸‹çš„è¯·æ±‚Body</p>
</blockquote>
<pre class="line-numbers language-json" data-language="json"><code class="language-json"><span class="token punctuation">&#123;</span>
    <span class="token property">"id"</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
    <span class="token property">"jsonrpc"</span><span class="token operator">:</span> <span class="token string">"2.0"</span><span class="token punctuation">,</span>
    <span class="token property">"method"</span><span class="token operator">:</span> <span class="token string">"eth_call"</span><span class="token punctuation">,</span>
    <span class="token property">"params"</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">&#123;</span>
            <span class="token property">"data"</span><span class="token operator">:</span> <span class="token string">"0x5ec88c7900000000000000000000000081080a7e991bcdddba8c2302a70f45d6bd369ab5"</span><span class="token punctuation">,</span>
            <span class="token property">"from"</span><span class="token operator">:</span> <span class="token string">"0x81080a7e991bcDdDBA8C2302A70f45d6Bd369Ab5"</span><span class="token punctuation">,</span>
            <span class="token property">"to"</span><span class="token operator">:</span> <span class="token string">"0xb3831584acb95ED9cCb0C11f677B5AD01DeaeEc0"</span>
        <span class="token punctuation">&#125;</span><span class="token punctuation">,</span>
        <span class="token string">"latest"</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="List-lt-Any-gt-Contextual"><a href="#List-lt-Any-gt-Contextual" class="headerlink" title="List&lt;Any&gt; + @Contextual"></a><code>List&lt;Any&gt;</code> + @Contextual</h3><p>æœ¬æ¥ä»¥ä¸ºåœ¨Kotlinx Serializeä¸Šä¼šåƒGsonä¸€æ ·è½»æ¾è§£å†³ï¼Œä¸€å¼€å§‹ä¾¿å¯¹äºåŸæ¥çš„æ•°æ®ç»“æ„å®šä¹‰æˆ</p>
<span id="more"></span>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Serializable</span>
<span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">TestBaseRpc</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> jsonrpc<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> method<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> params<span class="token operator">:</span> List<span class="token operator">&lt;</span><span class="token annotation builtin">@Contextual</span> Any<span class="token operator">></span><span class="token punctuation">,</span>
    <span class="token keyword">val</span> id<span class="token operator">:</span> Int
<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å¹¶åœ¨Json é…ç½®çš„æ—¶å€™å°† Contextualé…ç½®ä¸Š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">Json <span class="token punctuation">&#123;</span>
    useArrayPolymorphism <span class="token operator">=</span> <span class="token boolean">true</span>
    prettyPrint <span class="token operator">=</span> <span class="token boolean">true</span>
    allowStructuredMapKeys <span class="token operator">=</span> <span class="token boolean">true</span>
    serializersModule <span class="token operator">=</span> SerializersModule <span class="token punctuation">&#123;</span>
        <span class="token function">contextual</span><span class="token punctuation">(</span>Any<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            TestCaller<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            String<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>å°†å•å…ƒæµ‹è¯•ä»£ç è·‘èµ·æ¥åå‘ç°ï¼Œcontextual åªä½¿ç”¨äº†æœ€åä¸€ä¸ªserializeræ¥è§£æAnyç±»å‹ï¼Œæ‰€ä»¥è¿™ä¸ªæ–¹å‘æ— æ³•å®ç°æƒ³è¦çš„ç»“æœ<br>æŠ¥é”™å¦‚ä¸‹ï¼š<p style="color:red">***.TestCaller cannot be cast to class java.lang.String</p></p>
<blockquote>
<p>Note: å¦‚æœå°†ä¸¤ä¸ªserializerè°ƒæ¢é¡ºåºå°±ä¼šå‘ç°æŠ¥é”™ä¹Ÿä¼šä¸¤ä¸ªç±»å‹äº’æ¢</p>
</blockquote>
<h3 id="é€šè¿‡-Interface-Polymorphic"><a href="#é€šè¿‡-Interface-Polymorphic" class="headerlink" title="é€šè¿‡ Interface + Polymorphic"></a>é€šè¿‡ Interface + Polymorphic</h3><p>polymorphicå¤šæ€çš„æ„æ€ï¼Œé¡¾åæ€ä¹‰ï¼Œå¯ä»¥æ ¹æ®å®é™…æƒ…å†µè¿›è¡Œé€‰æ‹©å¯¹åº”çš„Serializerï¼Œæ‰€ä»¥éœ€è¦æœ‰ä¸€ä¸ªåŸºç±»(å¯ä»¥interfaceï¼Œsealedâ€¦)</p>
<ol>
<li>é¦–å…ˆå®šä¹‰ä¸€ä¸ªinterface<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">interface</span> Parameter<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li>å®šä¹‰subclass<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token annotation builtin">@Serializable</span>
<span class="token keyword">internal</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">CallParameter</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> <span class="token keyword">data</span><span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> from<span class="token operator">:</span> String<span class="token punctuation">,</span>
    <span class="token keyword">val</span> <span class="token keyword">to</span><span class="token operator">:</span> String
<span class="token punctuation">)</span> <span class="token operator">:</span> Parameter

<span class="token annotation builtin">@Serializable</span>
<span class="token keyword">internal</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">IntListParameter</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> items<span class="token operator">:</span> List<span class="token operator">&lt;</span>Int<span class="token operator">></span>
<span class="token punctuation">)</span> <span class="token operator">:</span> Parameter

<span class="token annotation builtin">@Serializable</span>
<span class="token keyword">internal</span> <span class="token keyword">data</span> <span class="token keyword">class</span> <span class="token function">StringParameter</span><span class="token punctuation">(</span>
    <span class="token keyword">val</span> content<span class="token operator">:</span> String
<span class="token punctuation">)</span> <span class="token operator">:</span> Parameter
<span class="token operator">..</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>é…ç½®Jsonæ¨¡å—<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin">Json <span class="token punctuation">&#123;</span>
    useArrayPolymorphism <span class="token operator">=</span> <span class="token boolean">true</span>
    prettyPrint <span class="token operator">=</span> <span class="token boolean">true</span>
    ignoreUnknownKeys <span class="token operator">=</span> <span class="token boolean">true</span>
    allowStructuredMapKeys <span class="token operator">=</span> <span class="token boolean">true</span>
    serializersModule <span class="token operator">=</span> SerializersModule <span class="token punctuation">&#123;</span>
        <span class="token function">polymorphic</span><span class="token punctuation">(</span>List<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">ListSerializer</span><span class="token punctuation">(</span>ParameterSerialize<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
        <span class="token function">polymorphic</span><span class="token punctuation">(</span>Parameter<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">subclass</span><span class="token punctuation">(</span>CallParameter<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> CallParameter<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">subclass</span><span class="token punctuation">(</span>StringParameter<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> StringParameterSerializer<span class="token punctuation">)</span>
            <span class="token function">subclass</span><span class="token punctuation">(</span>IntListParameter<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">,</span> IntListParameterSerializer<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>é’ˆå¯¹ä¸åŒç»“æ„å®šä¹‰ä¸åŒçš„Serializer<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">object</span> IntListParameterSerializer <span class="token operator">:</span> KSerializer<span class="token operator">&lt;</span>IntListParameter<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>decoder<span class="token operator">:</span> Decoder<span class="token punctuation">)</span><span class="token operator">:</span> IntListParameter <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> decoder<span class="token punctuation">.</span><span class="token function">decodeStructure</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">val</span> items <span class="token operator">=</span> <span class="token function">decodeSerializableElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token function">ListSerializer</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token function">IntListParameter</span><span class="token punctuation">(</span>
                items <span class="token operator">=</span> items
            <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">override</span> <span class="token keyword">val</span> descriptor<span class="token operator">:</span> SerialDescriptor
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">buildClassSerialDescriptor</span><span class="token punctuation">(</span><span class="token string">"IntListParameter"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Int<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"items"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">serialize</span><span class="token punctuation">(</span>encoder<span class="token operator">:</span> Encoder<span class="token punctuation">,</span> value<span class="token operator">:</span> IntListParameter<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        encoder<span class="token punctuation">.</span><span class="token function">encodeSerializableValue</span><span class="token punctuation">(</span><span class="token function">ListSerializer</span><span class="token punctuation">(</span>Int<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>items<span class="token punctuation">)</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token annotation builtin">@OptIn</span><span class="token punctuation">(</span>ExperimentalSerializationApi<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token annotation builtin">@Serializer</span><span class="token punctuation">(</span>forClass <span class="token operator">=</span> BaseRpcRequest<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">internal</span> <span class="token keyword">object</span> RpcRequestBodySerializer <span class="token operator">:</span> KSerializer<span class="token operator">&lt;</span>BaseRpcRequest<span class="token operator">></span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">deserialize</span><span class="token punctuation">(</span>decoder<span class="token operator">:</span> Decoder<span class="token punctuation">)</span><span class="token operator">:</span> BaseRpcRequest <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> decoder<span class="token punctuation">.</span><span class="token function">decodeStructure</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">var</span> rpc<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token keyword">var</span> method<span class="token operator">:</span> String<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token keyword">var</span> params<span class="token operator">:</span> List<span class="token operator">&lt;</span>Parameter<span class="token operator">></span> <span class="token operator">=</span> <span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">var</span> id<span class="token operator">:</span> Int<span class="token operator">?</span> <span class="token operator">=</span> <span class="token keyword">null</span>
            <span class="token label symbol">loop@</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token keyword">when</span> <span class="token punctuation">(</span><span class="token function">decodeElementIndex</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                    CompositeDecoder<span class="token punctuation">.</span>DECODE_DONE <span class="token operator">-></span> <span class="token keyword">break</span><span class="token label symbol">@loop</span>

                    <span class="token number">0</span> <span class="token operator">-></span> rpc <span class="token operator">=</span> <span class="token function">decodeStringElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token number">1</span> <span class="token operator">-></span> method <span class="token operator">=</span> <span class="token function">decodeStringElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
                    <span class="token number">2</span> <span class="token operator">-></span> params <span class="token operator">=</span> <span class="token function">decodeSerializableElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">ListSerializer</span><span class="token punctuation">(</span>ParameterSerialize<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token number">3</span> <span class="token operator">-></span> id <span class="token operator">=</span> <span class="token function">decodeIntElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span>
                <span class="token punctuation">&#125;</span>
            <span class="token punctuation">&#125;</span>
            <span class="token function">BaseRpcRequest</span><span class="token punctuation">(</span>
                jsonrpc <span class="token operator">=</span> rpc<span class="token punctuation">.</span><span class="token function">orEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                method <span class="token operator">=</span> method<span class="token punctuation">.</span><span class="token function">orEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                params <span class="token operator">=</span> params<span class="token punctuation">,</span>
                id <span class="token operator">=</span> id <span class="token operator">?:</span> <span class="token number">1</span>
            <span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token keyword">override</span> <span class="token keyword">val</span> descriptor<span class="token operator">:</span> SerialDescriptor
        <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">buildClassSerialDescriptor</span><span class="token punctuation">(</span><span class="token string">"BaseRpcRequest"</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"jsonrpc"</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token operator">&lt;</span>String<span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"method"</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token operator">&lt;</span>List<span class="token operator">&lt;</span>Parameter<span class="token operator">></span><span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"params"</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>element<span class="token operator">&lt;</span>Int<span class="token operator">></span><span class="token punctuation">(</span><span class="token string">"id"</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>

    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">serialize</span><span class="token punctuation">(</span>encoder<span class="token operator">:</span> Encoder<span class="token punctuation">,</span> value<span class="token operator">:</span> BaseRpcRequest<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        encoder<span class="token punctuation">.</span><span class="token function">encodeStructure</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">encodeStringElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>jsonrpc<span class="token punctuation">)</span>
            <span class="token function">encodeStringElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>method<span class="token punctuation">)</span>
            <span class="token function">encodeSerializableElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token function">ListSerializer</span><span class="token punctuation">(</span>ParameterSerialize<span class="token punctuation">)</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>params<span class="token punctuation">)</span>
            <span class="token function">encodeIntElement</span><span class="token punctuation">(</span>descriptor<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> value<span class="token punctuation">.</span>id<span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token operator">..</span><span class="token punctuation">.</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li>å¦‚æœéœ€è¦deserializeï¼Œä¾¿éœ€è¦åŠ ä¸Šå¦‚ä¸‹é€‰æ‹©å™¨<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">internal</span> <span class="token keyword">object</span> ParameterSerialize <span class="token operator">:</span> JsonContentPolymorphicSerializer<span class="token operator">&lt;</span>Parameter<span class="token operator">></span><span class="token punctuation">(</span>Parameter<span class="token operator">::</span><span class="token keyword">class</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">override</span> <span class="token keyword">fun</span> <span class="token function">selectDeserializer</span><span class="token punctuation">(</span>element<span class="token operator">:</span> JsonElement<span class="token punctuation">)</span><span class="token operator">:</span> DeserializationStrategy<span class="token operator">&lt;</span><span class="token keyword">out</span> Parameter<span class="token operator">></span> <span class="token punctuation">&#123;</span>
        <span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"element: <span class="token interpolation variable">$element</span>, obj: <span class="token interpolation"><span class="token delimiter variable">$&#123;</span>element<span class="token punctuation">.</span>jsonObject<span class="token delimiter variable">&#125;</span></span>"</span><span class="token punctuation">)</span>

        <span class="token comment">// override the condition for your point</span>
        <span class="token keyword">return</span> <span class="token keyword">when</span> <span class="token punctuation">&#123;</span>
            <span class="token string">"content"</span> <span class="token keyword">in</span> element<span class="token punctuation">.</span>jsonObject <span class="token operator">-></span> StringParameterSerializer
            <span class="token string">"items"</span> <span class="token keyword">in</span> element<span class="token punctuation">.</span>jsonObject <span class="token operator">-></span> IntListParameterSerializer
            <span class="token keyword">else</span> <span class="token operator">-></span> CallParameter<span class="token punctuation">.</span><span class="token function">serializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
è¿è¡Œå•å…ƒæµ‹è¯•ï¼ŒéªŒè¯é€šè¿‡ï¼š<br><img src="/images/pic1.png" alt="Unit Test Result!" title="Unit Test Result"></li>
</ol>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åªæ˜¯ä¸ºäº†åœ¨é¡¹ç›®ä¸­å‡å°‘gsonçš„ä½¿ç”¨ï¼Œæ‰€ä»¥èŠ±äº†ç‚¹æ—¶é—´éªŒè¯ä¸‹å…·ä½“æƒ…å†µï¼Œä½†æ˜¯ï¼š<br>è™½ç„¶ç›®å‰çœ‹èµ·æ¥æ˜¯è§£å†³äº†é—®é¢˜ï¼Œä¸è¿‡ç›¸å¯¹æ¥è¯´æ¯”è¾ƒéº»çƒ¦ï¼Œå¹¶ä¸”å¦‚æœç±»å‹è¶Šæ¥è¶Šå¤šä¹Ÿä¼šå¢åŠ ä¸å¿…è¦çš„å·¥ä½œé‡ï¼Œæ‰€ä»¥è¿™é‡Œæ›´å»ºè®®ç›´æ¥ä½¿ç”¨gson</p>
]]></content>
      <categories>
        <category>Kotlin</category>
      </categories>
      <tags>
        <tag>Kotlin Serialization</tag>
      </tags>
  </entry>
  <entry>
    <title>TODO List KMM ä»‹ç»</title>
    <url>/2023/08/21/TODO-List-KMM-Project-Introduce/</url>
    <content><![CDATA[<h3 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h3><p>&emsp;TODO List KMMæ˜¯ä¸€ä¸ªåŸºäºKotlin Multiplatform Mobileå®ç°çš„ä¸€ä¸ªå°é¡¹ç›®ï¼Œä¸»è¦æä¾›æŸ¥çœ‹Todo taskåˆ—è¡¨ï¼Œå¢åŠ /åˆ é™¤/ç¼–è¾‘taskåŠŸèƒ½ï¼Œç›®å‰æœ‰åŠ ä¸Šsign in/sign upé¡µé¢ï¼Œä½†æ˜¯æ²¡æœ‰æ•´åˆåç«¯ï¼Œæœ‰æ—¶é—´å¯èƒ½ä¼šåŠ ä¸Šã€‚å½“ç„¶ï¼Œè¿™å¹¶ä¸é‡è¦ï¼Œæœ¬ç¯‡æ–‡ç« ä¸»è¦ä¸ºäº†ä»‹ç»KMMé¡¹ç›®ç»“æ„å’Œå…¬å…±æ¨¡å—æŠ½å–çš„ä¸ªäººæƒ³æ³•å’Œå­¦ä¹ å®è·µè¿‡ç¨‹çš„ä¸€ä¸ªå›é¡¾ã€‚<br>é¡¹ç›®åœ°å€åœ¨æ–‡æœ«ã€‚</p>
<blockquote>
<p>è‡³ä»Šï¼Œè™½ç„¶Kotlin Multiplatformå¯ä»¥ç›´æ¥ä½¿ç”¨Composeå®ç°ä¸¤ç«¯UIäº†ï¼Œä½†æ˜¯å®ƒè¿˜å¤„äºéç¨³å®šç‰ˆæœ¬ï¼Œ<br>è€Œä¸”å®é™…ä¸Šåœ¨iOSä¸Šå­˜åœ¨å¡é¡¿ç°è±¡ï¼Œæ‰€ä»¥TODO Listè¿˜æ˜¯ä½¿ç”¨SwiftUI/Jetpack Composeåˆ†åˆ«å®ç°Android/iOS ç•Œé¢</p>
</blockquote>
<h3 id="åŸºæœ¬ç»“æ„"><a href="#åŸºæœ¬ç»“æ„" class="headerlink" title="åŸºæœ¬ç»“æ„"></a>åŸºæœ¬ç»“æ„</h3><p>&emsp;ä½œä¸ºä¸€ä¸ªKMMé¡¹ç›®ï¼ŒAndroid/iOS è¿™ä¸¤ä¸ªæ¨¡å—æ˜¯å¿…ä¸å¯å°‘çš„ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ç”¨æ¥å®ç°Android/iOSé¡µé¢å’Œä½¿ç”¨æˆ–æ„å»ºæ•°æ®é€»è¾‘ç›¸å…³çš„ä»£ç ï¼Œè€Œsharedå½“ç„¶ä¹Ÿå¾ˆé‡è¦ï¼Œsharedæ˜¯ä¸¤å¹³å°çš„å…±ç”¨ä»£ç ã€‚åœ¨å¤§å¤šæ•°é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬çš„æ•°æ®æ¥æºåŒç«¯éƒ½æ˜¯ä¸€è‡´çš„ï¼Œæ‰€ä»¥sharedæ¨¡å—å®Œå…¨å¯ä»¥ä½œä¸ºä¸€ä¸ªæ•°æ®<br>æä¾›è€…ï¼Œä¸ç®¡æ˜¯æ¥æºæ˜¯åç«¯apiè¿˜æ˜¯æœ¬åœ°ï¼Œéƒ½æ˜¯æ²¡æœ‰ä»»ä½•å¼‚è®®çš„ã€‚å½“ç„¶ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æä¾›ä¸€äº›å·¥å…·æ‰©å±•ç±»ã€‚</p>
<h3 id="é¡¹ç›®åˆ›å»ºå’Œé…ç½®"><a href="#é¡¹ç›®åˆ›å»ºå’Œé…ç½®" class="headerlink" title="é¡¹ç›®åˆ›å»ºå’Œé…ç½®"></a>é¡¹ç›®åˆ›å»ºå’Œé…ç½®</h3><ol>
<li>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªKMMé¡¹ç›®ï¼Œcatalogsç®¡ç†ä¾èµ–åº“çš„æ–¹å¼å¾ˆæ—©å°±è¢«æ¨èä½¿ç”¨äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†å‡†å¤‡å¥½çš„<code>libs.versions.toml</code>æ–‡ä»¶copyåˆ°<code>gradle</code>ç›®å½•ä¸‹<br><code>composite build</code>åŒæ ·ä¹Ÿæ˜¯æ¯”è¾ƒæ¨èçš„ä¸€ç§åšæ³•ï¼Œä»nowinandroidé¡¹ç›®ä¸­copyè¿‡æ¥ï¼Œå¹¶åŠ ä»¥ä¿®æ”¹æ”¾åˆ°æˆ‘ä»¬é¡¹ç›®ä¸­ï¼Œå‘½åä¸º<code>build-logic</code>ï¼Œé‡Œé¢æœ‰æ’ä»¶ï¼Œ<br>è¿™äº›æ’ä»¶æ˜¯ä¸ºäº†å‡å°‘çš„moduleä¸‹çš„gradleé…ç½®æ¨¡æ¿ä»£ç ä»è€Œæ›´æ˜“äºç®¡ç†ã€‚</li>
<li>é…ç½®å¥½é¡¹ç›®ä¹‹åï¼Œç¡®å®šsharedæ¨¡å—ä¸»è¦éœ€è¦å®ç°å“ªäº›æ•°æ®ç›¸å…³çš„åŠŸèƒ½ï¼Œå¹¶å°†å…¶åˆ†æ¨¡å—æ¥å®ç°ï¼Œåœ¨è¯¥é¡¹ç›®ä¸­æœ‰4ä¸ªæ¨¡å—åˆ†åˆ«æ˜¯core, data, database, model.</li>
</ol>
<ul>
<li>2.1 core æä¾›æ ¸å¿ƒå·¥å…·ç±»æˆ–æ‰©å±•æ–¹æ³•</li>
<li>2.2 model å°è£…ä¸Šå±‚éœ€è¦çš„æ•°æ®ç»“æ„ï¼Œç”¨äºUIæˆ–è€…é€»è¾‘éœ€è¦çš„è¿‡åº¦Modelç±»</li>
<li>2.3 database æä¾›æœ¬åœ°å­˜å‚¨å’Œè¯»å–åŠŸèƒ½ä½œç”¨</li>
<li>2.4 data æ•°æ®æºå±‚ï¼Œä¸»è¦æ˜¯combineæœ¬åœ°æˆ–è€…è¿œç¨‹apiæ•°æ®æ¥æºçš„ç»„è£…å’Œmappingç­‰é€»è¾‘<span id="more"></span>
é™¤äº†ä»¥ä¸Šï¼ŒåŒæ ·å¯ä»¥æ·»åŠ ä¸€ä¸ªdomainå±‚ç”¨æ¥å¤„ç†å¤æ‚çš„ç”¨ä¾‹ï¼ˆdomainå±‚æ˜¯å¯æœ‰å¯æ— çš„ï¼‰</li>
</ul>
<ol start="3">
<li>æ ¹æ®é…ç½®ç²¾ç®€å„ä¸ªæ¨¡å—çš„gradle é…ç½®ä¹‹åä¾¿å¯ä»¥ä¸“æ³¨äºä»£ç çš„ç¼–å†™äº†ã€‚åœ¨ç¼–å†™ä»£ç çš„æ—¶å€™ï¼Œè¦è€ƒè™‘å¥½å“ªäº›æ¨¡å—å®ç°å“ªäº›åŠŸèƒ½ï¼Œ<br>è§£è€¦ä¹‹ç±»çš„é—®é¢˜ã€‚<blockquote>
<p>Noted: å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬åœ¨UIå±‚éœ€è¦å®ç°ä¸€äº›æ•°æ®çš„è½¬æ¢ï¼ˆKMM Compilerç”Ÿæˆçš„ç±»å’ŒSwiftçš„ç±»å‹ä¹‹é—´ï¼‰ï¼Œåœ¨Swiftä¸Šå®ç°èµ·æ¥æ¯”è¾ƒéº»çƒ¦ã€‚<br>ä½†æ˜¯æˆ‘ä»¬çŸ¥é“Kotlinä¸­æœ‰Nativeå’ŒObject-Cå·²ç»å¸®æˆ‘ä»¬å®ç°äº†å¾ˆå¤šæ•°æ®çš„å¯¹åº”å’Œæ–¹æ³•ï¼Œæ‰€ä»¥å¯ä»¥å°†è¿™äº›è½¬æ¢æ”¾åˆ°iOSMainä¸­å®ç°ã€‚æ¯”å¦‚ByteArrayå’ŒUIImage</p>
</blockquote>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">val</span> <span class="token keyword">data</span> <span class="token operator">=</span> bytes<span class="token punctuation">.</span><span class="token function">usePinned</span> <span class="token punctuation">&#123;</span>
    NSData<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>
    bytes <span class="token operator">=</span> it<span class="token punctuation">.</span><span class="token function">addressOf</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    length <span class="token operator">=</span> bytes<span class="token punctuation">.</span>size<span class="token punctuation">.</span><span class="token function">toULong</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">return</span> <span class="token function">UIImage</span><span class="token punctuation">(</span><span class="token keyword">data</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h3><h4 id="sqldelight-ä¸Šçš„å‘"><a href="#sqldelight-ä¸Šçš„å‘" class="headerlink" title="sqldelight ä¸Šçš„å‘"></a>sqldelight ä¸Šçš„å‘</h4><p>&emsp;è™½ç„¶ä¾èµ–åº“ä¸­çš„gradle å·²ç»åœ¨lineroptsä¸­åŠ ä¸Šäº†<code>-lsqlite3</code>ï¼Œä½†æ˜¯æœ‰æ—¶å€™åœ¨è¿è¡ŒiOSå¹³å°é¡¹ç›®è¿˜æ˜¯ä¼šå‡ºç°æ‰¾ä¸åˆ°çš„é—®é¢˜ã€‚<br>ä½¿ç”¨XCodeæ‰“å¼€iOSé¡¹ç›®ï¼Œåœ¨Build Settingsä¸­çš„Other linker flagsä¸ŠåŠ ä¸Šå°±å¥½äº†</p>
<h4 id="Koin"><a href="#Koin" class="headerlink" title="Koin"></a>Koin</h4><p>&emsp;å¯¹äºKMMé¡¹ç›®ï¼Œæˆ‘ä¸ªäººè§‰å¾—Koinæ˜¯ç›®å‰æœ€èˆ’æœçš„ä¸€ä¸ªä¾èµ–æ³¨å…¥æ–¹å¼ï¼Œå…¶ä¹Ÿåªæ˜¯ä½œç”¨äºsharedä¸­çš„Kotlinä»£ç ï¼ŒSwiftè¿˜æ˜¯éœ€è¦é€šè¿‡è°ƒç”¨initå®ä¾‹åŒ–æ“ä½œã€‚æ‰€ä»¥ä¸ºäº†é˜²æ­¢ä¾èµ–æ³¨å…¥çš„helperç±»éšç€é¡¹ç›®æ‰©å¤§è€Œmappingæ–¹æ³•ä¹Ÿå¢åŠ åˆ°å¯æ€•çš„æ•°é‡ï¼Œå»ºè®®ä¸€å¼€å§‹å°±ç®¡ç†åˆ†ç±»ã€‚</p>
<h4 id="Flowå’Œåç¨‹"><a href="#Flowå’Œåç¨‹" class="headerlink" title="Flowå’Œåç¨‹"></a>Flowå’Œåç¨‹</h4><p>&emsp;Swiftçš„é—­åŒ…å¾ˆå¥½ç”¨ï¼Œå¯¹äºsuspendæ–¹æ³•éƒ½æœ‰ä¸€ä¸ª<code>completionHandler</code>çš„é—­åŒ…å›è°ƒï¼Œå¯¹äºFlowå½“ç„¶ä¹Ÿå¯ä»¥ä½¿ç”¨é—­åŒ…åœ¨ç›¸å…³çš„æ—¶å€™è¿›è¡Œå›è°ƒã€‚<br>æ¯”å¦‚:</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token comment">// onEach(it) onThrow(it) onComplete()æ˜¯é—­åŒ…å‚æ•°</span>
flow<span class="token punctuation">.</span><span class="token function">onEach</span> <span class="token punctuation">&#123;</span> <span class="token function">onEach</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token function">catch</span> <span class="token punctuation">&#123;</span> <span class="token function">onThrow</span><span class="token punctuation">(</span>it<span class="token punctuation">)</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">.</span><span class="token function">onCompletion</span> <span class="token punctuation">&#123;</span> <span class="token function">onComplete</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>Noteï¼šéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¦æ¸…æ¥šè¿™ä¸ªå›è°ƒåœ¨å“ªä¸ªçº¿ç¨‹ä¸­ï¼Œå¦‚æœä½ éœ€è¦åœ¨å›è°ƒæ–¹æ³•åå®ç°dismisså½“å‰ç•Œé¢æˆ–è€…å…¶ä»–UIæ“ä½œï¼Œè€Œåç¨‹åˆæ˜¯åœ¨IOçº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¹¶æ²¡æœ‰åˆ‡æ¢ä¼šä¸»çº¿ç¨‹å†è°ƒç”¨å›è°ƒï¼Œè¿™æ—¶å€™å›è°ƒåŒæ ·æ˜¯åœ¨IOçº¿ç¨‹ï¼Œè€ŒIOçº¿ç¨‹ä¸­çš„UIæ“ä½œæ˜¯æ— æ•ˆæœçš„ï¼ˆdismissä¸ä¼šæœ‰æ•ˆæœï¼‰éœ€è¦ä½¿ç”¨DispatchQueue.mainåˆ‡åˆ°ä¸»çº¿ç¨‹ä¸­<br><span style="color:red">é‚£ä¹ˆæˆ‘ä»¬æ˜¯åº”è¯¥æ³¨æ„åœ¨kotlinä»£ç ä¸Šä¸»åŠ¨åˆ‡å›ä¸»çº¿ç¨‹å†è¿›è¡Œå›è°ƒè¿˜æ˜¯è®©å…¶åœ¨Swiftä¸Šæ¥è€ƒè™‘å‘¢ï¼Ÿ</span></p>
</blockquote>
<p><a href="https://github.com/BreakZero/TODO-LIST-KMM">TODO-LIST-KMM</a></p>
]]></content>
      <categories>
        <category>Kotlin Multiplatform</category>
      </categories>
      <tags>
        <tag>SwiftUI</tag>
        <tag>Kotlin</tag>
      </tags>
  </entry>
  <entry>
    <title>iOS è¯»å–å­˜å‚¨åœ¨Containerçš„æ–‡ä»¶é—®é¢˜</title>
    <url>/2023/08/13/iOS-read-local-file-issue/</url>
    <content><![CDATA[<h3 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h3><p>åœ¨ä½¿ç”¨KMMå®ç°iOSå¹³å°æ–‡ä»¶å­˜å‚¨æ—¶ï¼Œé€šè¿‡åˆ°å¤„containeræ–‡ä»¶å¯ä»¥æŸ¥çœ‹åˆ°æ–‡ä»¶ç¡®å®å­˜åœ¨ç›®å½•ä¸‹ï¼Œä½†æ˜¯åœ¨è°ƒç”¨<code>NSData.dataWithContentsOfFile</code>æ—¶æ€»æ˜¯è¿”å›ç©ºï¼Œæ ¹æ®é”™è¯¯ä¿¡æ¯å¾—çŸ¥æ‰¾ä¸åˆ°è¯¥æ–‡ä»¶æˆ–ç›®å½•<code>No such File or Directory</code>ã€‚å…¶ä¸­ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-kotlin" data-language="kotlin"><code class="language-kotlin"><span class="token keyword">val</span> errorPtr<span class="token operator">:</span> ObjCObjectVar<span class="token operator">&lt;</span>NSError<span class="token operator">?</span><span class="token operator">></span> <span class="token operator">=</span> <span class="token function">alloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
NSData<span class="token punctuation">.</span><span class="token function">dataWithContentsOfFile</span><span class="token punctuation">(</span>fullPath<span class="token punctuation">,</span> options <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> error <span class="token operator">=</span> errorPtr<span class="token punctuation">.</span>ptr<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">.</span><span class="token function">let</span> <span class="token punctuation">&#123;</span> bytes <span class="token operator">-></span>
    <span class="token keyword">val</span> array <span class="token operator">=</span> <span class="token function">ByteArray</span><span class="token punctuation">(</span>bytes<span class="token punctuation">.</span>length<span class="token punctuation">.</span><span class="token function">toInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    bytes<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span>array<span class="token punctuation">.</span><span class="token function">refTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPointer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bytes<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
    <span class="token keyword">return</span><span class="token label symbol">@withContext</span> array
<span class="token punctuation">&#125;</span>
<span class="token function">println</span><span class="token punctuation">(</span>errorPtr<span class="token punctuation">.</span>value<span class="token operator">?</span><span class="token punctuation">.</span>description<span class="token punctuation">.</span><span class="token function">orEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">return</span><span class="token label symbol">@withContext</span> <span class="token keyword">null</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>errorPtræ˜¯ä¸ºäº†æŸ¥çœ‹å…·ä½“é”™è¯¯ï¼Œæ‰€ä»¥åŠ ä¸Šè¿™ä¸ªä¸ºäº†æ›´å¥½å®šä½é—®é¢˜</p>
<span id="more"></span>

<h3 id="é—®é¢˜å®šä½"><a href="#é—®é¢˜å®šä½" class="headerlink" title="é—®é¢˜å®šä½"></a>é—®é¢˜å®šä½</h3><ol>
<li>é€šè¿‡ä¸Šé¢çš„erroræ—¥å¿—ä¸­å¾—çŸ¥ï¼Œå¤§æ¦‚ç‡æ˜¯å› ä¸ºfullPathè¿™ä¸ªç›®å½•æ˜¯ä¸€ä¸ªé”™è¯¯çš„ç›®å½•äº†ï¼Œè€Œæˆ‘åˆä»deviceä¸­å¯¼å‡ºäº†<code>xxx.xcappdata</code>ï¼Œ<br>åœ¨è¿™ä¸ªç›®å½•ä¸‹ç¡®å®èƒ½æ‰¾åˆ°å¯¹åº”åå­—çš„æ–‡ä»¶ï¼Œè€Œä¸”æ–‡ä»¶æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œè¿™ä¸ªå¯ä»¥ç¡®å®šé—®é¢˜æ˜¯æ–‡ä»¶æ˜¯å­˜åœ¨çš„ï¼Œä½†æ˜¯ç›®å½•åˆä¸ä¸€è‡´</li>
<li>æ—¢ç„¶æ–‡ä»¶å­˜åœ¨ï¼Œä½†æ˜¯ç›®å½•ä¸Šå´æ‰¾ä¸åˆ°è¯¥æ–‡ä»¶ï¼Œé—®é¢˜å‡ºåœ¨å“ªå‘¢ï¼Ÿäºæ˜¯æƒ³é€šè¿‡ä»£ç æ‰“å°å‡ºfullPathå’Œç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„è·¯å¾„å¯¹æ¯”æ˜¯å¦ä¸€è‡´ï¼Œä¸Šä»£ç ï¼š<pre class="line-numbers language-swift" data-language="swift"><code class="language-swift"><span class="token keyword">let</span> fileManager <span class="token operator">=</span> <span class="token builtin">FileManager</span><span class="token punctuation">.</span><span class="token keyword">default</span>
<span class="token keyword">let</span> documentsURL <span class="token operator">=</span> fileManager<span class="token punctuation">.</span><span class="token function">urls</span><span class="token punctuation">(</span><span class="token keyword">for</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>documentDirectory<span class="token punctuation">,</span> <span class="token keyword">in</span><span class="token punctuation">:</span> <span class="token punctuation">.</span>userDomainMask<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
<span class="token keyword">do</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword">let</span> fileURLs <span class="token operator">=</span> <span class="token keyword">try</span> fileManager<span class="token punctuation">.</span><span class="token function">contentsOfDirectory</span><span class="token punctuation">(</span>at<span class="token punctuation">:</span> documentsURL<span class="token punctuation">,</span> includingPropertiesForKeys<span class="token punctuation">:</span> <span class="token constant">nil</span><span class="token punctuation">)</span>
    <span class="token function">print</span><span class="token punctuation">(</span>fileURLs<span class="token punctuation">)</span>
    <span class="token comment">// process files</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">catch</span> <span class="token punctuation">&#123;</span>
    <span class="token function">print</span><span class="token punctuation">(</span><span class="token string">"Error while enumerating files <span class="token interpolation"><span class="token delimiter variable">\(</span>documentsURL<span class="token punctuation">.</span>path<span class="token delimiter variable">)</span></span>: <span class="token interpolation"><span class="token delimiter variable">\(</span>error<span class="token punctuation">.</span>localizedDescription<span class="token delimiter variable">)</span></span>"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
è¿™ä¸€å—æ˜¯Swiftçš„ä»£ç ï¼Œç„¶åè·å–document Directoryçš„urlï¼ˆå› ä¸ºæˆ‘å­˜å‚¨æ–‡ä»¶çš„ç›®å½•å°±æ˜¯è¿™ä¸ªï¼‰ï¼Œç„¶åé€šè¿‡éå†å°†æ‰€æœ‰æ–‡ä»¶urlæ‰“å°å¹¶å¯¹æ¯”</li>
</ol>
<ul>
<li>fullPathè·¯å¾„æ˜¯è¿™æ ·çš„<blockquote>
<p>/var/mobile/Containers/Data/Application/3FC1CCE9-A788-47AB-902A-FA133FAA3D30/Documents/60F570BE-2A16-4EFB-96B3-9203C0A0ABCE.jpg</p>
</blockquote>
</li>
<li>è€Œæ–‡ä»¶urlåˆ™æ˜¯<blockquote>
<p>file:///private/var/mobile/Containers/Data/Application/C5AC5178-6887-40F4-9EE5-8D56CB830CB3/Documents/60F570BE-2A16-4EFB-96B3-9203C0A0ABCE.jpg</p>
</blockquote>
</li>
</ul>
<p>æœç„¶ï¼ŒApplicationåé¢çš„UUIDå¹¶ä¸ä¸€è‡´ï¼Œé‚£å…¨è·¯å¾„è‚¯å®šä¹Ÿæ˜¯ä¸å¯¹çš„å’¯<br>é€šè¿‡æŸ¥é˜…èµ„æ–™ï¼Œå¾—çŸ¥åœ¨<code>iOS8.0</code>ä¹‹åæ¯æ¬¡debugè¿è¡Œæˆ–è€…æ›´æ–°ï¼Œè¿™ä¸ªUUIDéƒ½ä¼šæ”¹å˜ï¼Œè€Œæˆ‘åˆä¸ºäº†æ–¹ä¾¿ï¼Œä¸€å¼€å§‹å°±å­˜å‚¨äº†å…¨è·¯å¾„ï¼Œæ‰€ä»¥æ¯æ¬¡é‡æ–°è¿è¡Œä»£ç å°±ä¼šå‡ºç°æ‰¾ä¸åˆ°è¿™ä¸ªæ–‡ä»¶ï¼Œå› ä¸ºUUIDçš„æ”¹å˜å¯¼è‡´äº†æ•´ä¸ªç›®å½•éƒ½å˜äº†ï¼Œè‡ªç„¶æ‰¾ä¸åˆ°ã€‚</p>
<h3 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h3><p>æ—¢ç„¶çŸ¥é“äº†é—®é¢˜æ‰€åœ¨ï¼Œè§£å†³é—®é¢˜å°±ç®€å•äº†</p>
<ol>
<li>éå†ç›®å½•ï¼Œé€šè¿‡fileNameè¿‡æ»¤æ‹¿åˆ°å¯¹åº”çš„æ–‡ä»¶<br>åˆšå¼€å§‹ï¼Œç”±äºå¯¹iOSè¿™è¾¹çš„apiä¹‹ç±»çš„è¿˜ä¸æ˜¯å¾ˆäº†è§£ï¼Œè§£å†³æ€è·¯ä¹Ÿå¾ˆç›´æ¥ï¼Œæ—¢ç„¶Swiftä¸Šèƒ½æ‹¿åˆ°ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„urläº†ï¼Œåœ¨kotlin nativeå±‚è‚¯å®šæœ‰å¯¹åº”çš„APIï¼Œäºæ˜¯å¼€æï¼Œä¸Šä»£ç ï¼š<pre class="line-numbers language-Kotlin" data-language="Kotlin"><code class="language-Kotlin">&#x2F;&#x2F; æ‹¿åˆ°ç›®å½•çš„url
val url &#x3D; fileManager.URLForDirectory(
    directory &#x3D; NSDocumentDirectory,
    inDomain &#x3D; NSUserDomainMask,
    appropriateForURL &#x3D; null,
    create &#x3D; false,
    error &#x3D; null
)!!
&#x2F;&#x2F; æ‹¿åˆ°ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶çš„url
val fileUrls &#x3D; fileManager.contentsOfDirectoryAtURL(url &#x3D; url, includingPropertiesForKeys &#x3D; null, options &#x3D; 0, error &#x3D; errorPtr.ptr)
&#x2F;&#x2F; é€šè¿‡å…¨è·¯å¾„æ‹¿åˆ°æ–‡ä»¶åï¼Œç„¶åé€šè¿‡æ–‡ä»¶åè¿‡æ»¤å¾—åˆ°å”¯ä¸€çš„æ–‡ä»¶url
val currentFileUrl &#x3D; fileUrls?.first &#123; it.toString().contains(fileName) &#125; as? NSURL
&#x2F;&#x2F; è¯»å–åˆ°NSDataä¸­
currentFileUrl?.let &#123;
    NSData.dataWithContentsOfURL(currentFileUrl)
    ?.let &#123; bytes -&gt;
        val array &#x3D; ByteArray(bytes.length.toInt())
        bytes.getBytes(array.refTo(0).getPointer(this), bytes.length)
        return@withContext array
    &#125;
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
å†æ¬¡è¿è¡Œï¼ŒæˆåŠŸæ‹¿åˆ°bytesï¼ˆâœŒï¸ï¼‰<br>ä½†æ˜¯è¿™æ ·å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œéšç€æ—¶é—´ï¼Œè¿™ä¸ªç›®å½•çš„æ–‡ä»¶è‚¯å®šä¼šè¶Šæ¥è¶Šå¤šï¼Œåˆ°æ—¶å€™éå†è‚¯å®šæ˜¯ä¸€ä¸ªè€—æ—¶ä»»åŠ¡ã€‚é‚£æœ‰æ²¡æœ‰å¯ä»¥ç›´æ¥é€šè¿‡filenameæ‹¿åˆ°å¯¹åº”æ–‡ä»¶çš„urlå‘¢ï¼Ÿ<br>çœ‹äº†ä¸‹ä»£ç ï¼Œæ—¢ç„¶èƒ½æ‹¿åˆ°documentç›®å½•çš„urlï¼Œé‚£æ˜¯ä¸æ˜¯ä¹Ÿæœ‰APIå¯ä»¥ç›´æ¥æ‹¿åˆ°æ–‡ä»¶çš„urlï¼Ÿä¸€å¼€å§‹æƒ³é€šè¿‡url + filenameç»„è£…ä¸€ä¸‹<br>ä»–ä»¬ç±»å‹ä¸ä¸€è‡´ï¼Œç›¸å¯¹éº»çƒ¦ï¼Œè¿˜å¥½æ‰¾åˆ°äº†ï¼Œä»£ç ï¼š<pre class="line-numbers language-Kotlin" data-language="Kotlin"><code class="language-Kotlin">val documentDirectory &#x3D; NSSearchPathForDirectoriesInDomains(
    directory &#x3D; NSDocumentDirectory,
    domainMask &#x3D; NSUserDomainMask,
    expandTilde &#x3D; true
).first() as NSString
val fullPath &#x3D; documentDirectory.stringByAppendingPathComponent(fileName)
println(fullPath)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
è·¯å¾„æ­£ç¡®ï¼Œç›´æ¥è°ƒç”¨<code>NSData.dataWithContentsOfFile</code>ä¼ å…¥æ–‡ä»¶è·¯å¾„å³å¯</li>
</ol>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åœ¨ iOS8.0 ä¹‹åï¼Œç”±äºApplicationï¼ˆBundle identifierï¼‰çš„UUIDä¼šéšæœºæ”¹å˜ï¼Œæ‰€ä»¥ä¸èƒ½ç›´æ¥å­˜å…¨è·¯å¾„ï¼Œå¯ä»¥ç›´æ¥å­˜åå­—<br>è€Œå¯ä»¥é€šè¿‡<code>NSSearchPathForDirectoriesInDomains</code>æ‹¿åˆ°å¯¹åº”çš„è·¯å¾„ï¼Œå†åŠ ä¸Šæ–‡ä»¶åå¾—åˆ°å½“å‰æ–‡ä»¶å‡†ç¡®çš„å…¨è·¯å¾„ï¼Œè¿™æ—¶å€™è¯»å–å³å¯ã€‚</p>
]]></content>
      <categories>
        <category>Kotlin Multiplatform</category>
      </categories>
      <tags>
        <tag>SwiftUI</tag>
        <tag>Kotlin</tag>
      </tags>
  </entry>
</search>
